<section id="view-overview" class="view-section active">
    <h1 id="user-greeting">HALLO</h1>
    
    <div id="activeTradesCard" class="card">
        <h4>OFFENE POSITIONEN</h4>
        <div id="activeTradesList"></div>
    </div>

    <div class="card">
        <h4>PERFORMANCE CHART</h4>
        <div class="chart-controls" style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <label style="font-size: 0.8rem; color: #888;">Start:</label>
                <input type="date" id="chartStartDate" onchange="updateChart()" style="width: auto; padding: 5px;">
            </div>
            <button class="chart-btn active" onclick="setChartFilter('all', this)">Alle</button>
        </div>
        <div style="height: 300px;"><canvas id="ovChart"></canvas></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
            <div style="font-size:0.85rem; color:#888; letter-spacing:1px;">GESAMT PROFIT</div>
            <div id="ovTotal" style="font-size:2rem; font-weight:800;">0.00 ‚Ç¨</div>
        </div>
        <div class="card">
            <div style="font-size:0.85rem; color:#888; letter-spacing:1px;">WIN RATE</div>
            <div id="ovWinRate" style="font-size:2rem; font-weight:800;">0%</div>
        </div>
    </div>
</section>

<section id="view-entry" class="view-section">
    <div class="card">
        <h4 id="entry-title">TRADE DATEN ERFASSEN</h4>
        <input type="hidden" id="editId">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <input type="datetime-local" id="datetime">
            <select id="assetDropdown"></select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top:15px;">
            <select id="status" onchange="toggleOutcomeFields()">
                <option value="Aktiv">Offen</option>
                <option value="Geschlossen">Geschlossen</option>
            </select>
            <select id="mindset">
                <option value="Neutral">üòê Neutral</option>
                <option value="Sicher">üòä Sicher</option>
                <option value="Angst">üò® Angst</option>
                <option value="Wut">üò° Wut</option>
            </select>
        </div>
        
        <div style="margin-top:15px;">
            <label style="font-size: 0.8rem; color:#888;">Trade Setup (URL)</label>
            <input type="url" id="imgSetup" placeholder="https://tradingview.com/x/...">
        </div>

        <div id="pnlWrapper" class="hidden" style="margin-top:15px;">
            <input type="number" id="pnl" step="0.01" placeholder="Gewinn / Verlust in ‚Ç¨">
            <div style="margin-top:15px;">
                <label style="font-size: 0.8rem; color:#888;">Trade Ergebnis (URL)</label>
                <input type="url" id="imgResult" placeholder="https://tradingview.com/x/...">
            </div>
        </div>

        <textarea id="note" placeholder="Deine Notizen..." rows="5" style="margin-top:15px;"></textarea>
        <button onclick="saveTrade()" class="btn-primary" style="margin-top:20px;">Trade speichern</button>
        <button id="cancelEdit" class="hidden" onclick="resetEntryForm()" style="background:none; border:none; color:#888; margin-top:10px; width:100%; cursor:pointer;">Abbrechen</button>
    </div>
</section>

<section id="view-history" class="view-section">
    <div class="card" style="padding:0; overflow-x:auto;">
        <div style="padding: 25px 25px 0 25px;"><h4>KOMPLETTE HISTORIE</h4></div>
        <table>
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Asset</th>
                    <th>Status</th>
                    <th>Charts</th>
                    <th>Notiz</th>
                    <th>P&L</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody id="tradeBody"></tbody>
        </table>
    </div>
</section>

<script>
    // Bestehende Firebase Config beibehalten...

    // Hilfsfunktion f√ºr aktuelles Datum im richtigen Format f√ºr input type="datetime-local"
    function getNowString() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    }

    function toggleOutcomeFields() {
        const status = document.getElementById('status').value;
        document.getElementById('pnlWrapper').classList.toggle('hidden', status !== 'Geschlossen');
    }

    function showView(v) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.getElementById('navDrawer').classList.remove('open');
        document.getElementById('view-title').innerText = v.toUpperCase();
        
        if(v === 'entry' && !document.getElementById('editId').value) {
            resetEntryForm();
        }
    }

    function resetEntryForm() {
        document.getElementById('editId').value = '';
        document.getElementById('entry-title').innerText = 'TRADE DATEN ERFASSEN';
        document.getElementById('datetime').value = getNowString();
        document.getElementById('assetDropdown').selectedIndex = 0;
        document.getElementById('status').value = 'Aktiv';
        document.getElementById('mindset').value = 'Neutral';
        document.getElementById('pnl').value = '';
        document.getElementById('imgSetup').value = '';
        document.getElementById('imgResult').value = '';
        document.getElementById('note').value = '';
        document.getElementById('cancelEdit').classList.add('hidden');
        toggleOutcomeFields();
    }

    async function saveTrade() {
        const id = document.getElementById('editId').value;
        const t = {
            date: document.getElementById('datetime').value,
            asset: document.getElementById('assetDropdown').value,
            status: document.getElementById('status').value,
            mindset: document.getElementById('mindset').value,
            pnl: parseFloat(document.getElementById('pnl').value) || 0,
            imgSetup: document.getElementById('imgSetup').value,
            imgResult: document.getElementById('imgResult').value,
            note: document.getElementById('note').value,
            userId: auth.currentUser.uid
        };

        if(id) {
            await db.collection('trades').doc(id).update(t);
        } else {
            await db.collection('trades').add(t);
        }
        
        resetEntryForm();
        loadTrades(); 
        showView('overview');
    }

    function editTrade(id) {
        const t = trades.find(item => item.id === id);
        if(!t) return;

        document.getElementById('editId').value = t.id;
        document.getElementById('entry-title').innerText = 'TRADE BEARBEITEN';
        document.getElementById('datetime').value = t.date;
        document.getElementById('assetDropdown').value = t.asset;
        document.getElementById('status').value = t.status;
        document.getElementById('mindset').value = t.mindset;
        document.getElementById('pnl').value = t.pnl;
        document.getElementById('imgSetup').value = t.imgSetup || '';
        document.getElementById('imgResult').value = t.imgResult || '';
        document.getElementById('note').value = t.note || '';
        
        document.getElementById('cancelEdit').classList.remove('hidden');
        toggleOutcomeFields();
        showView('entry');
    }

    async function deleteTrade(id) {
        if(confirm("Trade wirklich l√∂schen?")) {
            await db.collection('trades').doc(id).delete();
            loadTrades();
        }
    }

    function renderUI() {
        let totalPnl = 0, wins = 0, closedCount = 0;
        const body = document.getElementById('tradeBody');
        const activeList = document.getElementById('activeTradesList');
        body.innerHTML = '';
        activeList.innerHTML = '';

        const sortedTrades = trades.sort((a,b) => new Date(b.date) - new Date(a.date));

        sortedTrades.forEach(t => {
            const isClosed = t.status === 'Geschlossen';
            
            // Statistik
            if(isClosed) {
                totalPnl += t.pnl;
                closedCount++;
                if(t.pnl > 0) wins++;
            } else {
                // In √úbersicht f√ºr offene Trades anzeigen
                activeList.innerHTML += `
                    <div class="active-trade-item">
                        <span><b>${t.asset}</b> (${t.date.split('T')[0]})</span>
                        <button onclick="editTrade('${t.id}')" style="background:var(--accent); border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Schlie√üen / Edit</button>
                    </div>`;
            }

            // Historie Tabelle
            const setupLink = t.imgSetup ? `<a href="${t.imgSetup}" target="_blank" title="Setup">üñºÔ∏è</a>` : '';
            const resultLink = t.imgResult ? `<a href="${t.imgResult}" target="_blank" title="Ergebnis">üèÅ</a>` : '';
            
            body.innerHTML += `
                <tr>
                    <td>${t.date.replace('T', ' ')}</td>
                    <td><b>${t.asset}</b></td>
                    <td><span style="color: ${isClosed ? '#888' : 'var(--accent)'}">${t.status}</span></td>
                    <td>${setupLink} ${resultLink}</td>
                    <td style="font-size:0.8rem; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.note || '-'}</td>
                    <td style="font-weight:bold; color: ${t.pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${isClosed ? t.pnl.toFixed(2) + '‚Ç¨' : '-'}</td>
                    <td>
                        <button onclick="editTrade('${t.id}')" style="background:none; border:none; color:var(--accent); cursor:pointer; margin-right:10px;">‚úé</button>
                        <button onclick="deleteTrade('${t.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;">‚úò</button>
                    </td>
                </tr>`;
        });

        // Profit Anzeige einf√§rben
        const totalEl = document.getElementById('ovTotal');
        totalEl.innerText = totalPnl.toFixed(2) + " ‚Ç¨";
        totalEl.style.color = totalPnl >= 0 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('ovWinRate').innerText = closedCount > 0 ? (wins/closedCount*100).toFixed(1) + "%" : "0%";
        
        document.getElementById('activeTradesCard').classList.toggle('hidden', activeList.innerHTML === '');
        
        updateChart();
    }

    function updateChart() {
        const ctx = document.getElementById('ovChart').getContext('2d');
        const startDate = document.getElementById('chartStartDate').value;
        
        let filtered = trades
            .filter(t => t.status === 'Geschlossen')
            .sort((a,b) => new Date(a.date) - new Date(b.date));

        if(startDate) {
            filtered = filtered.filter(t => new Date(t.date) >= new Date(startDate));
        }

        let sum = 0;
        const points = filtered.map(t => {
            sum += t.pnl;
            return sum;
        });

        if(ovChart) ovChart.destroy();
        ovChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: filtered.map(t => t.date.split('T')[0]),
                datasets: [{
                    data: points,
                    borderColor: '#bb86fc',
                    tension: 0.2,
                    fill: true,
                    backgroundColor: 'rgba(187,134,252,0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#222' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // Beim Laden: Datum setzen
    document.getElementById('datetime').value = getNowString();
</script>
