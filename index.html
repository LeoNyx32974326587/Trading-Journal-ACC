<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>TradeCloud Pro</title>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
:root{--bg-dark:#0a0e1a;--card-bg:rgba(18,22,36,.85);--cell-bg:rgba(25,30,50,.8);--text-main:#e0e4f0;--text-sub:#7a8194;--accent:#bb86fc;--accent2:#6c63ff;--success:#00e676;--danger:#ff5252;--border:rgba(255,255,255,.08);--blur:0px;--popup-bg:rgba(15,18,30,.95);--wa-bg:#0a0e1a;--wa-header:rgba(18,22,36,.9);--wa-bubble-in:rgba(30,35,55,.9);--wa-bubble-out:rgba(90,60,200,.35);--wa-input-bg:rgba(25,30,50,.8);--wa-tick:#53bdeb;--glow:0 0 20px rgba(187,134,252,.15);--gradient:linear-gradient(135deg,#6c63ff,#bb86fc,#e040fb)}
body.light-mode{--bg-dark:#f0f2f5;--card-bg:#fff;--cell-bg:#e8eaf0;--text-main:#1c1e21;--text-sub:#65676b;--accent:#6200ee;--accent2:#3700b3;--success:#00c853;--danger:#d50000;--border:rgba(0,0,0,.1);--popup-bg:#fff;--wa-bg:#f0f2f5;--wa-header:#fff;--wa-bubble-in:#fff;--wa-bubble-out:rgba(98,0,238,.1);--wa-input-bg:#e8eaf0;--glow:none;--gradient:linear-gradient(135deg,#6200ee,#9c27b0)}
body.neon-mode{--bg-dark:#050510;--card-bg:rgba(10,12,25,.9);--cell-bg:rgba(15,18,35,.85);--text-main:#e0f0ff;--text-sub:#5588aa;--accent:#00f0ff;--accent2:#ff00e5;--success:#00ff88;--danger:#ff2255;--border:rgba(0,240,255,.12);--popup-bg:rgba(8,10,20,.95);--wa-bg:#050510;--wa-header:rgba(10,12,25,.9);--wa-bubble-in:rgba(15,25,40,.9);--wa-bubble-out:rgba(0,200,255,.15);--wa-input-bg:rgba(15,18,35,.85);--glow:0 0 25px rgba(0,240,255,.2);--gradient:linear-gradient(135deg,#00f0ff,#ff00e5)}
body.black-mode{--bg-dark:#000;--card-bg:rgba(10,10,10,.97);--cell-bg:rgba(18,18,18,.95);--text-main:#f0f0f0;--text-sub:#555;--accent:#e0e0e0;--accent2:#999;--success:#00e676;--danger:#ff5252;--border:rgba(255,255,255,.07);--popup-bg:rgba(6,6,6,.99);--wa-bg:#000;--wa-header:rgba(10,10,10,.98);--wa-bubble-in:rgba(20,20,20,.97);--wa-bubble-out:rgba(50,50,50,.6);--wa-input-bg:rgba(14,14,14,.95);--wa-tick:#aaa;--glow:0 0 12px rgba(255,255,255,.04);--gradient:linear-gradient(135deg,#555,#bbb,#fff)}
body.grey-mode{--bg-dark:#1c1c1e;--card-bg:rgba(40,40,42,.92);--cell-bg:rgba(55,55,58,.88);--text-main:#e5e5e7;--text-sub:#8e8e93;--accent:#aeaeb2;--accent2:#636366;--success:#34c759;--danger:#ff3b30;--border:rgba(255,255,255,.1);--popup-bg:rgba(35,35,37,.97);--wa-bg:#1c1c1e;--wa-header:rgba(40,40,42,.96);--wa-bubble-in:rgba(52,52,55,.93);--wa-bubble-out:rgba(95,95,100,.5);--wa-input-bg:rgba(45,45,48,.88);--wa-tick:#adadb8;--glow:0 0 18px rgba(174,174,178,.07);--gradient:linear-gradient(135deg,#636366,#aeaeb2,#e5e5e7)}
body.scifi-mode{--bg-dark:#000a00;--card-bg:rgba(0,16,0,.92);--cell-bg:rgba(0,24,0,.88);--text-main:#00ff41;--text-sub:#006b17;--accent:#00ff41;--accent2:#00cc33;--success:#00ff41;--danger:#ff0040;--border:rgba(0,255,65,.13);--popup-bg:rgba(0,10,0,.97);--wa-bg:#000a00;--wa-header:rgba(0,16,0,.96);--wa-bubble-in:rgba(0,28,0,.93);--wa-bubble-out:rgba(0,90,0,.38);--wa-input-bg:rgba(0,20,0,.88);--wa-tick:#00cc33;--glow:0 0 18px rgba(0,255,65,.14);--gradient:linear-gradient(135deg,#00cc33,#00ff41,#66ff77)}
body{font-family:Inter,system-ui,sans-serif;background:var(--bg-dark);margin:0;color:var(--text-main);padding-bottom:80px;overflow-x:hidden;-webkit-tap-highlight-color:transparent}
body::before{content:"";position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at 20% 0%,rgba(108,99,255,.12) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(187,134,252,.08) 0%,transparent 50%);pointer-events:none;z-index:-1}
body.light-mode::before{background:none}
body.neon-mode::before{background:radial-gradient(ellipse at 20% 0%,rgba(0,240,255,.1) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(255,0,229,.08) 0%,transparent 50%)}
body.black-mode::before{background:none}
body.grey-mode::before{background:radial-gradient(ellipse at 30% 0%,rgba(174,174,178,.05) 0%,transparent 55%),radial-gradient(ellipse at 70% 100%,rgba(99,99,102,.04) 0%,transparent 50%)}
body.scifi-mode::before{background:radial-gradient(ellipse at 50% 0%,rgba(0,255,65,.07) 0%,transparent 60%),radial-gradient(ellipse at 50% 100%,rgba(0,200,50,.05) 0%,transparent 50%)}
.hidden{display:none!important}.view-section{display:none;animation:fadeIn .3s}.view-section.active{display:block}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
header{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;padding-top:calc(15px + env(safe-area-inset-top));background:var(--card-bg);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.menu-btn{cursor:pointer;font-size:2rem;color:var(--text-main);background:none;border:none;padding:0;margin-right:15px}
#view-title{font-weight:700;font-size:1.2rem}
.sensitive{filter:blur(var(--blur));transition:filter .3s}
.switch{position:relative;display:inline-block;width:50px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:16px;width:16px;left:4px;bottom:4px;background:#fff;transition:.4s;border-radius:50%}
input:checked+.slider{background:var(--gradient)}
input:checked+.slider:before{transform:translateX(26px)}
#menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199;display:none;backdrop-filter:blur(2px)}
#menu-overlay.open{display:block}
.nav-drawer{position:fixed;top:0;left:-280px;width:280px;height:100%;background:var(--card-bg);backdrop-filter:blur(20px);border-right:1px solid var(--border);transition:.3s;z-index:200;padding-top:10px;padding-bottom:50px;box-shadow:2px 0 20px rgba(0,0,0,.5);overflow-y:auto;display:flex;flex-direction:column}
.nav-drawer.open{left:0}
.nav-drawer button{display:block;width:100%;padding:15px 25px;text-align:left;background:none;border:none;color:var(--text-main);cursor:pointer;font-size:1.1rem;transition:.2s;border-bottom:1px solid rgba(255,255,255,.03);position:relative}
.nav-drawer button:hover{background:rgba(255,255,255,.05)}
.nav-active{border-left:4px solid var(--accent)!important;background:linear-gradient(90deg,rgba(187,134,252,.12),transparent)!important;color:var(--accent)!important;font-weight:700}
.nav-separator{height:1px;background:rgba(255,255,255,.1);margin:15px 20px;display:block}
.nav-selector-container{padding:15px 25px}
.nav-selector-label{font-size:.8rem;color:var(--text-sub);margin-bottom:5px;display:block;font-weight:700;letter-spacing:1px}
#navJournalSelect{width:100%;padding:12px;background:var(--bg-dark);border:1px solid var(--border);color:var(--text-main);border-radius:6px;cursor:pointer;font-size:1rem}
.nav-lock{font-size:.85rem;opacity:.7;margin-left:4px}
.container{max-width:1200px;margin:0 auto;padding:15px}
.card{background:var(--card-bg);backdrop-filter:blur(10px);padding:15px;border-radius:14px;border:1px solid var(--border);margin-bottom:15px;box-shadow:var(--glow)}
#user-greeting-name{color:var(--accent)}
#dashboard-notification-area{margin-bottom:20px;display:flex;flex-direction:column;gap:12px}
.feedback-notification{background:linear-gradient(135deg,rgba(187,134,252,.2),rgba(187,134,252,.05));border:1px solid var(--accent);border-radius:12px;padding:15px;display:flex;flex-direction:column;animation:fadeIn .5s}
.chat-notification{background:rgba(10,132,255,.2);border:1px solid #0a84ff;color:#fff;padding:15px;border-radius:12px;cursor:pointer;animation:fadeIn .5s;display:flex;align-items:center;justify-content:space-between;font-weight:700}
.journal-full-card{background:var(--card-bg);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:14px;margin-bottom:30px;overflow:hidden;animation:fadeIn .4s;display:flex;flex-direction:column;box-shadow:var(--glow)}
.jfc-header{padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.jfc-title{font-size:1.3rem;font-weight:800}
.jfc-body-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;padding:20px}
.jfc-chart-area{position:relative;height:300px;background:rgba(255,255,255,.01);border-radius:8px;border:1px solid var(--border);padding:10px}
.jfc-sidebar{display:flex;flex-direction:column;gap:15px}
.jfc-stats-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-box{background:var(--cell-bg);border:1px solid var(--border);border-radius:12px;padding:15px 10px;text-align:center;display:flex;flex-direction:column;justify-content:center;backdrop-filter:blur(5px)}
.stat-label{font-size:.8rem;color:var(--text-sub);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}
.stat-value{font-size:1.1rem;font-weight:800}
.open-trades-box{background:var(--cell-bg);border:1px solid var(--border);border-radius:12px;flex-grow:1;padding:15px;display:flex;flex-direction:column;min-height:120px;backdrop-filter:blur(5px)}
.ot-list-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:.9rem}
.loss-warning{background:rgba(255,61,0,.15);border-left:4px solid var(--danger);color:var(--danger);padding:10px 15px;font-size:.9rem;font-weight:700;margin:0 20px 10px;display:flex;align-items:center;gap:10px;border-radius:4px}
.ot-thumb{width:30px;height:20px;object-fit:cover;border-radius:3px;border:1px solid var(--border);margin-left:8px;vertical-align:middle}
.card-filters{display:flex;gap:5px;padding:10px 20px;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.filter-pill{padding:6px 14px;border-radius:20px;font-size:.75rem;font-weight:700;cursor:pointer;color:var(--text-sub);border:1px solid var(--border);background:var(--cell-bg);transition:.2s;white-space:nowrap;text-transform:uppercase}
.filter-pill.active{background:var(--gradient);color:#fff;border-color:transparent;box-shadow:0 0 12px rgba(187,134,252,.3)}
@media(max-width:768px){.jfc-body-grid{grid-template-columns:1fr}.jfc-chart-area{height:220px}}
#popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:999;display:none;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity .3s}
#popup-overlay.open{display:flex;opacity:1}
#popup-overlay-2{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:1100;display:none;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity .3s}
#popup-overlay-2.open{display:flex;opacity:1}
.modal-base{width:95%;max-width:500px;background:var(--popup-bg);backdrop-filter:blur(20px);color:var(--text-main);border-radius:18px;border:1px solid var(--border);box-shadow:0 10px 50px rgba(0,0,0,.6),var(--glow);padding:20px;box-sizing:border-box;max-height:90vh;overflow-y:auto;position:relative}
.modal-base::before{content:"";display:none;width:36px;height:4px;background:rgba(255,255,255,.25);border-radius:2px;margin:0 auto 12px}
@media(max-width:768px){.modal-base::before{display:block}}
#day-detail-view,#trade-detail-view,#trade-form-modal,#add-contact-modal,#admin-member-modal,#journal-form-modal,#navguard-modal,#notif-modal,#profile-modal,#upgrade-req-modal,#course-modal,#module-modal,#quiz-edit-modal,#quiz-play-modal,#video-player-modal,#create-group-modal,#module-detail-modal,#invite-group-modal{background:var(--popup-bg)!important;color:var(--text-main)!important;border:1px solid var(--border);z-index:1000}
.modal-layer2{z-index:1200!important}
.profile-card{background:linear-gradient(135deg,rgba(187,134,252,.15),rgba(187,134,252,.02));border:1px solid rgba(187,134,252,.3);border-radius:16px;padding:25px;text-align:center;margin-bottom:20px}
.profile-avatar{width:80px;height:80px;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:800;margin:0 auto 15px}
.profile-field-row{display:flex;flex-direction:column;gap:4px;margin-bottom:15px;text-align:left}
.profile-field-row label{font-size:.75rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px}
.profile-field-row input{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 15px;color:#fff;font-size:.95rem}
.mute-btn{background:none;border:none;cursor:pointer;font-size:1rem;color:var(--text-sub);padding:5px;margin-left:auto}
.mute-btn.muted{color:var(--danger)}
.asset-dropdown-wrap{position:relative}
.asset-dropdown{position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;z-index:50;display:none;box-shadow:0 4px 15px rgba(0,0,0,.5)}
.asset-dropdown.open{display:block}
.asset-dropdown-item{padding:10px 14px;cursor:pointer;font-size:.9rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.asset-dropdown-item:hover{background:rgba(187,134,252,.1)}
.asset-dropdown-item:last-child{border-bottom:none}
.asset-dd-cat{font-size:.65rem;color:var(--text-sub);text-transform:uppercase;font-weight:700}
.upload-area{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:12px}
.upload-area:hover{border-color:var(--accent);background:rgba(187,134,252,.05)}
.upload-area.uploading{opacity:.6;pointer-events:none}
.upload-progress{height:4px;background:#333;border-radius:2px;overflow:hidden;margin-top:8px}
.upload-progress-bar{height:100%;background:var(--accent);transition:width .3s;width:0}
.quiz-q-card{background:#151517;border:1px solid #333;border-radius:8px;padding:12px;margin-bottom:10px}
.quiz-q-card label{color:var(--text-sub);font-size:.8rem;font-weight:700;display:block;margin-bottom:4px}
.quiz-answer-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.quiz-answer-row input[type="text"]{flex:1;margin-bottom:0}
.quiz-answer-row input[type="radio"]{width:18px;height:18px;accent-color:var(--accent)}
.dv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.dv-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
.dv-stat-item{display:flex;flex-direction:column}
.dv-stat-label{color:var(--text-sub);font-size:.85rem;margin-bottom:4px}
.dv-stat-val{font-size:1.1rem;font-weight:700}
.closed-trades-title{font-size:1.1rem;font-weight:700;margin:10px 0;color:#fff!important}
.tr-icon{width:20px;font-size:.8rem}
.tr-date-col{display:flex;flex-direction:column;width:100px}
.tr-date{font-size:.85rem;font-weight:500}
.tr-time{font-size:.75rem;color:#888}
.tr-sym{flex-grow:1;font-weight:600;font-size:.9rem}
.tr-pnl{font-weight:700;font-size:.9rem;text-align:right;min-width:70px}
.trade-row{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid #2c2c2e;cursor:pointer}
.trade-row-header{border-bottom:1px solid #2c2c2e;color:#888;display:flex;padding:10px 15px;font-size:.8rem}
.trades-list-card{background:#151517;border:1px solid #2c2c2e;border-radius:12px;overflow:hidden}
.td-hero{text-align:center;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #333}
.td-asset{font-size:1.8rem;font-weight:800;color:#fff;display:block}
.td-pnl{font-size:3rem;font-weight:900;margin-top:5px;display:block}
.td-value-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.td-row{display:flex;justify-content:space-between;align-items:center;background:#151517;padding:12px 15px;border-radius:8px;border:1px solid #2c2c2e}
.td-row-label{color:#888;font-size:.85rem;font-weight:600;text-transform:uppercase}
.td-row-val-group{display:flex;align-items:center;gap:10px}
.td-row-val{color:#fff;font-family:monospace;font-size:1rem;font-weight:700}
.td-copy-btn{background:none;border:none;cursor:pointer;font-size:1.1rem;color:var(--accent);padding:5px;line-height:1}
.td-note-box{background:#151517;padding:15px;border-radius:12px;border:1px solid #2c2c2e;margin-bottom:20px;font-style:italic;color:#ccc;font-size:.9rem;line-height:1.5}
.td-img-box{margin-bottom:15px}
.td-img-label{display:block;color:var(--accent);font-weight:700;font-size:.8rem;margin-bottom:5px}
.td-img-thumb{width:100%;height:150px;object-fit:cover;border-radius:8px;border:1px solid #333;cursor:pointer;margin-top:5px}
.chat-container{display:flex;flex-direction:column;height:calc(100vh - 140px);background:var(--wa-bg);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.chat-lobby{height:100%;display:flex;flex-direction:column;background:var(--card-bg)}
.cl-header{padding:15px;border-bottom:1px solid var(--border);font-weight:700;background:var(--wa-header);display:flex;justify-content:space-between;align-items:center}
.cl-list{overflow-y:auto;flex-grow:1}
.cl-item{padding:15px;border-bottom:1px solid var(--border);display:flex;align-items:center;cursor:pointer;transition:.2s;gap:15px}
.cl-item:hover{background:rgba(255,255,255,.05)}
.cl-avatar{width:45px;height:45px;border-radius:50%;background:#333;display:flex;justify-content:center;align-items:center;font-size:1.2rem;flex-shrink:0}
.cl-info{display:flex;flex-direction:column;flex-grow:1}
.cl-name{font-weight:700;font-size:1rem;margin-bottom:4px;display:flex;align-items:center;gap:5px}
.cl-last{font-size:.8rem;color:var(--text-sub)}
.cl-actions{display:flex;gap:4px;align-items:center;flex-shrink:0;margin-left:auto}
.cl-actions button{background:none;border:1px solid var(--border);color:var(--text-sub);cursor:pointer;padding:4px 7px;border-radius:6px;font-size:.85rem;line-height:1;transition:.2s}
.cl-actions button:hover{background:rgba(255,255,255,.1);color:var(--text-main)}
.cl-actions button.pinned{color:var(--accent);border-color:var(--accent)}
.coach-tag{background:var(--accent);color:#000;padding:1px 6px;border-radius:4px;font-size:.65rem;font-weight:800;text-transform:uppercase}
.search-result-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#222;margin-bottom:5px;border-radius:6px;border:1px solid #333}
.chat-room{display:flex;flex-direction:column;height:100%;background:var(--wa-bg)}
.cr-header{padding:10px 15px;background:var(--wa-header);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.cr-back-btn{background:none;border:none;color:var(--text-main);font-size:1.2rem;cursor:pointer;padding:5px}
.cr-title{font-weight:700;font-size:1rem}
.chat-messages{flex-grow:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:8px}
.chat-input-area{padding:10px 15px;background:var(--wa-header);display:flex;gap:10px;align-items:center}
.chat-input-field{background:var(--wa-input-bg);border:none;padding:12px 15px;border-radius:20px;color:var(--text-main);width:100%;font-size:.95rem}
.chat-input-field:focus{outline:none}
.chat-send-btn{background:var(--success);color:#fff;border:none;width:40px;height:40px;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;font-size:1.2rem;flex-shrink:0}
.msg-wrapper{max-width:80%;display:flex;flex-direction:column;margin-bottom:2px}
.msg-wrapper.me{align-self:flex-end;align-items:flex-end}
.msg-wrapper.other{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:6px 9px 8px;border-radius:7.5px;font-size:.95rem;line-height:19px;position:relative;box-shadow:0 1px .5px rgba(0,0,0,.13);word-wrap:break-word;min-width:80px}
.msg-wrapper.me .msg-bubble{background:var(--wa-bubble-out);color:#fff;border-top-right-radius:0}
.msg-wrapper.other .msg-bubble{background:var(--wa-bubble-in);color:var(--text-main);border-top-left-radius:0}
.msg-sender-name{font-size:.75rem;color:var(--accent);font-weight:700;margin-bottom:4px;display:block}
.msg-meta{display:flex;justify-content:flex-end;align-items:center;gap:4px;margin-top:2px}
.msg-time{font-size:.65rem;color:rgba(255,255,255,.6)}
.msg-wrapper.other .msg-time{color:var(--text-sub)}
.msg-tick{font-size:.7rem;color:var(--wa-tick)}
.chat-trade-card{background:rgba(0,0,0,.4);border-radius:6px;padding:8px;cursor:pointer;border:1px solid rgba(255,255,255,.2);max-width:260px}
.ct-header{display:flex;justify-content:space-between;margin-bottom:8px;font-weight:700;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:5px}
.ct-img{width:100%;height:120px;object-fit:cover;border-radius:4px;margin-top:10px;pointer-events:none}
.adm-row{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--cell-bg);border-radius:8px;margin-bottom:8px;border:1px solid var(--border)}
.adm-user-info{display:flex;align-items:center;gap:10px}
.adm-pic{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.adm-text{display:flex;flex-direction:column}
.adm-name{font-weight:700;font-size:.9rem}
.adm-email{font-size:.8rem;color:var(--text-sub)}
.adm-tab-btn{flex:1;padding:15px;border:none;background:#151517;color:#888;font-weight:700;cursor:pointer;border-bottom:2px solid transparent;transition:.2s}
.adm-tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(187,134,252,.05)}
.hist-table{width:100%;border-collapse:collapse;font-size:.85rem}
.hist-table th{text-align:left;padding:15px 10px;border-bottom:1px solid var(--border);color:var(--text-sub);font-weight:600}
.hist-table td{padding:15px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
.hist-table tr:hover{background:rgba(255,255,255,.03)}
.hist-table tr:last-child td{border-bottom:none}
.time-sub{display:block;font-size:.7rem;color:var(--text-sub);margin-top:2px}
.access-denied-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;text-align:center;color:var(--text-sub)}
.feedback-item{background:var(--cell-bg);border:1px solid var(--border);border-radius:8px;padding:15px;margin-bottom:10px}
.fb-header{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-sub);margin-bottom:8px}
.fb-type{font-weight:700;color:var(--accent);text-transform:uppercase}
.fb-del{border:1px solid #333;background:none;color:#888;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:.8rem}
#auth-overlay{position:fixed;inset:0;background:rgba(5,5,15,.95);display:flex;justify-content:center;align-items:center;z-index:1000;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
#auth-overlay::before{content:"";position:absolute;width:100%;height:100%;background:radial-gradient(ellipse at 50% 30%,rgba(108,99,255,.15),transparent 60%);pointer-events:none}
.auth-container{width:90%;max-width:380px;background:var(--card-bg);backdrop-filter:blur(20px);padding:30px;border-radius:20px;border:1px solid var(--border);box-shadow:0 10px 50px rgba(0,0,0,.5),var(--glow);position:relative}
.auth-title{text-align:center;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px;margin:0 0 25px;font-size:1.8rem}
.auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;padding:12px;background:none;border:none;border-bottom:2px solid transparent;color:var(--text-sub);cursor:pointer;font-size:1rem;font-weight:600;transition:.2s}
.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.auth-form{display:none}.auth-form.active{display:block}
.auth-divider{text-align:center;margin:15px 0;color:var(--text-sub);font-size:.85rem}
.auth-error{background:rgba(255,61,0,.15);border:1px solid var(--danger);color:var(--danger);padding:10px;border-radius:8px;margin-bottom:12px;font-size:.85rem;display:none}
.upgrade-banner{background:linear-gradient(135deg,rgba(187,134,252,.25),rgba(187,134,252,.05));border:1px solid var(--accent);border-radius:12px;padding:20px;margin-bottom:20px;text-align:center}
.upgrade-banner h3{margin:0 0 8px;color:var(--accent)}
.upgrade-banner p{margin:0 0 12px;color:var(--text-sub);font-size:.9rem}
.admin-zentrale{margin-top:30px;border-top:1px solid var(--border);padding-top:20px}
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
@media(max-width:600px){.admin-grid{grid-template-columns:1fr}}
.admin-col{background:var(--cell-bg);border:1px solid var(--border);border-radius:12px;padding:15px}
.admin-col h4{margin:0 0 12px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:8px}
.user-card{background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px}
.user-card-name{font-weight:700;font-size:.85rem}
.user-card-email{font-size:.75rem;color:var(--text-sub);margin-bottom:6px}
.user-card-actions{display:flex;gap:4px;flex-wrap:wrap}
.ua-btn{padding:5px 9px;border-radius:5px;border:1px solid var(--border);background:var(--cell-bg);color:var(--text-main);cursor:pointer;font-size:.8rem;transition:.2s}
.ua-btn.upgrade{border-color:var(--success);color:var(--success)}
.ua-btn.downgrade{border-color:#f59e0b;color:#f59e0b}
.ua-btn.ban{border-color:var(--danger);color:var(--danger)}
.ua-btn.del{border-color:#666;color:#888}
.text-green{color:var(--success)!important}.text-red{color:var(--danger)!important}
input,select,textarea{background:var(--cell-bg);color:var(--text-main);border:1px solid var(--border);padding:12px;border-radius:10px;width:100%;margin-bottom:12px;box-sizing:border-box;transition:border-color .2s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 8px rgba(187,134,252,.2)}
.btn-primary{background:var(--gradient);color:#fff;padding:15px;border:none;font-weight:800;border-radius:10px;width:100%;cursor:pointer;transition:.2s;box-shadow:0 4px 15px rgba(187,134,252,.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(187,134,252,.35)}
.btn-icon,.btn-small,.chart-btn{padding:6px 10px;font-size:.85rem;border-radius:8px;border:1px solid var(--border);background:var(--cell-bg);color:var(--text-main);cursor:pointer;transition:.2s;display:inline-flex;align-items:center;justify-content:center;line-height:1}
.btn-icon:hover,.btn-small:hover{border-color:var(--accent);background:rgba(187,134,252,.1)}
.settings-list-item{display:flex;justify-content:space-between;align-items:center;background:var(--cell-bg);padding:12px 15px;border-radius:12px;margin-bottom:8px;border:1px solid var(--border);backdrop-filter:blur(5px)}
.stats-grid-view{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.chart-card{height:320px;padding:20px;position:relative;border:1px solid var(--border);border-radius:14px;background:var(--card-bg);backdrop-filter:blur(10px);box-shadow:var(--glow)}
.chart-card h4{font-size:.95rem;letter-spacing:.5px;color:var(--text-main);border-bottom:1px solid var(--border);padding-bottom:10px}
.full-width{grid-column:span 2}
@media(max-width:768px){.stats-grid-view{grid-template-columns:1fr}.full-width{grid-column:span 1}}
.cal-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-cell{background:var(--cell-bg);border-radius:8px;aspect-ratio:1/.85;position:relative;border:1px solid transparent;cursor:pointer;transition:.2s}
.cal-cell.win{background:rgba(0,200,83,.15);border:1px solid rgba(0,200,83,.3)}
.cal-cell.loss{background:rgba(255,61,0,.15);border:1px solid rgba(255,61,0,.3)}
.cal-date{position:absolute;top:2px;right:4px;font-size:.7rem;font-weight:600;color:var(--text-sub)}
.cal-pnl{position:absolute;bottom:16px;width:100%;text-align:center;font-size:.65rem;font-weight:700}
.cal-trades{position:absolute;bottom:2px;width:100%;text-align:center;font-size:.55rem;color:var(--text-sub)}
.share-opt{padding:15px;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:.2s}
.share-opt.selected{border-color:var(--accent);background:rgba(187,134,252,.1)}
.share-opt.disabled{opacity:.4;cursor:not-allowed}
.signal-input-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.input-row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:600px){.input-row-2,.input-row-3{grid-template-columns:1fr;gap:0}}
.notif-bell{position:relative;background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-main);padding:8px}
.notif-dot{position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--danger);border-radius:50%;display:none}
.notif-dot.active{display:block}
.notif-popup{position:absolute;top:50px;right:10px;width:320px;max-height:400px;background:var(--popup-bg);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.6),var(--glow);overflow-y:auto;z-index:300;display:none}
.notif-popup.open{display:block}
.notif-item{padding:12px 15px;border-bottom:1px solid var(--border);cursor:pointer;transition:.2s;font-size:.85rem}
.notif-item:hover{background:rgba(255,255,255,.05)}
.notif-empty{padding:30px;text-align:center;color:var(--text-sub);font-size:.85rem}
.role-badge{padding:1px 6px;border-radius:4px;font-size:.6rem;font-weight:800;text-transform:uppercase;margin-left:4px}
.role-admin{background:var(--danger);color:#fff}
.role-coach{background:var(--accent);color:#000}
.role-member{background:#555;color:#ccc}
.emoji-picker-btn{background:none;border:none;font-size:1.3rem;cursor:pointer;padding:5px}
.msg-reactions{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
.msg-reaction{background:rgba(255,255,255,.1);border:1px solid var(--border);border-radius:12px;padding:2px 8px;font-size:.75rem;cursor:pointer;transition:.2s}
.msg-reaction:hover{background:rgba(255,255,255,.2)}
.msg-reaction.reacted{border-color:var(--accent);background:rgba(187,134,252,.15)}
.read-ticks{color:var(--wa-tick);font-size:.7rem}
.read-ticks.read{color:var(--wa-tick)}
.read-ticks.sent{color:rgba(255,255,255,.4)}
.profile-section{margin-top:20px;border-top:1px solid var(--border);padding-top:20px}
.profile-field{margin-bottom:15px}
.profile-field label{display:block;color:var(--text-sub);font-size:.8rem;font-weight:700;margin-bottom:5px}
.qp-answer-btn{display:block;width:100%;text-align:left;padding:14px 16px;background:#151517;border:2px solid #333;border-radius:10px;color:var(--text-main);font-size:.95rem;cursor:pointer;transition:.2s}
.qp-answer-btn:hover{border-color:var(--accent);background:rgba(187,134,252,.08)}
.qp-answer-btn.selected{border-color:var(--accent);background:rgba(187,134,252,.15)}
.qp-answer-btn.correct{border-color:var(--success);background:rgba(0,200,83,.15);color:var(--success)}
.qp-answer-btn.wrong{border-color:var(--danger);background:rgba(255,61,0,.15);color:var(--danger)}
@media(max-width:768px){
  body{padding-bottom:20px}
  .container{padding:10px}
  header{padding:10px 15px;padding-top:calc(10px + env(safe-area-inset-top))}
  #view-title{font-size:1rem}
  .jfc-body-grid{grid-template-columns:1fr!important}
  .jfc-chart-area{height:180px!important}
  .jfc-title{font-size:1.1rem}
  .stat-label{font-size:.7rem}
  .stat-value{font-size:.95rem}
  .dv-stats-grid{grid-template-columns:1fr 1fr;gap:10px}
  .modal-base{width:94%!important;max-width:480px!important;max-height:88vh!important;max-height:85dvh!important;padding:16px 16px calc(16px + env(safe-area-inset-bottom))!important;border-radius:16px!important;margin:auto!important;position:relative!important;overflow-y:auto!important;flex-shrink:0!important}
  .modal-layer2{z-index:1201!important}
  #popup-overlay,#popup-overlay-2{align-items:center!important;justify-content:center!important;overflow-y:auto!important;padding:16px 0!important}
  .td-hero .td-asset{font-size:1.4rem}
  .td-hero .td-pnl{font-size:2rem}
  .td-row{padding:10px 12px}
  .td-row-val{font-size:.9rem}
  .td-img-thumb{height:150px!important}
  .hist-table{font-size:.75rem}
  .hist-table th,.hist-table td{padding:10px 6px}
  .admin-grid{grid-template-columns:1fr!important}
  .adm-row{flex-wrap:wrap;gap:8px}
  .user-card-actions{flex-wrap:wrap}
  .cal-cell{aspect-ratio:1/1}
  .cal-pnl{font-size:.55rem}
  .cal-date{font-size:.6rem}
  .chat-container{height:calc(100vh - 120px)!important}
  .cl-item{padding:12px 10px;gap:10px}
  .cl-avatar{width:38px;height:38px;font-size:1rem}
  .cl-name{font-size:.9rem}
  .msg-bubble{font-size:.85rem}
  .filter-pill{padding:4px 8px;font-size:.65rem}
  .card-filters{gap:3px}
  .btn-icon,.btn-small{padding:5px 8px;font-size:.8rem}
  h2{font-size:1.8rem!important}
  .stats-grid-view{grid-template-columns:1fr!important}
  .full-width{grid-column:span 1!important}
  .chart-card{height:280px;padding:15px}
  .nav-drawer{width:260px}
  .settings-list-item{flex-wrap:wrap;gap:8px}
  .search-result-item{flex-wrap:wrap;gap:8px}
  .auth-container{width:95%;max-width:380px;padding:25px 20px;border-radius:16px}
  .auth-title{font-size:1.5rem;margin-bottom:20px}
}
@keyframes slideUpModal{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.ki-tab-bar{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.ki-tab{background:var(--cell-bg);border:1px solid var(--border);color:var(--text-sub);padding:8px 18px;border-radius:20px;cursor:pointer;font-size:.9rem;transition:.2s;font-weight:500}
.ki-tab.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.ki-messages{display:flex;flex-direction:column;min-height:180px;max-height:420px;overflow-y:auto;margin-bottom:16px;gap:8px;padding:4px 0}
.ki-msg{max-width:88%;padding:11px 15px;border-radius:16px;font-size:.9rem;line-height:1.6;word-break:break-word}
.ki-msg.user{background:var(--accent);color:#000;align-self:flex-end;border-radius:16px 16px 4px 16px}
.ki-msg.ai{background:var(--cell-bg);color:var(--text-main);align-self:flex-start;border-radius:16px 16px 16px 4px;border:1px solid var(--border)}
.ki-typing{display:flex;gap:5px;align-items:center;padding:12px 15px;background:var(--cell-bg);border-radius:16px 16px 16px 4px;border:1px solid var(--border);align-self:flex-start}
.ki-typing span{width:7px;height:7px;background:var(--text-sub);border-radius:50%;animation:kiDot 1.2s infinite}
.ki-typing span:nth-child(2){animation-delay:.2s}.ki-typing span:nth-child(3){animation-delay:.4s}
@keyframes kiDot{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
.ki-input-row{display:flex;flex-direction:column;gap:8px}.ki-input-row textarea{margin-bottom:0;width:100%;box-sizing:border-box;line-height:1.5;font-family:inherit;font-size:.95rem}.ki-input-actions{display:flex;justify-content:flex-end}.ki-send-btn{background:var(--gradient);color:#fff;padding:10px 22px;border:none;font-weight:700;border-radius:10px;cursor:pointer;white-space:nowrap;font-size:.95rem;box-shadow:0 4px 15px rgba(187,134,252,.25)}
.ki-result-box{background:var(--cell-bg);border:1px solid var(--border);border-radius:12px;padding:16px;white-space:pre-wrap;line-height:1.75;font-size:.9rem;margin-top:16px}
.news-pill{display:flex;align-items:center;gap:5px;background:var(--cell-bg);border:1px solid var(--border);border-radius:20px;padding:5px 10px;font-size:.75rem;white-space:nowrap;overflow:hidden}
.news-pill .np-cur{font-weight:800;font-size:.78rem;color:var(--text-main);flex-shrink:0}
.news-pill .np-name{color:var(--text-sub);overflow:hidden;text-overflow:ellipsis;max-width:90px}
.news-pill .np-time{font-family:monospace;color:var(--text-sub);font-size:.72rem;flex-shrink:0}
.news-pill .np-timer{font-family:monospace;color:var(--accent);font-weight:700;font-size:.72rem;flex-shrink:0}
@media(max-width:480px){.news-pill .np-name{display:none}.news-pill .np-time{display:none}.news-pill{padding:4px 8px}}
.ki-chart-drop{border:2px dashed var(--border);border-radius:14px;padding:36px 20px;text-align:center;cursor:pointer;transition:.25s}
.ki-chart-drop:hover{border-color:var(--accent);background:rgba(0,0,0,.05)}
.trade-img-drop{border:1.5px dashed var(--border);border-radius:10px;padding:11px 16px;text-align:center;cursor:pointer;transition:.2s;font-size:.88rem;color:var(--text-sub)}
.trade-img-drop:hover{border-color:var(--accent);color:var(--text)}
.trade-img-paste-btn{width:100%;margin-top:6px;padding:9px;border-radius:10px;border:1px solid var(--border);background:var(--cell-bg);color:var(--text-sub);font-weight:600;font-size:.85rem;cursor:pointer;transition:.2s}
.trade-img-paste-btn:hover{border-color:var(--accent);color:var(--text)}
@media(max-width:400px){
  h2{font-size:1.5rem!important}
  .jfc-stats-row{grid-template-columns:1fr}
  .filter-pill{padding:3px 6px;font-size:.6rem}
  .cal-cell{aspect-ratio:1/1.1}
  .modal-base{padding:10px 10px calc(10px + env(safe-area-inset-bottom))}
  .td-hero .td-pnl{font-size:1.6rem}
  .auth-container{padding:20px 15px}
}
</style></head><body>
<!-- MODALS -->
<div id="popup-overlay" onclick="if(event.target===this)closePopup()">
<div id="day-detail-view" class="modal-base hidden">
  <div class="dv-header"><div id="dv-date-title" style="font-weight:700;font-size:1.2rem;color:#fff">Date</div><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;font-size:1.2rem;cursor:pointer">&#x2715;</button></div>
  <div style="padding-bottom:20px;border-bottom:1px solid #2c2c2e;margin-bottom:20px"><div style="height:180px"><canvas id="dayChart"></canvas></div></div>
  <div class="dv-stats-grid">
    <div class="dv-stat-item"><span class="dv-stat-label">PnL</span><span id="dv-pnl" class="dv-stat-val sensitive">-</span></div>
    <div class="dv-stat-item"><span class="dv-stat-label">Win rate</span><span id="dv-winrate" class="dv-stat-val">-</span></div>
    <div class="dv-stat-item"><span class="dv-stat-label">Profit factor</span><span id="dv-pf" class="dv-stat-val">-</span></div>
    <div class="dv-stat-item"><span class="dv-stat-label">Trades</span><span id="dv-count" class="dv-stat-val">-</span></div>
  </div>
  <div class="closed-trades-title">Closed Trades</div>
  <div class="trades-list-card">
    <div class="trade-row-header"><div style="width:20px"></div><div style="width:100px">Open</div><div style="flex-grow:1">Symbol</div><div style="min-width:70px;text-align:right">PnL</div><div style="width:20px"></div></div>
    <div id="dv-list"></div>
  </div>
</div>
<div id="trade-form-modal" class="modal-base hidden">
  <div class="dv-header"><span id="form-title" style="font-weight:700;font-size:1.1rem">Neuer Trade</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:10px">
    <input type="hidden" id="editId">
    <label>Journal</label><select id="inpJournalSelect"></select>
    <label>Status</label><select id="status" onchange="toggleFormFields()"><option value="Aktiv">Laufend (Offen)</option><option value="Geschlossen">Geschlossen</option></select>
    <label>Asset</label><div class="asset-dropdown-wrap"><input type="text" id="assetInput" placeholder="EURUSD" style="text-transform:uppercase" autocomplete="off" oninput="showAssetDropdown(this,'asset-dd-1')" onfocus="showAssetDropdown(this,'asset-dd-1')"><div id="asset-dd-1" class="asset-dropdown"></div></div>
    <label>Datum</label><input type="datetime-local" id="datetime">
    <div class="input-row-2"><div><label>Entry</label><input type="number" id="inpEntry" step="any"></div><div><label>Stop Loss</label><input type="number" id="inpSL" step="any"></div></div>
    <div class="input-row-3"><div><label>TP 1</label><input type="number" id="inpTP1" step="any"></div><div><label>TP 2</label><input type="number" id="inpTP2" step="any"></div><div><label>TP 3</label><input type="number" id="inpTP3" step="any"></div></div>
    <label>Setup (Screenshot)</label>
    <div class="trade-img-picker">
      <div class="trade-img-drop" onclick="document.getElementById('setupImgFile').click()" ondragover="event.preventDefault();this.style.borderColor='var(--accent)'" ondragleave="this.style.borderColor=''" ondrop="event.preventDefault();this.style.borderColor='';const f=event.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadTradeImgFromBlob(f,'setup')">&#x1F4F8; Klicken, reinziehen oder <b>Strg+V</b></div>
      <button type="button" onclick="pasteTradeImg('setup')" class="trade-img-paste-btn">&#x1F4CB; Aus Zwischenablage</button>
      <input type="file" id="setupImgFile" accept="image/*" style="display:none" onchange="handleTradeImgUpload(event,'setup')">
      <div id="setupImgPreview"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;min-height:24px;margin-top:6px;gap:8px">
        <div id="tradeImgAiHint" style="font-size:.82rem;flex:1"></div>
        <button type="button" id="tradeChartAnalyseBtn" onclick="analyzeTradeSetupImg()" style="display:none;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);color:var(--text);border-radius:8px;padding:4px 10px;font-size:.78rem;cursor:pointer;white-space:nowrap;flex-shrink:0">&#x1F50D; KI-Analyse</button>
      </div>
      <div id="tradeChartResult" style="display:none;margin-top:8px"></div>
    </div>
    <input type="hidden" id="imgSetup">
    <label>Notiz</label><textarea id="note" rows="2"></textarea>
    <div id="closedFields" class="hidden">
      <label style="color:var(--success)">PnL (Euro)</label><input type="number" id="pnl" step="0.01">
      <label>Result (Screenshot)</label>
      <div class="trade-img-picker">
        <div class="trade-img-drop" onclick="document.getElementById('resultImgFile').click()" ondragover="event.preventDefault();this.style.borderColor='var(--accent)'" ondragleave="this.style.borderColor=''" ondrop="event.preventDefault();this.style.borderColor='';const f=event.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadTradeImgFromBlob(f,'result')">&#x1F4F8; Klicken, reinziehen oder <b>Strg+V</b></div>
        <button type="button" onclick="pasteTradeImg('result')" class="trade-img-paste-btn">&#x1F4CB; Aus Zwischenablage</button>
        <input type="file" id="resultImgFile" accept="image/*" style="display:none" onchange="handleTradeImgUpload(event,'result')">
        <div id="resultImgPreview"></div>
      </div>
      <input type="hidden" id="imgResult">
    </div>
    <div id="admin-feedback-container" class="hidden" style="margin-top:20px;border-top:1px solid #333;padding-top:15px"><label style="color:var(--accent)">Coach Feedback</label><textarea id="inpAdminFeedback" rows="2" style="border-color:var(--accent)" placeholder="Tipp fuer den User..."></textarea></div>
    <button onclick="saveTrade()" class="btn-primary" style="margin-top:15px">SPEICHERN</button>
  </div>
</div>
<div id="add-contact-modal" class="modal-base hidden">
  <div class="dv-header"><span style="font-weight:700">Kontakt hinzufuegen</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px">
    <p style="color:var(--text-sub);font-size:.9rem">Suche nach Namen:</p>
    <input type="text" id="contact-search-input" placeholder="Name eingeben..." onkeyup="searchUsers()">
    <div id="contact-search-results" style="margin-top:10px;max-height:200px;overflow-y:auto"></div>
  </div>
</div>
<div id="trade-detail-view" class="modal-base hidden">
  <div class="dv-header"><button onclick="closeTradeDetail()" style="background:none;border:none;color:#0a84ff;font-size:1rem;cursor:pointer;font-weight:600">&#x276E; Back</button><div style="font-weight:700;font-size:1.1rem;color:#fff">Trade Details</div><div style="width:40px"></div></div>
  <div id="td-content"></div>
  <div id="adm-feedback-input-area" class="hidden" style="padding:20px;border-top:1px solid #333;margin-top:20px;background:#151517">
    <label style="color:var(--accent);font-weight:700;display:block;margin-bottom:8px">Coach Feedback senden:</label>
    <textarea id="adm-feedback-text" rows="3" style="width:100%;background:#000;color:#fff;border:1px solid #333;padding:10px;border-radius:8px"></textarea>
    <button onclick="submitAdminFeedback()" class="btn-primary" style="margin-top:10px;padding:10px">Senden</button>
  </div>
</div>
<div id="admin-member-modal" class="modal-base hidden" style="max-height:90vh;display:flex;flex-direction:column">
  <div class="dv-header"><span style="font-weight:700">Mitglied Details</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="text-align:center;margin-bottom:20px"><h2 id="adm-detail-name" style="margin:0">User</h2><div id="adm-detail-email" style="color:var(--text-sub);font-size:.9rem">email</div></div>
  <div id="adm-content-area-wrapper">
    <div style="padding:0 20px 20px"><label style="display:block;color:var(--text-sub);margin-bottom:5px;font-size:.8rem;font-weight:700">JOURNAL</label><select id="adm-journal-select" onchange="updateAdminMemberView()"></select></div>
    <div style="display:flex;border-bottom:1px solid #333"><button class="adm-tab-btn active" onclick="switchAdminTab('stats')" id="btn-adm-stats">Statistik</button><button class="adm-tab-btn" onclick="switchAdminTab('trades')" id="btn-adm-trades">Trade Liste</button></div>
    <div id="adm-content-stats" style="padding:20px;overflow-y:auto">
      <div class="dv-stats-grid">
        <div class="stat-box"><span class="stat-label">Total PnL</span><div class="stat-value sensitive" id="adm-stat-pnl">0.00 â‚¬</div></div>
        <div class="stat-box"><span class="stat-label">Winrate</span><div class="stat-value" id="adm-stat-win">0%</div></div>
        <div class="stat-box"><span class="stat-label">Trades</span><div class="stat-value" id="adm-stat-count">0</div></div>
      </div>
      <div style="height:200px;margin-top:20px"><canvas id="admChart"></canvas></div>
    </div>
    <div id="adm-content-trades" class="hidden" style="overflow-y:auto;flex-grow:1">
      <table class="hist-table"><thead><tr><th>Date</th><th>Asset</th><th style="text-align:right">PnL</th><th></th></tr></thead><tbody id="adm-trade-list"></tbody></table>
    </div>
  </div>
  <div id="adm-access-denied" class="hidden access-denied-container"><div style="font-size:4rem;opacity:.5">&#x1F512;</div><h3>Zugriff verweigert</h3><p>Das Mitglied hat die Einsicht deaktiviert.</p></div>
</div>
<div id="date-range-modal" class="modal-base hidden">
  <div class="dv-header"><span style="font-weight:700">Zeitraum waehlen</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="display:flex;flex-direction:column;gap:15px">
    <div><label style="display:block;margin-bottom:5px;color:var(--text-sub)">VON</label><input type="date" id="custom-start"></div>
    <div><label style="display:block;margin-bottom:5px;color:var(--text-sub)">BIS</label><input type="date" id="custom-end"></div>
    <button onclick="applyCustomDate()" class="btn-primary">ANWENDEN</button>
  </div>
</div>
<div id="share-modal" class="modal-base hidden">
  <div class="dv-header"><span style="font-weight:700">Trade Teilen</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <label style="font-size:.8rem;color:var(--text-sub);display:block;margin-top:10px">TEILEN IN</label>
  <select id="share-channel" style="margin-bottom:15px" onchange="toggleShareTarget()">
    <option value="public">Public Chat</option><option value="signals">Signale</option><option value="pro_signal">Pro Signal</option><option value="private">An Kontakt</option>
  </select>
  <div id="share-private-container" class="hidden" style="margin-bottom:15px"><label style="font-size:.8rem;color:var(--text-sub);display:block;margin-bottom:5px">KONTAKT</label><select id="share-private-user"></select></div>
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:5px">
    <div id="opt-setup" class="share-opt" onclick="selectShareOption('setup')"><span>Setup Chart</span></div>
    <div id="opt-result" class="share-opt" onclick="selectShareOption('result')"><span>Ergebnis Chart</span></div>
  </div>
  <div id="signal-inputs" class="signal-input-grid hidden">
    <input type="number" id="sig-entry" placeholder="Entry"><input type="number" id="sig-sl" placeholder="SL">
    <input type="number" id="sig-tp1" placeholder="TP 1"><input type="number" id="sig-tp2" placeholder="TP 2">
    <input type="number" id="sig-tp3" placeholder="TP 3" style="grid-column:span 2">
  </div>
  <button onclick="confirmShare()" class="btn-primary" style="margin-top:10px">Senden</button>
</div>
<div id="delete-modal" class="modal-base hidden" style="text-align:center">
  <h3 style="margin:0 0 10px">Nachricht loeschen?</h3>
  <p style="font-size:.9rem;color:var(--text-sub);margin-bottom:20px">Dies kann nicht rueckgaengig gemacht werden.</p>
  <div style="display:flex;gap:10px">
    <button onclick="confirmDeleteMessage()" class="btn-primary" style="background:var(--danger);flex:1">Loeschen</button>
    <button onclick="closePopup()" class="btn-small" style="flex:1">Abbrechen</button>
  </div>
</div>
<div id="journal-form-modal" class="modal-base hidden">
  <div class="dv-header"><span id="journal-modal-title" style="font-weight:700;font-size:1.1rem">Neues Journal</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px">
    <label>Name</label><input id="jmName" placeholder="Journal Name">
    <label>Kapital (Euro)</label><input id="jmCap" type="number" placeholder="Startkapital">
    <div class="input-row-2"><div><label>Max. Verlust</label><input id="jmMaxDD" type="number" placeholder="Max. Verlust"></div><div><label>Typ</label><select id="jmDDType"><option value="eur">Euro</option><option value="percent">%</option></select></div></div>
    <button id="btn-jm-save" onclick="saveJournalModal()" class="btn-primary" style="margin-top:15px">Erstellen</button>
  </div>
</div>
<div id="navguard-modal" class="modal-base hidden" style="text-align:center;padding:30px">
  <div style="font-size:4rem;margin-bottom:15px">&#x1F512;</div>
  <h3 style="margin:0 0 10px;color:var(--accent)">Kein Zugriff</h3>
  <p style="color:var(--text-sub);margin-bottom:20px">Diese Funktion ist nur fuer Pro-Mitglieder verfuegbar.</p>
  <div style="display:flex;gap:10px">
    <button onclick="requestUpgrade()" class="btn-primary" style="flex:1">Upgrade anfragen</button>
    <button onclick="closePopup()" class="btn-small" style="flex:1">Schliessen</button>
  </div>
</div>
<div id="notif-modal" class="modal-base hidden" style="max-height:80vh">
  <div class="dv-header"><span style="font-weight:700;font-size:1.1rem">Benachrichtigungen</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div id="notif-list" style="max-height:60vh;overflow-y:auto"><div class="notif-empty">Keine Benachrichtigungen</div></div>
</div>
<div id="profile-modal" class="modal-base hidden" style="max-width:420px">
  <div class="dv-header"><span style="font-weight:700;font-size:1.1rem">Profil</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:20px">
    <div class="profile-card">
      <div class="profile-avatar" id="prof-avatar">U</div>
      <div id="prof-display-name" style="font-weight:700;font-size:1.1rem;margin-bottom:4px"></div>
      <div id="prof-display-email" style="color:var(--text-sub);font-size:.85rem"></div>
      <div id="prof-status-badge" style="display:inline-block;margin-top:8px;padding:3px 12px;border-radius:20px;font-size:.75rem;font-weight:700"></div>
    </div>
    <div class="profile-field-row"><label>Name</label><input id="prof-name" placeholder="Dein Name"></div>
    <div id="prof-email-section" class="profile-field-row hidden"><label>E-Mail</label><input id="prof-email" type="email" placeholder="E-Mail"></div>
    <div id="prof-pw-section" class="hidden" style="margin-bottom:15px"><button onclick="sendPasswordChange()" class="btn-small" style="width:100%;padding:10px;border-radius:10px">&#x1F511; Passwort aendern (Link per E-Mail)</button></div>
    <div class="profile-field-row"><label>Telefon (optional)</label><input id="prof-phone" type="tel" placeholder="+49 123 456789"></div>
    <button onclick="saveProfile()" class="btn-primary" style="margin-top:10px;border-radius:12px">Speichern</button>
  </div>
</div>
<div id="upgrade-req-modal" class="modal-base hidden" style="text-align:center;padding:30px">
  <div style="font-size:3rem;margin-bottom:15px">&#x1F680;</div>
  <h3 style="margin:0 0 10px;color:var(--accent)">Upgrade Anfrage gesendet!</h3>
  <p style="color:var(--text-sub);margin-bottom:20px">Der Admin wird deine Anfrage pruefen.</p>
  <button onclick="closePopup()" class="btn-primary">OK</button>
</div>
<div id="course-modal" class="modal-base hidden">
  <div class="dv-header"><span id="course-modal-title" style="font-weight:700;font-size:1.1rem">Neuer Kurs</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px">
    <label>Titel</label><input id="cm-title" placeholder="Kurs Titel">
    <label>Beschreibung</label><textarea id="cm-desc" rows="3" placeholder="Kurze Beschreibung des Kurses..."></textarea>
    <button id="btn-cm-save" onclick="saveCourseModal()" class="btn-primary" style="margin-top:15px">Erstellen</button>
  </div>
</div>
<div id="module-modal" class="modal-base hidden" style="max-height:90vh;overflow-y:auto">
  <div class="dv-header"><span id="module-modal-title" style="font-weight:700;font-size:1.1rem">Neues Modul</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px">
    <label>Titel</label><input id="mm-title" placeholder="Modul Titel">
    <label>Beschreibung</label><textarea id="mm-desc" rows="2" placeholder="Beschreibung (optional)"></textarea>
    <label>Video</label>
    <input type="url" id="mm-video-url-input" placeholder="Video-URL (YouTube, Google Drive, MP4-Link...)" style="margin-bottom:8px">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <span style="color:var(--text-sub);font-size:.8rem">oder</span>
      <label for="mm-video-file" style="cursor:pointer;color:var(--accent);font-size:.85rem;font-weight:700;margin:0">MP4-Datei hochladen</label>
      <input type="file" id="mm-video-file" accept="video/mp4,.mp4" style="display:none" onchange="handleVideoSelect(this)">
    </div>
    <div id="mm-upload-progress" class="hidden" style="margin-bottom:12px">
      <div class="upload-progress"><div id="mm-progress-bar" class="upload-progress-bar"></div></div>
      <small id="mm-upload-status" style="color:var(--text-sub);display:block;margin-top:4px">Hochladen...</small>
    </div>
    <div id="mm-upload-error" class="hidden" style="margin-bottom:12px;background:rgba(255,61,0,.15);border:1px solid var(--danger);border-radius:8px;padding:10px;font-size:.8rem;color:var(--danger)"></div>
    <div id="mm-video-preview" class="hidden" style="margin-bottom:12px;background:#151517;padding:10px;border-radius:8px;border:1px solid #333">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="color:var(--success);font-size:.85rem;font-weight:700">&#x2705; Video</span>
        <button class="btn-small" onclick="removeModuleVideo()" style="font-size:.75rem">Entfernen</button>
      </div>
      <video id="mm-video-player" controls style="width:100%;max-height:180px;margin-top:8px;border-radius:6px"></video>
    </div>
    <label>Dokument (optional)</label>
    <input type="url" id="mm-doc-url-input" placeholder="Dokument-URL (PDF-Link, Google Drive...)" style="margin-bottom:8px">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <span style="color:var(--text-sub);font-size:.8rem">oder</span>
      <label for="mm-doc-file" style="cursor:pointer;color:var(--accent);font-size:.85rem;font-weight:700;margin:0">PDF hochladen</label>
      <input type="file" id="mm-doc-file" accept=".pdf,application/pdf" style="display:none" onchange="handleDocSelect(this)">
    </div>
    <div id="mm-doc-progress" class="hidden" style="margin-bottom:12px">
      <div class="upload-progress"><div id="mm-doc-bar" class="upload-progress-bar"></div></div>
      <small id="mm-doc-status" style="color:var(--text-sub);display:block;margin-top:4px">Hochladen...</small>
    </div>
    <div id="mm-doc-preview" class="hidden" style="margin-bottom:12px;background:#151517;padding:10px;border-radius:8px;border:1px solid #333">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="color:var(--success);font-size:.85rem;font-weight:700">&#x2705; Dokument</span>
        <button class="btn-small" onclick="removeModuleDoc()" style="font-size:.75rem">Entfernen</button>
      </div>
    </div>
    <input type="hidden" id="mm-video-url">
    <input type="hidden" id="mm-doc-url">
    <div style="display:flex;gap:10px;margin-top:15px">
      <button id="btn-mm-save" onclick="saveModuleModal()" class="btn-primary" style="flex:1">Erstellen</button>
      <button id="btn-mm-quiz" onclick="openQuizEditor()" class="btn-small" style="flex:1" title="Quiz Fragen hinzufuegen">&#x1F9E0; Quiz</button>
    </div>
  </div>
</div>
<div id="quiz-edit-modal" class="modal-base hidden" style="max-height:90vh">
  <div class="dv-header"><span style="font-weight:700;font-size:1.1rem">Quiz bearbeiten</span><button onclick="closeQuizEditor()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px;overflow-y:auto;max-height:70vh">
    <p style="color:var(--text-sub);font-size:.8rem;margin-bottom:15px">Erstelle Fragen mit jeweils mehreren Antworten. Markiere die richtige Antwort.</p>
    <div id="qe-questions"></div>
    <button onclick="addQuizQuestion()" class="btn-small" style="width:100%;margin-top:10px">&#x2795; Frage hinzufuegen</button>
    <button onclick="saveQuizToModule()" class="btn-primary" style="margin-top:15px">Quiz uebernehmen</button>
  </div>
</div>
<div id="create-group-modal" class="modal-base hidden" style="max-width:400px">
  <div class="dv-header"><span style="font-weight:700;font-size:1.1rem">Gruppe erstellen</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px">
    <label>Gruppenname</label>
    <input type="text" id="cg-name" placeholder="z.B. Scalping Team" maxlength="50" style="margin-bottom:12px">
    <label>Mitglieder einladen</label>
    <input type="text" id="cg-member-search" placeholder="Name oder Email suchen..." oninput="searchGroupMembers()" style="margin-bottom:8px">
    <div id="cg-search-results" style="max-height:120px;overflow-y:auto;margin-bottom:12px"></div>
    <div style="font-size:.8rem;color:var(--text-sub);margin-bottom:4px">Eingeladen:</div>
    <div id="cg-invited-list" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:15px;min-height:30px"></div>
    <button onclick="saveCreateGroupChat()" class="btn-primary" style="width:100%">Gruppe erstellen</button>
  </div>
</div>
<div id="invite-group-modal" class="modal-base hidden" style="max-width:400px">
  <div class="dv-header"><span style="font-weight:700;font-size:1.1rem">Mitglieder einladen</span><button onclick="closePopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="padding:15px">
    <input type="text" id="ig-member-search" placeholder="Name oder Email suchen..." oninput="searchInviteMembers()" style="margin-bottom:8px">
    <div id="ig-search-results" style="max-height:200px;overflow-y:auto"></div>
  </div>
</div>
<div id="module-detail-modal" class="modal-base hidden" style="max-width:800px;max-height:95vh;overflow-y:auto;padding:0;border-radius:20px">
  <div style="position:sticky;top:0;z-index:2;background:var(--popup-bg);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:36px;height:36px;border-radius:10px;background:var(--gradient);display:flex;align-items:center;justify-content:center;font-size:1.1rem">&#x1F3AC;</div>
      <div><div id="md-title" style="font-weight:800;font-size:1.1rem">Modul</div><div id="md-subtitle" style="font-size:.75rem;color:var(--text-sub);margin-top:2px">Video &amp; Lernmaterial</div></div>
    </div>
    <button onclick="closeModuleDetail()" style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;font-size:1rem;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:.2s" onmouseover="this.style.background='rgba(255,255,255,.15)'" onmouseout="this.style.background='rgba(255,255,255,.08)'">&#x2715;</button>
  </div>
  <div style="padding:0">
    <div id="md-video-area" class="hidden">
      <div style="position:relative;background:#000;border-bottom:1px solid var(--border)">
        <video id="md-player" controls style="width:100%;max-height:420px;display:block"></video>
      </div>
    </div>
    <div style="padding:24px;display:flex;flex-direction:column;gap:16px">
      <div id="md-desc-area" class="hidden" style="background:var(--cell-bg);border:1px solid var(--border);border-radius:14px;padding:20px;backdrop-filter:blur(5px)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><span style="font-size:1rem">&#x1F4DD;</span><span style="font-size:.8rem;color:var(--accent);font-weight:700;text-transform:uppercase;letter-spacing:1px">Beschreibung</span></div>
        <p id="md-desc-text" style="color:var(--text-sub);font-size:.92rem;line-height:1.7;margin:0;white-space:pre-line"></p>
      </div>
      <div id="md-doc-area" class="hidden">
        <a id="md-doc-link" href="#" target="_blank" style="display:flex;align-items:center;gap:12px;padding:16px 20px;background:var(--cell-bg);border:1px solid var(--border);border-radius:14px;color:var(--text-main);text-decoration:none;font-weight:600;font-size:.92rem;transition:.2s;backdrop-filter:blur(5px)" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'"><span style="font-size:1.3rem">&#x1F4C4;</span><span style="flex:1">Dokument herunterladen</span><span style="color:var(--accent);font-size:1.1rem">&#x2913;</span></a>
      </div>
      <div id="md-video-hint" class="hidden" style="background:linear-gradient(135deg,rgba(187,134,252,.08),rgba(108,99,255,.08));border:1px solid rgba(187,134,252,.25);border-radius:14px;padding:20px;text-align:center">
        <span style="font-size:2rem;display:block;margin-bottom:8px">&#x1F3AC;</span>
        <p style="color:var(--accent);font-weight:700;margin:0;font-size:.95rem">Schaue das Video komplett an um das Quiz freizuschalten.</p>
      </div>
      <div id="md-quiz-area" class="hidden" style="text-align:center;padding:10px 0">
        <button id="md-quiz-btn" class="btn-primary" style="padding:16px 40px;font-size:1rem;border-radius:14px;background:var(--gradient);border:none;font-weight:700">&#x1F9E0; Quiz starten</button>
        <p style="color:var(--text-sub);font-size:.8rem;margin-top:10px">Bestehe das Quiz um das Modul abzuschliessen.</p>
      </div>
      <div id="md-completed-area" class="hidden" style="text-align:center;padding:25px 20px;background:linear-gradient(135deg,rgba(0,230,118,.08),rgba(0,230,118,.02));border:1px solid rgba(0,230,118,.2);border-radius:14px">
        <div style="font-size:3rem;margin-bottom:10px">&#x2705;</div>
        <p style="color:var(--success);font-weight:800;font-size:1.1rem;margin:0">Modul abgeschlossen!</p>
        <button id="md-next-btn" class="btn-primary hidden" style="margin-top:15px;padding:12px 30px;border-radius:12px;font-size:.95rem" onclick="openNextModule()">Weiter zum naechsten Modul &#x276F;</button>
      </div>
      <div id="md-no-quiz-hint" class="hidden" style="background:linear-gradient(135deg,rgba(48,209,88,.08),rgba(48,209,88,.02));border:1px solid rgba(48,209,88,.2);border-radius:14px;padding:20px;text-align:center">
        <p style="color:var(--success);font-weight:700;margin:0;font-size:.95rem">Schaue das Video komplett an um das Modul abzuschliessen.</p>
      </div>
    </div>
  </div>
</div>
<div id="video-player-modal" class="modal-base hidden" style="padding:0;max-width:900px">
  <div class="dv-header" style="padding:10px 15px"><span id="vpm-title" style="font-weight:700;font-size:1rem">Video</span><button onclick="closeVideoPopup()" style="background:none;border:none;color:#8e8e93;cursor:pointer;font-size:1.2rem">&#x2715;</button></div>
  <div style="background:#000"><video id="vpm-player" controls style="width:100%;max-height:70vh;display:block"></video></div>
</div>
<div id="quiz-play-modal" class="modal-base hidden" style="max-height:90vh">
  <div class="dv-header">
    <span id="qp-header" style="font-weight:700;font-size:1.1rem">Quiz</span>
    <span id="qp-progress" style="color:var(--text-sub);font-size:.85rem"></span>
  </div>
  <div style="padding:20px">
    <div id="qp-question" style="font-size:1.1rem;font-weight:700;margin-bottom:20px;line-height:1.4"></div>
    <div id="qp-answers" style="display:flex;flex-direction:column;gap:10px"></div>
    <div id="qp-feedback" class="hidden" style="margin-top:15px;padding:12px;border-radius:8px;font-weight:700;text-align:center"></div>
    <div style="display:flex;gap:10px;margin-top:20px">
      <button id="qp-btn-next" onclick="quizNext()" class="btn-primary" style="flex:1" disabled>Weiter</button>
    </div>
  </div>
  <div id="qp-result" class="hidden" style="padding:20px;text-align:center">
    <div id="qp-result-icon" style="font-size:4rem;margin-bottom:15px"></div>
    <h3 id="qp-result-title" style="margin:0 0 10px"></h3>
    <p id="qp-result-text" style="color:var(--text-sub);margin-bottom:20px"></p>
    <button id="qp-result-btn" class="btn-primary">OK</button>
  </div>
</div>
</div>
<div id="popup-overlay-2" onclick="if(event.target===this)closePopup2()">
</div>
<!-- AUTH -->
<div id="auth-overlay">
  <div class="auth-container">
    <h2 class="auth-title">TRADECLOUD</h2>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Registrieren</button>
    </div>
    <div id="auth-error" class="auth-error"></div>
    <div id="login-form" class="auth-form active">
      <input type="email" id="login-email" placeholder="E-Mail Adresse">
      <input type="password" id="login-password" placeholder="Passwort">
      <button onclick="loginEmail()" class="btn-primary" style="margin-bottom:12px">LOGIN</button>
      <div style="text-align:center;margin-bottom:10px"><a href="#" onclick="resetPassword();return false" style="color:var(--accent);font-size:.85rem;text-decoration:none">Passwort vergessen?</a></div>
      <div class="auth-divider">&#8212; oder &#8212;</div>
      <button onclick="loginGoogle()" class="btn-primary" style="background:#fff;color:#000;margin-top:12px">Mit Google anmelden</button>
    </div>
    <div id="register-form" class="auth-form">
      <input type="text" id="reg-name" placeholder="Dein Name">
      <input type="email" id="reg-email" placeholder="E-Mail Adresse">
      <input type="password" id="reg-pass" placeholder="Passwort (min. 6 Zeichen)">
      <input type="password" id="reg-pass2" placeholder="Passwort bestaetigen">
      <button onclick="registerEmail()" class="btn-primary" style="margin-bottom:12px">REGISTRIEREN</button>
      <div class="auth-divider">&#8212; oder &#8212;</div>
      <button onclick="loginGoogle()" class="btn-primary" style="background:#fff;color:#000;margin-top:12px">Mit Google registrieren</button>
    </div>
  </div>
</div>
<header id="main-header" class="hidden">
  <div style="display:flex;align-items:center"><button class="menu-btn" onclick="toggleMenu()">&#9776;</button><div id="view-title">DASHBOARD</div></div>
  <div style="display:flex;align-items:center;gap:5px">
    <button class="notif-bell" onclick="toggleNotifPopup()" title="Benachrichtigungen">&#x1F514;<span id="notif-dot" class="notif-dot"></span></button>
    <button class="btn-icon" style="padding:8px;font-size:1.2rem;border:none;background:none" onclick="togglePrivacy()" title="Privat-Modus">&#x1F441;</button>
  </div>
</header>
<div id="notif-popup-overlay" onclick="closeNotifPopup()" style="position:fixed;inset:0;z-index:299;display:none"></div>
<div id="notif-popup" class="notif-popup"></div>
<div id="menu-overlay" onclick="toggleMenu()"></div>
<nav class="nav-drawer" id="navDrawer">
  <div style="text-align:right;padding:10px 20px"><button onclick="toggleMenu()" style="border:none;background:none;font-size:1.5rem;color:var(--text-sub)">&#x2715;</button></div>
  <button onclick="showView('Uebersicht')" id="btn-Uebersicht">&#x1F3E0; Dashboard</button>
  <button onclick="prepareCreateView()" style="color:var(--accent)">&#x2795; Neuer Trade</button>
  <button onclick="navGuard('Chat')" id="btn-Chat">&#x1F4AC; Chat <span id="chat-unread-badge" style="display:none;background:var(--danger);color:#fff;font-size:.7rem;font-weight:800;padding:2px 7px;border-radius:10px;margin-left:6px;min-width:18px;text-align:center"></span><span id="lock-Chat" class="nav-lock hidden">&#x1F512;</span></button>
  <div class="nav-separator"></div>
  <div class="nav-selector-container">
    <label class="nav-selector-label">AKTUELLES JOURNAL</label>
    <select id="navJournalSelect" onchange="changeActiveJournal(this.value)"></select>
  </div>
  <button onclick="showView('Kalender')" id="btn-Kalender">&#x1F4C5; Kalender</button>
  <button onclick="showView('Statistik')" id="btn-Statistik">&#x1F4C8; Statistik</button>
  <button onclick="showView('Historie')" id="btn-Historie">&#x1F4DC; Journal</button>
  <button onclick="showView('KI')" id="btn-KI">&#x1F916; KI-Assistent</button>
  <div class="nav-separator"></div>
  <button onclick="navGuard('TradingView')" id="btn-TradingView">&#x1F4C8; Chart <span id="lock-TradingView" class="nav-lock hidden">&#x1F512;</span></button>
  <button onclick="navGuard('Lot-Rechner')" id="btn-Lot-Rechner">&#x1F4CA; Lot Rechner <span id="lock-Lot-Rechner" class="nav-lock hidden">&#x1F512;</span></button>
  <button onclick="navGuard('News')" id="btn-News">&#x1F4F0; News <span id="lock-News" class="nav-lock hidden">&#x1F512;</span></button>
  <button onclick="navGuard('Kurse')" id="btn-Kurse">&#x1F393; Kurs <span id="lock-Kurse" class="nav-lock hidden">&#x1F512;</span></button>
  <div class="nav-separator"></div>
  <button onclick="showView('Einstellungen')" id="btn-Einstellungen">&#x2699; Einstellungen</button>
  <button onclick="showView('Feedback')" id="btn-Feedback">&#x1F4E3; Feedback</button>
  <div class="nav-separator"></div>
  <button onclick="handleLogout()" style="color:var(--danger);margin-top:20px">&#x1F6AA; Logout</button>
</nav>
<div id="app-content" class="container hidden">
<section id="view-Uebersicht" class="view-section active">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:20px">
    <h2 style="margin:0;font-size:2.2rem;font-weight:900;letter-spacing:-.5px;white-space:nowrap">Hallo <span id="user-greeting-name">Trader</span></h2>
    <div id="dashboard-news-widget" style="flex:1;min-width:0"></div>
    <button onclick="prepareCreateView()" style="padding:12px 16px;font-size:1.3rem;border:none;background:var(--gradient);color:#fff;border-radius:12px;cursor:pointer;box-shadow:0 4px 20px rgba(108,99,255,.4);transition:.2s;flex-shrink:0" title="Neuer Trade">&#x2795;</button>
  </div>
  <div id="upgrade-banner-area"></div>
  <div id="dashboard-notification-area"></div>
  <div id="dashboard-journals-list"></div>
</section>
<section id="view-Chat" class="view-section" style="height:calc(100vh - 70px);height:calc(100dvh - 70px);padding:0;overflow:hidden">
  <div class="card chat-container" style="border:none;border-radius:0;height:100%;margin:0">
    <div id="chat-lobby" class="chat-lobby">
      <div class="cl-header"><span>CHATS</span><div style="display:flex;gap:6px"><button class="btn-icon" style="background:none;border:none;font-size:1.2rem" onclick="openCreateGroupChat()" title="Gruppe erstellen">&#x1F465;</button><button class="btn-icon" style="background:none;border:none;font-size:1.5rem" onclick="openAddContactModal()" title="Kontakt hinzufuegen">&#x2795;</button></div></div>
      <div class="cl-list">
        <div id="chat-pinned-area"></div>
        <div id="chat-channels-area"></div>
        <div id="friend-requests-area"></div>
        <div style="padding:10px 15px;font-size:.8rem;color:var(--text-sub);font-weight:700;margin-top:10px">KONTAKTE</div>
        <div id="chat-user-list"></div>
      </div>
    </div>
    <div id="chat-room" class="chat-room hidden">
      <div class="cr-header"><button class="cr-back-btn" onclick="leaveChat()">&#x276E;</button><div class="cr-title" id="chat-room-title">Chat</div><button id="chat-mute-btn" class="mute-btn" onclick="toggleMuteChat()" title="Chat stumm schalten">&#x1F514;</button></div>
      <div id="chat-messages" class="chat-messages"></div>
      <div id="chat-input-area" class="chat-input-area"><input type="text" id="chat-input" class="chat-input-field" placeholder="Nachricht schreiben..." onkeypress="if(event.key==='Enter')sendChatMessage()"><button onclick="sendChatMessage()" class="chat-send-btn">&#x27A4;</button></div>
      <div id="chat-read-only-msg" class="hidden" style="padding:15px;text-align:center;color:var(--text-sub);font-size:.9rem;font-style:italic;background:var(--wa-header)">Nur Lesezugriff.</div>
    </div>
  </div>
</section>
<section id="view-Feedback" class="view-section">
  <div class="card"><h3>Feedback</h3>
    <div id="user-feedback-form">
      <p style="color:var(--text-sub);font-size:.9rem;margin-bottom:20px">Hast du Vorschlaege oder Bugs? Schreibe direkt an das Admin-Team.</p>
      <label>Art</label><select id="fb-type"><option value="Allgemein">Allgemein</option><option value="Bug">Fehler / Bug</option><option value="Feature">Feature Wunsch</option><option value="Support">Support Anfrage</option></select>
      <label>Nachricht</label><textarea id="fb-text" rows="5" placeholder="Deine Nachricht..."></textarea>
      <button onclick="sendGeneralFeedback()" class="btn-primary" style="margin-top:15px">Absenden</button>
    </div>
  </div>
</section>
<section id="view-TradingView" class="view-section" style="height:calc(100vh - 70px)">
  <div id="tradingview_chart" style="height:100%;width:100%;border-radius:12px;overflow:hidden"></div>
</section>
<section id="view-Kalender" class="view-section">
  <div class="card">
    <div class="cal-header-row">
      <div><h2 id="cal-month-title" style="margin:0">-</h2><small id="cal-filter-hint" style="color:var(--accent);font-size:.8rem">-</small></div>
      <div><button class="chart-btn" onclick="changeCalMonth(-1)" title="Vorheriger Monat">&#x276E;</button><button class="chart-btn" onclick="changeCalMonth(1)" title="Naechster Monat">&#x276F;</button></div>
    </div>
    <div class="calendar-grid">
      <div style="text-align:center;color:#666;font-size:.7rem">So</div><div style="text-align:center;color:#666;font-size:.7rem">Mo</div><div style="text-align:center;color:#666;font-size:.7rem">Di</div>
      <div style="text-align:center;color:#666;font-size:.7rem">Mi</div><div style="text-align:center;color:#666;font-size:.7rem">Do</div><div style="text-align:center;color:#666;font-size:.7rem">Fr</div><div style="text-align:center;color:#666;font-size:.7rem">Sa</div>
    </div>
    <div id="cal-days-grid" class="calendar-grid" style="margin-top:5px"></div>
  </div>
</section>
<section id="view-Statistik" class="view-section">
  <div id="stat-journal-hint" style="color:var(--accent);font-size:.85rem;margin-bottom:15px;font-weight:600"></div>
  <div class="stats-grid-view">
    <div class="chart-card"><h4 style="margin:0 0 15px">&#x1F4CA; Asset Performance</h4><div style="height:240px;position:relative"><canvas id="assetChart"></canvas></div></div>
    <div class="chart-card"><h4 style="margin:0 0 15px">&#x1F4C5; Wochentags Performance</h4><div style="height:240px;position:relative"><canvas id="weekdayChart"></canvas></div></div>
    <div class="chart-card full-width"><h4 style="margin:0 0 15px">&#x23F0; Stuendliche Performance</h4><div style="height:240px;position:relative"><canvas id="hourChart"></canvas></div></div>
  </div>
</section>
<section id="view-Historie" class="view-section">
  <div class="card" style="overflow-x:auto">
    <h3 id="hist-title">Trade Historie</h3>
    <table class="hist-table"><thead><tr><th style="min-width:90px">Date/Time</th><th>Asset</th><th style="text-align:right">PnL</th><th></th></tr></thead><tbody id="tradeBody"></tbody></table>
  </div>
</section>
<section id="view-Lot-Rechner" class="view-section">
  <div class="card"><h3>Lot Rechner</h3>
    <label>Asset</label><div class="asset-dropdown-wrap"><input type="text" id="cAsset" placeholder="z.B. EURUSD, XAUUSD, US30" style="text-transform:uppercase" autocomplete="off" oninput="showAssetDropdown(this,'asset-dd-2')" onfocus="showAssetDropdown(this,'asset-dd-2')"><div id="asset-dd-2" class="asset-dropdown"></div></div>
    <div class="input-row-2"><div><label>Konto (EUR)</label><input type="number" id="cBal" placeholder="10000"></div><div><label>Risiko %</label><input type="number" id="cRisk" placeholder="1" step="0.1"></div></div>
    <div class="input-row-2"><div><label>Entry</label><input type="number" id="cEnt" placeholder="1.08500" step="any"></div><div><label>Stop Loss</label><input type="number" id="cSl" placeholder="1.08000" step="any"></div></div>
    <button onclick="calcLots()" class="btn-primary">Berechnen</button>
    <div id="cRes" style="text-align:center;margin-top:20px">
      <div style="font-size:2rem;font-weight:900;color:var(--success)" id="cResLot">0.00 Lot</div>
      <div style="font-size:.85rem;color:var(--text-sub);margin-top:8px" id="cResInfo"></div>
    </div>
  </div>
</section>
<section id="view-News" class="view-section"><div class="card" style="height:600px;padding:0"><div id="news-box" style="height:100%"></div></div></section>
<section id="view-Kurse" class="view-section">
  <div class="card" style="border-radius:18px;overflow:hidden;padding:0">
    <div style="padding:20px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:12px"><span style="font-size:1.5rem">&#x1F393;</span><h3 style="margin:0;font-weight:800">Kurse</h3></div>
      <button id="btn-add-course" class="btn-icon hidden" style="padding:8px 16px;font-size:1rem;background:var(--gradient);color:#fff;border:none;border-radius:10px;font-weight:700;display:flex;align-items:center;gap:6px" onclick="openCreateCourse()" title="Neuer Kurs">&#x2795; Kurs</button>
    </div>
    <div id="course-list" style="padding:16px"><div style="color:var(--text-sub);text-align:center;padding:30px">Lade Kurse...</div></div>
  </div>
  <div id="course-detail-area" class="hidden">
    <div class="card" style="border-radius:18px;overflow:hidden;padding:0">
      <div style="padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
        <button onclick="backToCourseList()" style="background:rgba(255,255,255,.08);border:none;color:var(--text-main);cursor:pointer;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:.2s" onmouseover="this.style.background='rgba(255,255,255,.15)'" onmouseout="this.style.background='rgba(255,255,255,.08)'">&#x276E;</button>
        <div style="flex:1"><h3 id="course-detail-title" style="margin:0;font-weight:800">Kurs</h3><p id="course-detail-desc" style="color:var(--text-sub);font-size:.85rem;margin:4px 0 0"></p></div>
      </div>
      <div id="course-modules-list" style="padding:16px"></div>
      <div id="course-reset-area" style="padding:0 16px 16px;text-align:center">
        <button onclick="resetCourseProgress()" style="background:none;border:1px solid var(--danger);color:var(--danger);border-radius:10px;padding:10px 20px;cursor:pointer;font-size:.85rem;font-weight:600;transition:.2s;width:100%" onmouseover="this.style.background='rgba(255,82,82,.1)'" onmouseout="this.style.background='none'">&#x1F504; Kurs zuruecksetzen</button>
      </div>
    </div>
  </div>
</section>
<section id="view-Einstellungen" class="view-section">
  <div class="card">
    <h3>App Einstellungen</h3>
    <div class="settings-list-item" style="flex-direction:column;align-items:stretch;gap:8px"><span style="font-weight:700">Design</span><div style="display:flex;gap:6px;flex-wrap:wrap" id="theme-selector"><button class="filter-pill active" onclick="setTheme('dark')" data-theme="dark">Dark</button><button class="filter-pill" onclick="setTheme('light')" data-theme="light">Light</button><button class="filter-pill" onclick="setTheme('neon')" data-theme="neon">Neon</button><button class="filter-pill" onclick="setTheme('black')" data-theme="black">Black</button><button class="filter-pill" onclick="setTheme('grey')" data-theme="grey">Grey</button><button class="filter-pill" onclick="setTheme('scifi')" data-theme="scifi">Sci-Fi</button></div></div>
    <div class="settings-list-item"><span>Coach Feedback erlauben</span><label class="switch"><input type="checkbox" id="feedback-toggle" onchange="toggleFeedback(this.checked)" checked><span class="slider round"></span></label></div>
    <div class="settings-list-item"><span>Statistik sichtbar fuer andere</span><label class="switch"><input type="checkbox" id="stats-visible-toggle" onchange="toggleStatsVisible(this.checked)" checked><span class="slider round"></span></label></div>
    <div class="settings-list-item"><span>News-Countdown auf Dashboard</span><label class="switch"><input type="checkbox" id="dashboard-news-toggle" onchange="toggleDashboardNews(this.checked)" checked><span class="slider round"></span></label></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:30px;border-top:1px solid var(--border);padding-top:20px">
      <h3 style="margin:0">Journal Verwaltung</h3>
      <button class="btn-icon" style="padding:8px 12px;font-size:1.3rem;background:var(--accent);color:#000;border:none" onclick="openCreateJournal()" title="Neues Journal">&#x2795;</button>
    </div>
    <div id="settings-journal-list" style="margin-top:15px"></div>
    <div style="margin-top:30px;border-top:1px solid var(--border);padding-top:20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><h3 style="margin:0">Profil</h3></div>
      <div id="settings-profile-preview" style="display:flex;align-items:center;gap:15px;background:var(--cell-bg);border:1px solid var(--border);border-radius:12px;padding:15px;cursor:pointer" onclick="openProfileModal()">
        <div id="settings-prof-avatar" style="width:50px;height:50px;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;flex-shrink:0">U</div>
        <div style="flex-grow:1"><div id="settings-prof-name" style="font-weight:700">User</div><div id="settings-prof-email" style="color:var(--text-sub);font-size:.85rem"></div></div>
        <span style="color:var(--text-sub);font-size:1.2rem">&#x276F;</span>
      </div>
    </div>
    <div id="admin-panel" class="hidden" style="margin-top:40px;border-top:1px solid var(--border);padding-top:20px">
      <h3 style="color:var(--accent)">Feedback Inbox</h3>
      <div id="adm-feedback-inbox" style="margin-bottom:30px">Lade...</div>
      <h3 style="color:var(--accent)">Mitglieder Uebersicht</h3>
      <div style="margin-bottom:15px"><input id="admMemberSearch" placeholder="Mitglied suchen (Name oder Email)..." style="margin-bottom:0" oninput="filterAdmMembers()"></div>
      <div id="admList" style="background:var(--cell-bg);border-radius:8px;padding:10px;border:1px solid var(--border)"></div>
      <h3 style="color:var(--accent);margin-top:30px">Upgrade Anfragen</h3>
      <div id="adm-upgrade-requests" style="background:var(--cell-bg);border-radius:8px;padding:10px;border:1px solid var(--border);margin-bottom:30px"><div style="color:var(--text-sub);font-size:.85rem;padding:5px">Keine Anfragen.</div></div>
      <h3 style="color:var(--accent);margin-top:30px">Coach Verwaltung</h3>
      <p style="font-size:.8rem;color:var(--text-sub)">Coaches koennen Feedback geben und in Pro Signal posten.</p>
      <div style="display:flex;gap:10px;margin-bottom:15px"><input id="coachEmail" placeholder="Neuer Coach (Email)" style="margin-bottom:0"><button onclick="coachAdd()" class="btn-primary" style="width:100px;padding:0">Add</button></div>
      <div id="coachList" style="background:var(--cell-bg);border-radius:8px;padding:10px;border:1px solid var(--border)"></div>
      <div class="admin-zentrale">
        <h3 style="color:var(--accent)">Admin Zentrale</h3>
        <div class="admin-grid">
          <div class="admin-col"><h4>Test-Phase User</h4><div id="admin-test-list"><div style="color:var(--text-sub);font-size:.85rem;padding:5px">Lade...</div></div></div>
          <div class="admin-col"><h4>Pro User</h4><div id="admin-pro-list"><div style="color:var(--text-sub);font-size:.85rem;padding:5px">Lade...</div></div></div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="view-KI" class="view-section">
  <div style="margin-bottom:20px"><h2 style="margin:0">&#x1F916; KI-Assistent</h2></div>
  <div class="ki-tab-bar">
    <button class="ki-tab active" onclick="switchKITab('chat')" id="ki-tab-chat">&#x1F4AC; Chat</button>
    <button class="ki-tab" onclick="switchKITab('analyse')" id="ki-tab-analyse">&#x1F4CA; Trade-Analyse</button>
    <button class="ki-tab" onclick="switchKITab('chart')" id="ki-tab-chart">&#x1F4C8; Chart-Analyse</button>
  </div>
  <!-- Chat -->
  <div id="ki-panel-chat" class="card">
    <div class="ki-messages" id="ki-messages">
      <div class="ki-msg ai">Hallo! Ich bin dein KI-Trading-Assistent. Ich kenne deine Trades und kann dir helfen, Muster zu erkennen, Fehler zu vermeiden und besser zu werden. Was mÃ¶chtest du wissen?</div>
    </div>
    <div class="ki-input-row">
      <textarea id="ki-chat-input" placeholder="Frag mich etwas zu deinen Trades... (Shift+Enter = neue Zeile)" style="resize:none;min-height:110px;max-height:260px;overflow-y:auto" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendKIChat()}" oninput="this.style.height='110px';this.style.height=Math.min(this.scrollHeight,260)+'px'"></textarea>
      <div class="ki-input-actions"><button class="ki-send-btn" onclick="sendKIChat()">&#x27A4; Senden</button></div>
    </div>
  </div>
  <!-- Analyse -->
  <div id="ki-panel-analyse" class="card hidden">
    <h4 style="margin-top:0">Trade-Analyse</h4>
    <p style="color:var(--text-sub);font-size:.9rem;margin-bottom:16px">W&#228;hle einen einzelnen Trade aus oder analysiere alle Trades auf einmal.</p>
    <div style="margin-bottom:16px">
      <label style="font-size:.8rem;font-weight:700;color:var(--text-sub);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px">Trade ausw&#228;hlen</label>
      <select id="ki-trade-select" style="width:100%;padding:12px;background:var(--cell-bg);border:1px solid var(--border);color:var(--text-main);border-radius:10px;font-size:.95rem;cursor:pointer;box-sizing:border-box">
        <option value="">&#x1F4CA; Alle Trades (Portfolio-Analyse)</option>
      </select>
    </div>
    <button class="btn-primary" onclick="analyzeMyTrades()" style="width:100%" id="ki-analyse-btn">&#x1F4CA; Jetzt analysieren</button>
    <div id="ki-analyse-result"></div>
  </div>
  <!-- Chart -->
  <div id="ki-panel-chart" class="card hidden">
    <h4 style="margin-top:0">Chart-Analyse</h4>
    <p style="color:var(--text-sub);font-size:.9rem;margin-bottom:12px">Lade einen Chart-Screenshot hoch oder fÃ¼ge ihn aus der Zwischenablage ein â€” die KI erkennt Muster, Trends und mÃ¶gliche Setups.</p>
    <div class="ki-chart-drop" onclick="document.getElementById('ki-chart-file').click()">
      <div style="font-size:2.5rem;margin-bottom:8px">&#x1F4C8;</div>
      <div style="font-weight:700;margin-bottom:4px">Chart hochladen</div>
      <div style="font-size:.85rem;color:var(--text-sub)">JPG, PNG, WebP &mdash; klicken, reinziehen oder <b>Strg+V</b></div>
    </div>
    <button onclick="pasteFromClipboard()" style="width:100%;margin-top:8px;padding:11px;border-radius:10px;border:1px solid var(--border);background:var(--cell-bg);color:var(--text-sub);font-weight:600;font-size:.9rem;cursor:pointer;transition:.2s" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--text)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-sub)'">&#x1F4CB; Aus Zwischenablage einfÃ¼gen</button>
    <input type="file" id="ki-chart-file" accept="image/*" style="display:none" onchange="handleChartUpload(event)">
    <div id="ki-chart-preview" style="margin-top:14px"></div>
    <div id="ki-chart-result"></div>
  </div>
</section>
</div><script>
const FC={apiKey:"AIzaSyDCgM4h6Rgk-r95Qy7BlT1S4QQI-4IDqAQ",authDomain:"trading-journal-acc.firebaseapp.com",projectId:"trading-journal-acc",storageBucket:"trading-journal-acc.firebasestorage.app",messagingSenderId:"68601000570",appId:"1:68601000570:web:87d3ebd5e86416403e41c3"};
firebase.initializeApp(FC);
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();
let trades=[],journals=[],chartInstances={},dayChart=null,assetCI=null,weekCI=null,hourCI=null,adminCI=null;
let calDate=new Date(),privacyMode=false,activeJournal=null,editingJournalId=null;
let currentUserName="User",isAdmin=false,isCoach=false,userStatus="test";
let showDashboardNews=localStorage.getItem('dashboardNews')!=='false';
const ADMIN_EMAIL="leon.luca.lauterbach@gmail.com";
let notifications=[],upgradeRequests=[];
let jFilters={},jCustomDates={},shareTradeId=null,shareType=null,msgDelId=null,configJId=null;
let iuTrades=[],iuJournals=[],curDetailId=null,iuFeedbackAllowed=true;
let isChatActive=false,lastMsgCount=0,curChatChannel=null,unsubChat=null;
const savedTheme=localStorage.getItem("tradeTheme")||"dark";
if(savedTheme==="light")document.body.classList.add("light-mode");
else if(savedTheme==="neon")document.body.classList.add("neon-mode");
else if(savedTheme==="black")document.body.classList.add("black-mode");
else if(savedTheme==="grey")document.body.classList.add("grey-mode");
else if(savedTheme==="scifi")document.body.classList.add("scifi-mode");
document.querySelectorAll("#theme-selector .filter-pill").forEach(b=>{b.classList.toggle("active",b.dataset.theme===savedTheme);});

function switchAuthTab(t){
  document.querySelectorAll(".auth-tab").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".auth-form").forEach(x=>x.classList.remove("active"));
  const vs=document.getElementById("verify-screen");if(vs)vs.classList.remove("active");
  if(t==="login"){document.querySelectorAll(".auth-tab")[0].classList.add("active");document.getElementById("login-form").classList.add("active");}
  else{document.querySelectorAll(".auth-tab")[1].classList.add("active");document.getElementById("register-form").classList.add("active");}
  document.getElementById("auth-error").style.display="none";
}
function showAuthErr(m){const e=document.getElementById("auth-error");e.textContent=m;e.style.display="block";}
async function loginEmail(){
  const email=document.getElementById("login-email").value.trim(),pass=document.getElementById("login-password").value;
  if(!email||!pass){showAuthErr("Bitte E-Mail und Passwort eingeben.");return;}
  try{
    const uc=await auth.signInWithEmailAndPassword(email,pass);
    if(!uc.user.emailVerified){
      await auth.signOut();
      showAuthErr("Bitte best\u00e4tige zuerst deine E-Mail Adresse. Pr\u00fcfe dein Postfach.");
      return;
    }
  }
  catch(e){if(e.code==="auth/user-not-found")showAuthErr("Kein Konto mit dieser E-Mail gefunden.");else if(e.code==="auth/wrong-password")showAuthErr("Falsches Passwort.");else showAuthErr("Login fehlgeschlagen: "+e.message);}
}
async function registerEmail(){
  const name=document.getElementById("reg-name").value.trim(),email=document.getElementById("reg-email").value.trim(),pass=document.getElementById("reg-pass").value,pass2=document.getElementById("reg-pass2").value;
  if(!name||!email||!pass){showAuthErr("Bitte alle Felder ausfuellen.");return;}
  if(pass!==pass2){showAuthErr("Passwoerter stimmen nicht ueberein.");return;}
  if(pass.length<6){showAuthErr("Passwort muss mindestens 6 Zeichen lang sein.");return;}
  try{
    const uc=await auth.createUserWithEmailAndPassword(email,pass);
    await uc.user.updateProfile({displayName:name});
    await uc.user.sendEmailVerification();
    await db.collection("users").doc(uc.user.uid).set({email:email.toLowerCase(),displayName:name,photoURL:"",status:"test",allowCoachFeedback:true,statsVisible:true,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    await auth.signOut();
    showVerifyScreen(email);
  }catch(e){if(e.code==="auth/email-already-in-use")showAuthErr("Diese E-Mail ist bereits registriert.");else showAuthErr("Registrierung fehlgeschlagen: "+e.message);}
}
function showVerifyScreen(email){
  document.getElementById("auth-error").style.display="none";
  document.querySelectorAll(".auth-form").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".auth-tab").forEach(x=>x.classList.remove("active"));
  let vs=document.getElementById("verify-screen");
  if(!vs){vs=document.createElement("div");vs.id="verify-screen";vs.className="auth-form";document.querySelector(".auth-container").appendChild(vs);}
  vs.classList.add("active");
  vs.innerHTML=`<div style="text-align:center;padding:10px 0"><div style="font-size:3rem;margin-bottom:15px">&#x2709;&#xFE0F;</div><h3 style="margin:0 0 10px;font-size:1.2rem;font-weight:800;color:var(--text-main)">E-Mail best&auml;tigen</h3><p style="color:var(--text-sub);font-size:.9rem;line-height:1.5;margin-bottom:20px">Wir haben eine Best&auml;tigungs-Mail an<br><b style="color:var(--accent)">${email}</b><br>gesendet. Bitte klicke auf den Link in der E-Mail.</p><button onclick="switchAuthTab('login')" class="btn-primary" style="margin-bottom:12px;width:100%">ZUM LOGIN</button><button onclick="resendVerification('${email}')" class="btn-primary" style="background:transparent;border:1px solid var(--border);color:var(--text-sub);width:100%">ERNEUT SENDEN</button></div>`;
}
async function resendVerification(email){
  try{
    const pass=prompt("Bitte Passwort eingeben um die E-Mail erneut zu senden:");
    if(!pass)return;
    const uc=await auth.signInWithEmailAndPassword(email,pass);
    await uc.user.sendEmailVerification();
    await auth.signOut();
    alert("Best\u00e4tigungs-Mail erneut gesendet!");
  }catch(e){alert("Fehler: "+e.message);}
}
async function loginGoogle(){try{await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}catch(e){showAuthErr("Google Login fehlgeschlagen: "+e.message);}}
auth.onAuthStateChanged(async(user)=>{
  if(user){
    if(!user.emailVerified&&user.providerData[0].providerId==="password"){await auth.signOut();return;}
    const email=user.email.toLowerCase().trim();
    const uRef=db.collection("users").doc(user.uid);const uDoc=await uRef.get();
    if(!uDoc.exists){await uRef.set({email,displayName:user.displayName||"Trader",photoURL:user.photoURL||"",status:"test",allowCoachFeedback:true,statsVisible:true,createdAt:firebase.firestore.FieldValue.serverTimestamp()});userStatus="test";}
    else{const ud=uDoc.data();userStatus=ud.status||"test";if(userStatus==="banned"){alert("Dein Account wurde gesperrt.");await auth.signOut();location.reload();return;}document.getElementById("feedback-toggle").checked=ud.allowCoachFeedback!==false;document.getElementById("stats-visible-toggle").checked=ud.statsVisible!==false;}
    const cs=await db.collection("coaches").where("email","==",email).get();isCoach=!cs.empty;
    if(email===ADMIN_EMAIL){isAdmin=true;userStatus="pro";document.getElementById("admin-panel").classList.remove("hidden");document.getElementById("btn-Feedback").style.display="none";admLoad();loadAdminZentrale();finishLogin(user);}
    else if(isCoach){isAdmin=true;userStatus="pro";document.getElementById("btn-Feedback").style.display="none";finishLogin(user);}
    else{finishLogin(user);}
  }
});
async function finishLogin(user){
  const fn=user.displayName?user.displayName.split(" ")[0]:user.email.split("@")[0];
  currentUserName=fn.charAt(0).toUpperCase()+fn.slice(1);
  document.getElementById("user-greeting-name").innerText=currentUserName;
  document.getElementById("auth-overlay").classList.add("hidden");
  document.getElementById("app-content").classList.remove("hidden");
  document.getElementById("main-header").classList.remove("hidden");
  const spn=document.getElementById("settings-prof-name");if(spn)spn.innerText=user.displayName||"User";
  const spe=document.getElementById("settings-prof-email");if(spe)spe.innerText=user.email||"";
  const spa=document.getElementById("settings-prof-avatar");if(spa)spa.innerText=(user.displayName||"U").charAt(0).toUpperCase();
  const dnt=document.getElementById("dashboard-news-toggle");if(dnt)dnt.checked=showDashboardNews;
  applyRestrictions();await loadData();renderChatLobby();loadContactsAndRequests();setupGlobalNotifications();updateNotifDot();
}
function applyRestrictions(){
  ["Chat","TradingView","Lot-Rechner","News","Kurse"].forEach(v=>{
    const l=document.getElementById("lock-"+v);if(l){if(userStatus==="test")l.classList.remove("hidden");else l.classList.add("hidden");}
  });
}
function navGuard(v){
  if(userStatus==="test"&&["Chat","TradingView","Lot-Rechner","News","Kurse"].includes(v)){document.getElementById("popup-overlay").classList.add("open");document.getElementById("navguard-modal").classList.remove("hidden");return;}
  showView(v);
}
async function loadData(){
  if(!auth.currentUser)return;
  const jSnap=await db.collection("journals").where("userId","==",auth.currentUser.uid).get();
  journals=jSnap.docs.map(d=>({id:d.id,...d.data()}));
  if(!journals.length){await db.collection("journals").add({userId:auth.currentUser.uid,name:"Main",startCap:0,hidden:false});const ns=await db.collection("journals").where("userId","==",auth.currentUser.uid).get();journals=ns.docs.map(d=>({id:d.id,...d.data()}));}
  if(!activeJournal&&journals.length)activeJournal=journals[0].name;
  const tSnap=await db.collection("trades").where("userId","==",auth.currentUser.uid).get();
  trades=tSnap.docs.map(d=>({id:d.id,...d.data()}));
  populateSelectors();renderDashboard();
  if(document.getElementById("view-Historie").classList.contains("active"))renderHistory();
  if(document.getElementById("view-Statistik").classList.contains("active"))renderStatistics();
}
function populateSelectors(){
  const ns=document.getElementById("navJournalSelect");ns.innerHTML=journals.map(j=>`<option value="${j.name}">${j.name}</option>`).join("");if(activeJournal)ns.value=activeJournal;
  const cs=document.getElementById("inpJournalSelect");cs.innerHTML=journals.map(j=>`<option value="${j.name}">${j.name}</option>`).join("");if(activeJournal)cs.value=activeJournal;
}
function changeActiveJournal(val){activeJournal=val;const cs=document.getElementById("inpJournalSelect");if(cs)cs.value=activeJournal;renderDashboard();if(document.getElementById("view-Kalender").classList.contains("active"))renderCalendar();if(document.getElementById("view-Statistik").classList.contains("active"))renderStatistics();if(document.getElementById("view-Historie").classList.contains("active"))renderHistory();document.getElementById("navDrawer").classList.remove("open");document.getElementById("menu-overlay").classList.remove("open");}
function renderUpgradeBanner(){
  const area=document.getElementById("upgrade-banner-area");
  if(userStatus==="test"){const tc=trades.length;area.innerHTML=`<div class="upgrade-banner"><h3>Test-Phase aktiv</h3><p>Trades: <b>${tc}/5</b> | Journals: <b>${journals.length}/1</b><br>Chat, Charts, Lot Rechner, News &amp; Kurs gesperrt</p><button class="btn-primary" style="width:auto;padding:10px 25px;display:inline-block" onclick="requestUpgrade()">Upgrade anfragen</button></div>`;}
  else area.innerHTML="";
}
function renderDashboard(){
  renderUpgradeBanner();renderNotificationsArea();loadDashboardNews();
  const container=document.getElementById("dashboard-journals-list");container.innerHTML="";Object.values(chartInstances).forEach(c=>c.destroy());chartInstances={};
  /* Schnelluebersicht */
  const allClosed=trades.filter(t=>t.status==="Geschlossen");
  const last3=allClosed.sort((a,b)=>new Date(b.closedAt||b.date)-new Date(a.closedAt||a.date)).slice(0,3);
  const l3html=last3.length?last3.map(t=>{const pc2=t.pnl>=0?"var(--success)":"var(--danger)";const d=t.closedAt?new Date(t.closedAt):new Date(t.date);const ds=d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"});const ts2=d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});const jn=t.journal||"Main";return`<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:.85rem"><div style="display:flex;flex-direction:column;gap:2px"><span style="font-weight:700;color:var(--accent)">${t.asset}</span><span style="font-size:.65rem;color:var(--text-sub)">${jn}</span></div><span style="color:var(--text-sub);font-size:.75rem">${ds} ${ts2}</span><span style="font-weight:800;color:${pc2}">${t.pnl>=0?"+":""}${t.pnl.toFixed(2)} â‚¬</span></div>`;}).join(""):`<p style="color:var(--text-sub);font-size:.8rem;text-align:center">Noch keine Trades.</p>`;
  const nowDt=new Date();const dateLine=nowDt.toLocaleDateString("de-DE",{weekday:"long",day:"2-digit",month:"long",year:"numeric"});const timeLine=nowDt.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
  container.innerHTML+=`<div class="card" style="margin-bottom:20px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><span style="font-size:.8rem;color:var(--text-sub)">${dateLine}, ${timeLine}</span><span style="font-weight:800;font-size:1rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-sub)">Heute</span></div><div style="font-size:.8rem;font-weight:700;color:var(--text-sub);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">Letzte Trades</div>${l3html}</div>`;
  journals.forEach(journal=>{
    if(journal.hidden)return;
    const tf=jFilters[journal.id]||"GESAMT";const now=new Date();let sd=null,ed=null;
    if(tf==="HEUTE"){sd=new Date();sd.setHours(0,0,0,0);ed=new Date();ed.setHours(23,59,59,999);}
    else if(tf==="GESTERN"){sd=new Date();sd.setDate(sd.getDate()-1);sd.setHours(0,0,0,0);ed=new Date();ed.setDate(ed.getDate()-1);ed.setHours(23,59,59,999);}
    else if(tf==="WOCHE")sd=new Date(now.getTime()-7*864e5);
    else if(tf==="MONAT")sd=new Date(now.getTime()-30*864e5);
    else if(tf==="JAHR")sd=new Date(now.getTime()-365*864e5);
    else if(tf==="ZEITRAUM"){const c=jCustomDates[journal.id];if(c){sd=new Date(c.start);sd.setHours(0,0,0,0);ed=new Date(c.end);ed.setHours(23,59,59,999);}}
    const jt=trades.filter(t=>(t.journal||"Main")===journal.name);
    const ca=jt.filter(t=>t.status==="Geschlossen").sort((a,b)=>new Date(a.date)-new Date(b.date));
    const open=jt.filter(t=>t.status==="Aktiv");
    const sc=parseFloat(journal.startCap)||0;let bb=sc,tip=[];
    if(sd){const tb=ca.filter(t=>new Date(t.date)<sd);bb+=tb.reduce((a,t)=>a+t.pnl,0);tip=ca.filter(t=>{const d=new Date(t.date);if(ed)return d>=sd&&d<=ed;return d>=sd;});}else tip=ca;
    let pnl=tip.reduce((a,t)=>a+t.pnl,0),wins=tip.filter(t=>t.pnl>0).length;
    const wr=tip.length?((wins/tip.length)*100).toFixed(0):0;
    let rb=bb;const ec=[bb];tip.forEach(t=>{rb+=t.pnl;ec.push(rb);});
    const pc=pnl>=0?"var(--success)":"var(--danger)";const cid="chart-"+journal.id;
    let wh="";const ts=new Date().toDateString();
    const tp=ca.filter(t=>new Date(t.date).toDateString()===ts).reduce((a,t)=>a+t.pnl,0);
    if(journal.maxDD&&parseFloat(journal.maxDD)>0){const lim=parseFloat(journal.maxDD);let thr=lim;if(journal.ddType==="percent"){const tb2=sc+ca.reduce((a,b)=>a+b.pnl,0);thr=Math.max(tb2,0)*(lim/100);}if(tp<-thr)wh=`<div class="loss-warning"><span>Tagesverlust ueberschritten!</span></div>`;}
    let oth=`<p style="color:var(--text-sub);font-style:italic;font-size:.8rem;text-align:center;padding-top:20px">Keine offenen Trades.</p>`;
    if(open.length)oth=open.map(t=>{const ts=encodeURIComponent(JSON.stringify(t));const is=encodeURIComponent(t.imgSetup||"");return`<div class="ot-list-item"><span style="font-weight:700;color:var(--accent)">${t.asset}</span><div style="display:flex;gap:4px"><button class="btn-icon" onclick="openSignalDetail('${ts}','${is}')" title="Details">&#x1F50D;</button><button class="btn-icon" onclick="editTrade('${t.id}',true)" title="Schliessen">&#x2716;</button></div></div>`;}).join("");
    const filters=["HEUTE","GESTERN","WOCHE","MONAT","JAHR","GESAMT","ZEITRAUM"];
    const fh=filters.map(f=>`<button class="filter-pill ${tf===f?"active":""}" onclick="setJournalFilter('${journal.id}','${f}')">${f}</button>`).join("");
    container.innerHTML+=`<div class="journal-full-card"><div class="jfc-header"><div class="jfc-title">${journal.name}</div></div><div class="card-filters">${fh}</div>${wh}<div class="jfc-body-grid"><div class="jfc-chart-area"><canvas id="${cid}"></canvas></div><div class="jfc-sidebar"><div class="jfc-stats-row"><div class="stat-box"><span class="stat-label">PnL (${tf})</span><span class="stat-value sensitive" style="color:${pc}">${pnl.toFixed(2)} â‚¬</span></div><div class="stat-box"><span class="stat-label">Winrate</span><span class="stat-value">${wr}%</span></div></div><div class="open-trades-box"><div style="font-size:.8rem;font-weight:700;color:var(--text-sub);margin-bottom:8px">OFFENE TRADES</div><div style="flex-grow:1">${oth}</div></div></div></div></div>`;
    setTimeout(()=>{const c=document.getElementById(cid);if(!c)return;const ctx2=c.getContext("2d");const grd=ctx2.createLinearGradient(0,0,c.width,0);grd.addColorStop(0,"#6c63ff");grd.addColorStop(1,"#e040fb");const grdFill=ctx2.createLinearGradient(0,0,0,c.height);grdFill.addColorStop(0,"rgba(108,99,255,.2)");grdFill.addColorStop(1,"rgba(224,64,251,.02)");chartInstances[cid]=new Chart(ctx2,{type:"line",data:{labels:ec.map(()=>""),datasets:[{data:ec,borderColor:grd,borderWidth:2.5,pointRadius:0,tension:.3,fill:true,backgroundColor:grdFill}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:"rgba(255,255,255,.05)"}}}}});},50);
  });
}
async function renderNotificationsArea(){
  const area=document.getElementById("dashboard-notification-area");area.innerHTML="";updateNotifDot();
}
async function updateChatBadge(){
  const badge=document.getElementById("chat-unread-badge");if(!badge)return;
  try{
    let totalUnread=0;
    const channels=["public","signals","pro_signal"];
    for(const ch of channels){const snap=await db.collection("chat").where("channel","==",ch).get();const read=getChannelReadCount(ch);totalUnread+=Math.max(0,snap.size-read);}
    try{const gs=await db.collection("groups").get();for(const gd of gs.docs){const g=gd.data();if(g.members&&g.members.includes(auth.currentUser.uid)){const chId="group_"+gd.id;const snap=await db.collection("chat").where("channel","==",chId).get();const read=getChannelReadCount(chId);totalUnread+=Math.max(0,snap.size-read);}}}catch(e){}
    if(totalUnread>0&&!isChatActive){badge.style.display="inline-block";badge.innerText=totalUnread>99?"99+":totalUnread;}
    else{badge.style.display="none";}
  }catch(e){badge.style.display="none";}
}
function setupGlobalNotifications(){
  db.collection("chat").orderBy("timestamp","desc").limit(1).onSnapshot(snap=>{
    if(!snap.empty){const lid=snap.docs[0].id;const lk=localStorage.getItem("lastMsgId");if(lid!==lk&&!isChatActive){lastMsgCount++;if(document.getElementById("view-Uebersicht").classList.contains("active"))renderNotificationsArea();}localStorage.setItem("lastMsgId",lid);updateChatBadge();}
  });
}
function setJournalFilter(jid,tf){if(tf==="ZEITRAUM"){configJId=jid;document.getElementById("popup-overlay").classList.add("open");document.getElementById("date-range-modal").classList.remove("hidden");}else{jFilters[jid]=tf;renderDashboard();}}
function applyCustomDate(){const s=document.getElementById("custom-start").value,e=document.getElementById("custom-end").value;if(s&&e&&configJId){jFilters[configJId]="ZEITRAUM";jCustomDates[configJId]={start:s,end:e};renderDashboard();closePopup();}}
function renderStatistics(){
  if(!activeJournal)return;
  const sh=document.getElementById("stat-journal-hint");if(sh)sh.innerText="Journal: "+activeJournal;
  const tt=trades.filter(t=>(t.journal||"Main")===activeJournal&&t.status==="Geschlossen");
  const am={};tt.forEach(t=>{const a=(t.asset||"").toUpperCase().trim();if(!a)return;if(!am[a])am[a]=0;am[a]+=t.pnl;});const sa=Object.keys(am).sort((a,b)=>am[b]-am[a]);
  const dm={0:0,1:0,2:0,3:0,4:0,5:0,6:0};tt.forEach(t=>{dm[new Date(t.date).getDay()]+=t.pnl;});
  const hm=new Array(24).fill(0);tt.forEach(t=>{hm[new Date(t.date).getHours()]+=t.pnl;});
  const cA=document.getElementById("assetChart").getContext("2d");if(assetCI)assetCI.destroy();
  assetCI=new Chart(cA,{type:"bar",data:{labels:sa,datasets:[{data:sa.map(a=>am[a]),backgroundColor:sa.map(a=>am[a]>=0?"rgba(48,209,88,.5)":"rgba(255,69,58,.5)"),borderColor:sa.map(a=>am[a]>=0?"#00c853":"#ff453a"),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{grid:{color:"#222"}}},plugins:{legend:{display:false}}}});
  const cW=document.getElementById("weekdayChart").getContext("2d");if(weekCI)weekCI.destroy();
  weekCI=new Chart(cW,{type:"bar",data:{labels:["So","Mo","Di","Mi","Do","Fr","Sa"],datasets:[{data:[0,1,2,3,4,5,6].map(d=>dm[d]),backgroundColor:[0,1,2,3,4,5,6].map(d=>dm[d]>=0?"rgba(48,209,88,.5)":"rgba(255,69,58,.5)"),borderColor:[0,1,2,3,4,5,6].map(d=>dm[d]>=0?"#00c853":"#ff453a"),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{grid:{color:"#222"}}},plugins:{legend:{display:false}}}});
  const cH=document.getElementById("hourChart").getContext("2d");if(hourCI)hourCI.destroy();
  hourCI=new Chart(cH,{type:"bar",data:{labels:hm.map((_,i)=>`${i}:00`),datasets:[{data:hm,backgroundColor:hm.map(v=>v>=0?"rgba(48,209,88,.5)":"rgba(255,69,58,.5)"),borderColor:hm.map(v=>v>=0?"#00c853":"#ff453a"),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{grid:{color:"#222"}}},plugins:{legend:{display:false}}}});
}
function openAddContactModal(){document.getElementById("popup-overlay").classList.add("open");document.getElementById("add-contact-modal").classList.remove("hidden");}
async function searchUsers(){
  const term=document.getElementById("contact-search-input").value.trim().toLowerCase();const rd=document.getElementById("contact-search-results");
  if(term.length<3){rd.innerHTML="<p style='color:var(--text-sub)'>Mindestens 3 Buchstaben...</p>";return;}
  try{const s=await db.collection("users").limit(50).get();const hits=s.docs.filter(d=>{const x=d.data();return x.displayName&&x.displayName.toLowerCase().includes(term)&&x.email!==auth.currentUser.email;});
  if(!hits.length){rd.innerHTML="<p style='color:var(--text-sub)'>Keine User gefunden.</p>";return;}
  rd.innerHTML=hits.map(d=>`<div class="search-result-item"><span style="font-weight:700;color:#fff">${d.data().displayName}</span><button class="btn-icon" onclick="sendContactReq('${d.id}')" title="Hinzufuegen">&#x2795;</button></div>`).join("");}catch(e){rd.innerHTML="<p style='color:var(--danger)'>Fehler.</p>";}
}
async function sendContactReq(tid){
  const ex=await db.collection("friendships").where("users","array-contains",auth.currentUser.uid).get();let exists=false;ex.forEach(d=>{if(d.data().users.includes(tid))exists=true;});
  if(exists){alert("Anfrage bereits gesendet.");return;}
  await db.collection("friendships").add({users:[auth.currentUser.uid,tid],requesterId:auth.currentUser.uid,receiverId:tid,status:isAdmin?"accepted":"pending",timestamp:firebase.firestore.FieldValue.serverTimestamp()});
  alert(isAdmin?"Kontakt hinzugefuegt.":"Anfrage gesendet.");closePopup();loadContactsAndRequests();
}
function loadContactsAndRequests(){
  const ra=document.getElementById("friend-requests-area"),la=document.getElementById("chat-user-list");ra.innerHTML="";la.innerHTML="Lade...";
  db.collection("friendships").where("users","array-contains",auth.currentUser.uid).onSnapshot(async s=>{
    ra.innerHTML="";la.innerHTML="";if(s.empty){la.innerHTML="<div style='padding:15px;color:var(--text-sub)'>Keine Kontakte.</div>";return;}
    for(const doc of s.docs){
      const d=doc.data();const ou=d.users.find(u=>u!==auth.currentUser.uid);let on="Unbekannt",oe="";
      try{const ud=await db.collection("users").doc(ou).get();if(ud.exists){on=ud.data().displayName;oe=ud.data().email;}}catch(e){}
      if(d.status==="pending"&&d.receiverId===auth.currentUser.uid)ra.innerHTML+=`<div class="cl-item" style="background:rgba(187,134,252,.1)"><div class="cl-avatar" style="background:var(--accent)">?</div><div class="cl-info"><div class="cl-name">${on}</div><div class="cl-last">Moechte chatten</div></div><div class="cl-actions"><button title="Annehmen" onclick="acceptReq('${doc.id}')">&#x2714;</button><button title="Ablehnen" onclick="declineReq('${doc.id}')">&#x2716;</button></div></div>`;
      else if(d.status==="accepted"){const nm=oe===ADMIN_EMAIL?`${on} <span class="coach-tag">Coach</span>`:on;const chatId=getChatId(auth.currentUser.uid,ou);const pins=getPinnedChats();const isPinned=pins.includes(chatId);const target=isPinned?document.getElementById("chat-pinned-area"):la;const badgeId="badge-pm-"+ou;target.innerHTML+=`<div class="cl-item"><div class="cl-avatar" style="background:#555" onclick="enterPrivateChat('${ou}','${on}')">${on.charAt(0).toUpperCase()}</div><div class="cl-info" onclick="enterPrivateChat('${ou}','${on}')"><div class="cl-name">${nm} <span id="${badgeId}"></span></div><div class="cl-last">Privater Chat</div></div><div class="cl-actions"><button class="${isPinned?"pinned":""}" title="${isPinned?"Loesen":"Anpinnen"}" onclick="event.stopPropagation();togglePinChat('${chatId}')">&#x1F4CC;</button><button title="Chat loeschen" onclick="deletePrivateChat('${doc.id}',event)">&#x1F5D1;&#xFE0E;</button></div></div>`;loadChannelUnread(chatId,badgeId);}
    }
  });
}
async function acceptReq(id){await db.collection("friendships").doc(id).update({status:"accepted"});}
async function declineReq(id){await db.collection("friendships").doc(id).delete();}
function getChatId(a,b){return[a,b].sort().join("_");}
function enterPrivateChat(tu,tn){enterChat(getChatId(auth.currentUser.uid,tu),tn);}
function enterChat(ch,title){
  curChatChannel=ch;document.getElementById("chat-lobby").classList.add("hidden");document.getElementById("chat-room").classList.remove("hidden");document.getElementById("chat-room-title").innerText=title;
  const ia=document.getElementById("chat-input-area"),ro=document.getElementById("chat-read-only-msg");ia.classList.remove("hidden");ro.classList.add("hidden");
  if(ch==="signals"){ia.classList.add("hidden");ro.classList.remove("hidden");}else if(ch==="pro_signal"&&!isAdmin){ia.classList.add("hidden");ro.classList.remove("hidden");}
  updateMuteBtn();loadChat();
}
function getChannelReadCount(ch){return parseInt(localStorage.getItem("chatRead_"+ch)||"0");}
function setChannelReadCount(ch,count){localStorage.setItem("chatRead_"+ch,""+count);}
function renderUnreadBadge(count){
  if(count<=0)return"";
  return`<span style="background:var(--danger);color:#fff;font-size:.65rem;font-weight:800;padding:2px 6px;border-radius:10px;min-width:16px;text-align:center;display:inline-block;line-height:1.3">${count>99?"99+":count}</span>`;
}
async function loadChannelUnread(channelId,badgeElId){
  try{const snap=await db.collection("chat").where("channel","==",channelId).get();
  const total=snap.size;const read=getChannelReadCount(channelId);const unread=total-read;
  const el=document.getElementById(badgeElId);if(el)el.innerHTML=renderUnreadBadge(unread);
  }catch(e){}
}
function leaveChat(){curChatChannel=null;if(unsubChat)unsubChat();document.getElementById("chat-room").classList.add("hidden");document.getElementById("chat-lobby").classList.remove("hidden");renderChatLobby();loadContactsAndRequests();updateChatBadge();}
function getPinnedChats(){try{return JSON.parse(localStorage.getItem("pinnedChats")||"[]");}catch(e){return[];}}
function togglePinChat(chatId){let pins=getPinnedChats();if(pins.includes(chatId))pins=pins.filter(p=>p!==chatId);else pins.push(chatId);localStorage.setItem("pinnedChats",JSON.stringify(pins));renderChatLobby();loadContactsAndRequests();}
async function deletePrivateChat(friendshipId,e){
  if(e)e.stopPropagation();if(!confirm("Chat wirklich loeschen? Alle Nachrichten werden entfernt."))return;
  try{const fd=await db.collection("friendships").doc(friendshipId).get();
    if(fd.exists){const d=fd.data();const chatId=[...d.users].sort().join("_");
      const msgs=await db.collection("chat").where("channel","==",chatId).get();
      if(!msgs.empty){const batch=db.batch();msgs.docs.forEach(doc=>batch.delete(doc.ref));await batch.commit();}
    }
  }catch(e){}
  await db.collection("friendships").doc(friendshipId).delete();loadContactsAndRequests();
}
function renderChatLobby(){
  const channels=[{id:"public",name:"Public Chat",desc:"Allgemeiner Austausch",avatar:"&#x1F30D;",bg:"#2a9d8f"},{id:"signals",name:"Signale",desc:"Nur Trades",avatar:"&#x1F4E1;",bg:"#e9c46a",avatarColor:"#000"},{id:"pro_signal",name:"Pro Signal",desc:"Vom Coach",avatar:"&#x1F680;",bg:"#e76f51"}];
  const renderChannel=(c)=>`<div class="cl-item"><div class="cl-avatar" style="background:${c.bg}${c.avatarColor?";color:"+c.avatarColor:""}" onclick="enterChat('${c.id}','${c.name}')">${c.avatar}</div><div class="cl-info" onclick="enterChat('${c.id}','${c.name}')"><div class="cl-name">${c.name} <span id="badge-${c.id}"></span></div><div class="cl-last">${c.desc}</div></div></div>`;
  document.getElementById("chat-pinned-area").innerHTML=channels.map(renderChannel).join("");
  channels.forEach(c=>loadChannelUnread(c.id,"badge-"+c.id));
  loadCustomGroups();
}
async function loadCustomGroups(){
  const area=document.getElementById("chat-channels-area");area.innerHTML="";
  try{
    const s=await db.collection("chat_groups").get();
    const myGroups=s.docs.filter(d=>{const g=d.data();return g.members&&g.members.includes(auth.currentUser.uid);});
    if(!myGroups.length){area.innerHTML="";return;}
    area.innerHTML='<div style="padding:10px 15px;font-size:.8rem;color:var(--text-sub);font-weight:700;margin-top:10px">GRUPPEN</div>'+myGroups.map(doc=>{const g=doc.data();
      const safeName=(g.name||'Gruppe').replace(/'/g,'').replace(/"/g,'');
      const chId="group_"+doc.id;
      const isGroupAdmin=g.creatorId===auth.currentUser.uid||auth.currentUser.email.toLowerCase()===ADMIN_EMAIL;
      const delBtn=isGroupAdmin?`<div class="cl-actions"><button title="Gruppe loeschen" onclick="event.stopPropagation();deleteGroup('${doc.id}')">&#x1F5D1;&#xFE0E;</button></div>`:"";
      return`<div class="cl-item"><div class="cl-avatar" style="background:#555" onclick="enterChat('${chId}','${safeName}')">${g.avatar||"&#x1F465;"}</div><div class="cl-info" onclick="enterChat('${chId}','${safeName}')"><div class="cl-name">${g.name||"Gruppe"} <span id="badge-${chId}"></span></div><div class="cl-last">${g.members?g.members.length:0} Mitglieder</div></div>${delBtn}</div>`;
    }).join("");
    myGroups.forEach(doc=>loadChannelUnread("group_"+doc.id,"badge-group_"+doc.id));
  }catch(e){}
}
let cgInvitedMembers=[];
function openCreateGroupChat(){
  cgInvitedMembers=[];
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("create-group-modal").classList.remove("hidden");
  document.getElementById("cg-name").value="";document.getElementById("cg-member-search").value="";
  document.getElementById("cg-search-results").innerHTML="";renderCgInvited();
  document.getElementById("cg-name").focus();
}
async function searchGroupMembers(){
  const term=document.getElementById("cg-member-search").value.trim().toLowerCase();const rd=document.getElementById("cg-search-results");
  if(term.length<2){rd.innerHTML="";return;}
  try{const s=await db.collection("users").get();const results=s.docs.filter(d=>{const u=d.data();return d.id!==auth.currentUser.uid&&!cgInvitedMembers.some(m=>m.uid===d.id)&&((u.displayName||"").toLowerCase().includes(term)||(u.email||"").toLowerCase().includes(term));}).slice(0,5);
    rd.innerHTML=results.map(d=>{const u=d.data();return`<div class="search-result-item" style="margin-bottom:4px"><div><strong>${u.displayName||"User"}</strong><div style="font-size:.75rem;color:var(--text-sub)">${u.email}</div></div><button class="btn-small" onclick="addCgMember('${d.id}','${(u.displayName||"User").replace(/'/g,"")}')">Einladen</button></div>`;}).join("")||"<div style='color:var(--text-sub);font-size:.8rem;padding:5px'>Keine Ergebnisse</div>";
  }catch(e){rd.innerHTML="";}
}
function addCgMember(uid,name){cgInvitedMembers.push({uid,name});renderCgInvited();document.getElementById("cg-member-search").value="";document.getElementById("cg-search-results").innerHTML="";}
function removeCgMember(uid){cgInvitedMembers=cgInvitedMembers.filter(m=>m.uid!==uid);renderCgInvited();}
function renderCgInvited(){document.getElementById("cg-invited-list").innerHTML=cgInvitedMembers.map(m=>`<span style="background:var(--accent);color:#000;padding:3px 10px;border-radius:20px;font-size:.8rem;font-weight:700;display:inline-flex;align-items:center;gap:4px">${m.name}<button onclick="removeCgMember('${m.uid}')" style="background:none;border:none;cursor:pointer;font-size:.8rem;color:#000;padding:0;line-height:1">&#x2716;</button></span>`).join("");}
async function saveCreateGroupChat(){
  const name=document.getElementById("cg-name").value.trim();if(!name){alert("Bitte Gruppenname eingeben.");return;}
  const members=[auth.currentUser.uid,...cgInvitedMembers.map(m=>m.uid)];
  await db.collection("chat_groups").add({name,avatar:"&#x1F465;",creatorId:auth.currentUser.uid,members,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  cgInvitedMembers=[];closePopup();renderChatLobby();
}
async function deleteGroup(id){
  if(!confirm("Gruppe wirklich loeschen?"))return;
  await db.collection("chat_groups").doc(id).delete();
  renderChatLobby();
}

function loadChat(){
  if(!curChatChannel)return;if(unsubChat)unsubChat();
  unsubChat=db.collection("chat").where("channel","==",curChatChannel).limit(50).onSnapshot(snap=>{
    let msgs=snap.docs.map(d=>({id:d.id,...d.data()}));msgs.sort((a,b)=>(a.timestamp?a.timestamp.toMillis():0)-(b.timestamp?b.timestamp.toMillis():0));
    const cb=document.getElementById("chat-messages");cb.innerHTML=msgs.map(m=>renderMsg(m)).join("");cb.scrollTop=cb.scrollHeight;
    if(curChatChannel==="public"){lastMsgCount=msgs.length;if(isChatActive)localStorage.setItem("chatCount",lastMsgCount);}
    setChannelReadCount(curChatChannel,snap.size);
    markMessagesRead();
  });
}
function getRoleBadge(msg){
  if(msg.senderEmail===ADMIN_EMAIL)return'<span class="role-badge role-admin">Admin</span>';
  if(msg.isCoach)return'<span class="role-badge role-coach">Coach</span>';
  return'<span class="role-badge role-member">Mitglied</span>';
}
function renderMsg(msg){
  const isMe=msg.senderId===auth.currentUser.uid;let time="";if(msg.timestamp)time=msg.timestamp.toDate().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
  let content=`<div>${msg.text||""}</div>`;
  const canDel=isAdmin||isMe;const db2=canDel?`<button style="position:absolute;top:2px;right:5px;background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;font-size:.8rem" onclick="deleteChatMsg('${msg.id}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button>`:"";
  if(msg.type==="trade"&&msg.tradeData){const t=msg.tradeData;const img=msg.sharedImage||t.imgSetup;const sl=t.status==="Aktiv"?"OPEN":"CLOSED";const ts=encodeURIComponent(JSON.stringify(t));const is=encodeURIComponent(img||"");const th=img?`<img src="${img}" class="ct-img">`:"";content=`<div class="chat-trade-card" onclick="openSignalDetail('${ts}','${is}')"><div class="ct-header"><span>${t.asset}</span><span>${sl}</span></div>${th}</div>`;}
  const badge=getRoleBadge(msg);
  const reactions=msg.reactions?renderReactions(msg.id,msg.reactions):"";
  const emojiBtn=`<button class="emoji-picker-btn" onclick="event.stopPropagation();toggleEmojiReact('${msg.id}')" title="Reagieren">&#x1F600;</button>`;
  const readStatus=isMe?(msg.readBy&&Object.keys(msg.readBy).length>1?'<span class="read-ticks read">&#x2713;&#x2713;</span>':'<span class="read-ticks sent">&#x2713;&#x2713;</span>'):"";
  return`<div class="msg-wrapper ${isMe?"me":"other"}"><div class="msg-bubble">${!isMe?`<span class="msg-sender-name">${msg.senderName} ${badge}</span>`:""} ${content}${db2}<div class="msg-meta">${emojiBtn}<span class="msg-time">${time}</span>${readStatus}</div></div>${reactions}</div>`;
}
function renderReactions(msgId,reactions){
  if(!reactions||!Object.keys(reactions).length)return"";
  const counts={};Object.values(reactions).forEach(emoji=>{counts[emoji]=(counts[emoji]||0)+1;});
  const myReaction=reactions[auth.currentUser.uid]||null;
  return'<div class="msg-reactions">'+Object.entries(counts).map(([emoji,count])=>`<span class="msg-reaction${myReaction===emoji?" reacted":""}" onclick="toggleEmojiReact('${msgId}','${emoji}')">${emoji} ${count}</span>`).join("")+"</div>";
}
async function toggleEmojiReact(msgId,emoji){
  if(!emoji){const picked=prompt("Emoji waehlen: \ud83d\udc4d \u2764\ufe0f \ud83d\ude02 \ud83d\ude22 \ud83d\udd25 \ud83d\ude80");if(!picked)return;emoji=picked;}
  const uid=auth.currentUser.uid;const ref=db.collection("chat").doc(msgId);const msgDoc=await ref.get();if(!msgDoc.exists)return;
  const msgData=msgDoc.data();const reactions=msgData.reactions||{};
  const isRemoving=reactions[uid]===emoji;
  if(isRemoving)delete reactions[uid];else reactions[uid]=emoji;
  await ref.update({reactions});
  if(!isRemoving&&msgData.senderId&&msgData.senderId!==uid){
    const channelNames={"public":"Public Chat","signals":"Signale","pro_signal":"Pro Signal"};
    const notif={emoji,senderName:currentUserName,channel:msgData.channel,channelName:channelNames[msgData.channel]||msgData.channel,timestamp:Date.now()};
    try{await db.collection("users").doc(msgData.senderId).collection("emoji_notifs").add(notif);}catch(e){}
  }
}
async function sendChatMessage(){
  const inp=document.getElementById("chat-input");const text=inp.value.trim();if(!text||!curChatChannel)return;if(curChatChannel==="pro_signal"&&!isAdmin)return;
  const msgData={text,senderName:currentUserName,senderId:auth.currentUser.uid,senderEmail:auth.currentUser.email.toLowerCase(),isCoach:isCoach,type:"text",channel:curChatChannel,timestamp:firebase.firestore.FieldValue.serverTimestamp(),readBy:{}};
  msgData.readBy[auth.currentUser.uid]=true;
  await db.collection("chat").add(msgData);inp.value="";
}
async function markMessagesRead(){
  if(!curChatChannel)return;
  const snap=await db.collection("chat").where("channel","==",curChatChannel).get();
  const batch=db.batch();let count=0;
  snap.docs.forEach(doc=>{const d=doc.data();if(d.senderId!==auth.currentUser.uid&&(!d.readBy||!d.readBy[auth.currentUser.uid])){const rb=d.readBy||{};rb[auth.currentUser.uid]=true;batch.update(doc.ref,{readBy:rb});count++;}});
  if(count>0)await batch.commit();
}
function deleteChatMsg(id){msgDelId=id;document.getElementById("popup-overlay").classList.add("open");document.getElementById("delete-modal").classList.remove("hidden");}
async function confirmDeleteMessage(){if(msgDelId){await db.collection("chat").doc(msgDelId).delete();closePopup();}}
function shareTrade(id){
  shareTradeId=id;shareType=null;const t=trades.find(x=>x.id===id);if(!t)return;
  document.querySelectorAll(".share-opt").forEach(el=>el.classList.remove("selected","disabled"));
  if(!t.imgSetup)document.getElementById("opt-setup").classList.add("disabled");if(!t.imgResult)document.getElementById("opt-result").classList.add("disabled");
  const si=document.getElementById("signal-inputs");if(t.status==="Aktiv"){si.classList.remove("hidden");["sig-entry","sig-sl","sig-tp1","sig-tp2","sig-tp3"].forEach((id,i)=>{document.getElementById(id).value=[t.entry,t.sl,t.tp1,t.tp2,t.tp3][i]||"";});}else si.classList.add("hidden");
  document.getElementById("share-channel").value="public";document.getElementById("popup-overlay").classList.add("open");document.getElementById("share-modal").classList.remove("hidden");
}
function selectShareOption(type){const t=trades.find(x=>x.id===shareTradeId);if(type==="setup"&&!t.imgSetup)return;if(type==="result"&&!t.imgResult)return;shareType=type;document.querySelectorAll(".share-opt").forEach(el=>el.classList.remove("selected"));document.getElementById("opt-"+type).classList.add("selected");}
async function loadShareContacts(){const sel=document.getElementById("share-private-user");sel.innerHTML="<option>Lade...</option>";try{const s=await db.collection("friendships").where("users","array-contains",auth.currentUser.uid).where("status","==","accepted").get();sel.innerHTML="";for(const doc of s.docs){const d=doc.data();const oi=d.users.find(u=>u!==auth.currentUser.uid);const ud=await db.collection("users").doc(oi).get();if(ud.exists)sel.innerHTML+=`<option value="${oi}">${ud.data().displayName}</option>`;}}catch(e){sel.innerHTML="<option>Fehler</option>";}}
function toggleShareTarget(){const v=document.getElementById("share-channel").value;const c=document.getElementById("share-private-container");if(v==="private"){c.classList.remove("hidden");loadShareContacts();}else c.classList.add("hidden");}
async function confirmShare(){
  if(!shareTradeId||!shareType){alert("Bitte waehle aus was du teilen moechtest.");return;}
  let tc=document.getElementById("share-channel").value;if(tc==="pro_signal"&&!isAdmin){alert("Nur fuer Admins.");return;}
  if(tc==="private"){const tu=document.getElementById("share-private-user").value;if(!tu){alert("Kontakt waehlen.");return;}tc=getChatId(auth.currentUser.uid,tu);}
  const t=trades.find(x=>x.id===shareTradeId);const tc2={...t};delete tc2.pnl;delete tc2.userId;
  if(t.status==="Aktiv"){tc2.entry=document.getElementById("sig-entry").value;tc2.sl=document.getElementById("sig-sl").value;tc2.tp1=document.getElementById("sig-tp1").value;tc2.tp2=document.getElementById("sig-tp2").value;tc2.tp3=document.getElementById("sig-tp3").value;}
  const si=shareType==="setup"?t.imgSetup:t.imgResult;
  await db.collection("chat").add({senderName:currentUserName,senderId:auth.currentUser.uid,senderEmail:auth.currentUser.email.toLowerCase(),isCoach:isCoach,type:"trade",tradeData:tc2,sharedImage:si,channel:tc,timestamp:firebase.firestore.FieldValue.serverTimestamp(),readBy:{}});
  closePopup();const tm={"public":"Public Chat","signals":"Signale","pro_signal":"Pro Signal"};enterChat(tc,tm[tc]||"Chat");navGuard("Chat");
}
function openSignalDetail(tde,iue){
  const t=JSON.parse(decodeURIComponent(tde));curDetailId=t.id;
  const _tdO1=document.getElementById("popup-overlay");
  if(_tdO1.classList.contains("open")){openOnLayer2("trade-detail-view");}else{_tdO1.classList.add("open");document.getElementById("trade-detail-view").classList.remove("hidden");}
  const isOwnTrade=t.userId===auth.currentUser.uid||t.senderId===auth.currentUser.uid;
  const showAdm=isAdmin&&!isOwnTrade&&iuFeedbackAllowed;const aia=document.getElementById("adm-feedback-input-area");
  if(aia){if(showAdm){aia.classList.remove("hidden");document.getElementById("adm-feedback-text").value=t.adminFeedback||"";}else aia.classList.add("hidden");}
  let html="";
  if(t.adminFeedback&&(!t.feedbackRead||isAdmin))html+=`<div style="background:rgba(187,134,252,.15);border:1px solid var(--accent);border-radius:8px;padding:15px;margin-bottom:15px"><div style="color:var(--accent);font-weight:700;margin-bottom:5px">Coach Feedback</div><div>${t.adminFeedback}</div></div>`;
  const pnlText=t.status==="Aktiv"?"OPEN":(t.pnl>=0?"+":"")+t.pnl.toFixed(2)+" â‚¬";
  html+=`<div class="td-hero"><span class="td-asset">${t.asset}</span><span class="td-pnl" style="color:${t.status==="Aktiv"?"#0a84ff":(t.pnl>=0?"#30d158":"#ff453a")}">${pnlText}</span></div>`;
  if(t.date)html+=`<div class="td-row" style="margin-bottom:10px"><span class="td-row-label">Eroeffnet</span><span class="td-row-val">${t.date.replace("T"," ")}</span></div>`;
  if(t.closedAt)html+=`<div class="td-row" style="margin-bottom:10px"><span class="td-row-label">Geschlossen</span><span class="td-row-val">${t.closedAt.replace("T"," ")}</span></div>`;
  html+=`<div class="td-value-list">`;
  const ar=(label,val,id,color)=>{if(!val)return"";return`<div class="td-row"><span class="td-row-label">${label}</span><div class="td-row-val-group"><span class="td-row-val"${color?' style="color:'+color+'"':''}>${val}</span><button class="td-copy-btn" id="${id}" onclick="copyText('${val}','${id}')" title="Kopieren">&#x1F4CB;</button></div></div>`;};
  if(t.entry)html+=ar("Entry",t.entry,"btn-cp-ent");if(t.sl)html+=ar("Stop Loss",t.sl,"btn-cp-sl","#ff453a");
  html+=ar("TP 1",t.tp1,"btn-cp-tp1","#30d158");html+=ar("TP 2",t.tp2,"btn-cp-tp2","#30d158");html+=ar("TP 3",t.tp3,"btn-cp-tp3","#30d158");html+=`</div>`;
  if(t.note)html+=`<div class="td-note-box">"${t.note}"</div>`;
  if(t.imgSetup)html+=`<div class="td-img-box"><span class="td-img-label">&#x1F4F7; Setup</span><img src="${t.imgSetup}" class="td-img-thumb" style="height:200px;border-radius:12px;border:2px solid #333;box-shadow:0 4px 15px rgba(0,0,0,.5)" onclick="window.open('${t.imgSetup}','_blank')"></div>`;
  if(t.imgResult)html+=`<div class="td-img-box"><span class="td-img-label">&#x1F3AF; Ergebnis</span><img src="${t.imgResult}" class="td-img-thumb" style="height:200px;border-radius:12px;border:2px solid #333;box-shadow:0 4px 15px rgba(0,0,0,.5)" onclick="window.open('${t.imgResult}','_blank')"></div>`;
  if(isOwnTrade&&t.status!=='Aktiv')html+=`<button onclick="analyzeTradeFromDetail('${t.id}')" style="width:100%;margin-top:16px;padding:12px;background:linear-gradient(135deg,var(--accent),#7b2fff);color:#000;font-weight:700;border:none;border-radius:12px;cursor:pointer;font-size:.95rem">&#x1F916; KI Trade-Analyse</button>`;
  document.getElementById("td-content").innerHTML=html;
}
async function submitAdminFeedback(){const text=document.getElementById("adm-feedback-text").value;if(curDetailId&&text){await db.collection("trades").doc(curDetailId).update({adminFeedback:text,feedbackRead:false});alert("Feedback gesendet!");closeTradeDetail();}}
async function openMemberDetail(id,email){
  let dn="User";try{const us=await db.collection("users").where("email","==",email).get();if(!us.empty)dn=us.docs[0].data().displayName;}catch(e){}
  document.getElementById("adm-detail-name").innerText=dn;document.getElementById("adm-detail-email").innerText=email;
  const us=await db.collection("users").where("email","==",email).get();if(us.empty){alert("User noch nicht eingeloggt.");return;}
  const tuid=us.docs[0].id;iuFeedbackAllowed=true;const ud=us.docs[0].data();if(ud.allowCoachFeedback===false)iuFeedbackAllowed=false;
  if(!iuFeedbackAllowed){document.getElementById("adm-content-area-wrapper").classList.add("hidden");document.getElementById("adm-access-denied").classList.remove("hidden");}
  else{document.getElementById("adm-content-area-wrapper").classList.remove("hidden");document.getElementById("adm-access-denied").classList.add("hidden");}
  const js=await db.collection("journals").where("userId","==",tuid).get();iuJournals=js.docs.map(d=>({id:d.id,...d.data()}));
  const ts=await db.collection("trades").where("userId","==",tuid).get();iuTrades=ts.docs.map(d=>({id:d.id,...d.data()}));
  const sel=document.getElementById("adm-journal-select");sel.innerHTML=iuJournals.length===0?"<option>Kein Journal</option>":iuJournals.map(j=>`<option value="${j.name}">${j.name}</option>`).join("");
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("admin-member-modal").classList.remove("hidden");
  if(iuFeedbackAllowed)updateAdminMemberView();
}
function updateAdminMemberView(){
  if(!iuFeedbackAllowed)return;const sj=document.getElementById("adm-journal-select").value;
  let ft=iuTrades;if(sj&&iuJournals.length>0){const tgt=sj!=="Kein Journal"?sj:iuJournals[0].name;ft=iuTrades.filter(t=>(t.journal||"Main")===tgt);}
  const cl=ft.filter(t=>t.status==="Geschlossen");const sum=cl.reduce((a,b)=>a+b.pnl,0);const wins=cl.filter(t=>t.pnl>0).length;const wr=cl.length?((wins/cl.length)*100).toFixed(0):0;
  document.getElementById("adm-stat-pnl").innerText=sum.toFixed(2)+" â‚¬";document.getElementById("adm-stat-pnl").style.color=sum>=0?"var(--success)":"var(--danger)";document.getElementById("adm-stat-win").innerText=wr+"%";document.getElementById("adm-stat-count").innerText=cl.length;
  let bal=0;const data=cl.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t=>{bal+=t.pnl;return bal;});
  const ctx=document.getElementById("admChart").getContext("2d");if(adminCI)adminCI.destroy();
  adminCI=new Chart(ctx,{type:"line",data:{labels:data.map(()=>""),datasets:[{data,borderColor:"#bb86fc",borderWidth:2,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:"#333"}}}}});
  document.getElementById("adm-trade-list").innerHTML=ft.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>{const ts=encodeURIComponent(JSON.stringify(t));const is=encodeURIComponent(t.imgSetup||t.imgResult||"");return`<tr><td>${t.date.split("T")[0]}</td><td>${t.asset}</td><td style="text-align:right;color:${t.pnl>=0?"var(--success)":"var(--danger)"}">${t.pnl.toFixed(2)}</td><td><button class="btn-icon" onclick="openSignalDetail('${ts}','${is}')" title="Details">&#x1F441;</button></td></tr>`;}).join("");
}
function switchAdminTab(tab){document.getElementById("btn-adm-stats").classList.toggle("active",tab==="stats");document.getElementById("btn-adm-trades").classList.toggle("active",tab==="trades");if(tab==="stats"){document.getElementById("adm-content-stats").classList.remove("hidden");document.getElementById("adm-content-trades").classList.add("hidden");}else{document.getElementById("adm-content-stats").classList.add("hidden");document.getElementById("adm-content-trades").classList.remove("hidden");}}
async function loadAdminZentrale(){
  const tl=document.getElementById("admin-test-list"),pl=document.getElementById("admin-pro-list");if(!tl||!pl)return;
  tl.innerHTML="<div style='color:var(--text-sub);font-size:.85rem;padding:5px'>Lade...</div>";pl.innerHTML="<div style='color:var(--text-sub);font-size:.85rem;padding:5px'>Lade...</div>";
  try{
    const us=await db.collection("users").get();const tu=[],pu=[];
    for(const doc of us.docs){const ud=doc.data();if(ud.email===ADMIN_EMAIL)continue;const cs2=await db.collection("coaches").where("email","==",ud.email).get();if(!cs2.empty)continue;const item={uid:doc.id,name:ud.displayName||"User",email:ud.email,status:ud.status||"test"};if(item.status==="pro")pu.push(item);else tu.push(item);}
    const rc=(u)=>`<div class="user-card"><div class="user-card-name">${u.name}</div><div class="user-card-email">${u.email}</div><div class="user-card-actions">${u.status!=="pro"?`<button class="ua-btn upgrade" onclick="adminUpgrade('${u.uid}','${u.email}')">Pro</button>`:""} ${u.status==="pro"?`<button class="ua-btn downgrade" onclick="adminDowngrade('${u.uid}','${u.email}')">Test</button>`:""} <button class="ua-btn ban" onclick="adminBan('${u.uid}','${u.email}')">Sperren</button> <button class="ua-btn del" onclick="adminDeleteUserByUid('${u.uid}','${u.email}')">Loeschen</button></div></div>`;
    tl.innerHTML=tu.length?tu.map(rc).join(""):"<div style='color:var(--text-sub);font-size:.85rem;padding:10px'>Keine.</div>";
    pl.innerHTML=pu.length?pu.map(rc).join(""):"<div style='color:var(--text-sub);font-size:.85rem;padding:10px'>Keine.</div>";
  }catch(e){tl.innerHTML="<div style='color:var(--danger)'>Fehler</div>";}
}
async function adminUpgrade(uid,email){if(!uid){alert("UID nicht gefunden.");return;}if(!confirm(`${email} auf Pro upgraden?`))return;await db.collection("users").doc(uid).update({status:"pro"});alert("Pro gesetzt!");loadAdminZentrale();}
async function adminDowngrade(uid,email){if(!uid){alert("UID nicht gefunden.");return;}if(!confirm(`${email} auf Test setzen?`))return;await db.collection("users").doc(uid).update({status:"test"});alert("Test gesetzt.");loadAdminZentrale();}
async function adminBan(uid,email){if(!uid){alert("UID nicht gefunden.");return;}if(!confirm(`${email} sperren?`))return;await db.collection("users").doc(uid).update({status:"banned"});alert("Gesperrt.");loadAdminZentrale();}
async function adminDeleteUserByUid(uid,email){if(!confirm(`${email} wirklich loeschen?`))return;if(uid){try{const ts=await db.collection("trades").where("userId","==",uid).get();const b=db.batch();ts.docs.forEach(d=>b.delete(d.ref));await b.commit();const js=await db.collection("journals").where("userId","==",uid).get();const b2=db.batch();js.docs.forEach(d=>b2.delete(d.ref));await b2.commit();await db.collection("users").doc(uid).delete();}catch(e){}}alert("Geloescht.");loadAdminZentrale();admLoad();}
async function loadAdminFeedback(){const list=document.getElementById("adm-feedback-inbox");list.innerHTML="Lade...";const s=await db.collection("feedback_general").orderBy("timestamp","desc").limit(20).get();if(s.empty){list.innerHTML="<div style='color:var(--text-sub);padding:10px'>Kein Feedback.</div>";return;}list.innerHTML=s.docs.map(doc=>{const d=doc.data();const dt=d.timestamp?d.timestamp.toDate().toLocaleString():"-";return`<div class="feedback-item"><div class="fb-header"><span>${d.userName} (${dt})</span><div><span class="fb-type">${d.type}</span><button class="fb-del" onclick="delFeedback('${doc.id}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button></div></div><div class="fb-text">${d.text}</div></div>`;}).join("");}
async function delFeedback(id){if(confirm("Loeschen?")){await db.collection("feedback_general").doc(id).delete();loadAdminFeedback();}}
async function sendGeneralFeedback(){const type=document.getElementById("fb-type").value,text=document.getElementById("fb-text").value;if(!text){alert("Text fehlt.");return;}await db.collection("feedback_general").add({userId:auth.currentUser.uid,userName:currentUserName,type,text,timestamp:firebase.firestore.FieldValue.serverTimestamp()});alert("Feedback gesendet!");document.getElementById("fb-text").value="";}
function changeCalMonth(d){calDate.setMonth(calDate.getMonth()+d);renderCalendar();}
function renderCalendar(){
  if(!activeJournal&&journals.length>0)activeJournal=journals[0].name;document.getElementById("cal-filter-hint").innerText="Journal: "+activeJournal;
  const y=calDate.getFullYear(),m=calDate.getMonth();document.getElementById("cal-month-title").innerText=new Date(y,m).toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  const grid=document.getElementById("cal-days-grid");grid.innerHTML="";const filtered=trades.filter(t=>(t.journal||"Main")===activeJournal);
  const first=new Date(y,m,1).getDay(),last=new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++)grid.innerHTML+=`<div class="cal-cell" style="opacity:0;cursor:default"></div>`;
  for(let d2=1;d2<=last;d2++){const ds=new Date(y,m,d2).toDateString();const dt=filtered.filter(t=>t.status==="Geschlossen"&&new Date(t.date).toDateString()===ds);let sum=0;dt.forEach(t=>sum+=t.pnl);const cnt=dt.length;let cc="cal-cell";if(cnt>0){if(sum>0)cc+=" win";else if(sum<0)cc+=" loss";}let h=`<div class="cal-date">${d2}</div>`;if(cnt>0)h+=`<div class="cal-pnl sensitive ${sum>=0?"text-green":"text-red"}">${sum.toFixed(0)}</div><div class="cal-trades">${cnt} Trades</div>`;grid.innerHTML+=`<div class="${cc}" ${cnt>0?`onclick="openDayDetail('${y}-${m+1}-${d2}')"`:""}>${h}</div>`;}
}
function openDayDetail(ds){
  const d=new Date(ds);document.getElementById("dv-date-title").innerText=d.toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  const dt=trades.filter(t=>(t.journal||"Main")===activeJournal&&t.status==="Geschlossen"&&new Date(t.date).toDateString()===d.toDateString()).sort((a,b)=>new Date(a.date)-new Date(b.date));
  let sum=0;dt.forEach(t=>sum+=t.pnl);const wins=dt.filter(t=>t.pnl>0).length;const gl=Math.abs(dt.filter(t=>t.pnl<0).reduce((a,b)=>a+b.pnl,0));const pf=gl===0?(wins>0?99:0):dt.filter(t=>t.pnl>0).reduce((a,b)=>a+b.pnl,0)/gl;
  document.getElementById("dv-pnl").innerText=(sum<0?"-":"+")+Math.abs(sum).toFixed(2)+" â‚¬";document.getElementById("dv-pnl").className="dv-stat-val sensitive "+(sum>=0?"text-green":"text-red");document.getElementById("dv-winrate").innerText=dt.length?((wins/dt.length)*100).toFixed(0)+"%":"0%";document.getElementById("dv-pf").innerText=pf.toFixed(2);document.getElementById("dv-count").innerText=dt.length;
  document.getElementById("dv-list").innerHTML=dt.map(t=>{const time=t.date.split("T")[1].slice(0,5);const ds2=d.toLocaleDateString("en-GB",{day:"numeric",month:"short"});const pc=t.pnl>=0?"text-green":"text-red";const ar=t.pnl>=0?"up":"dn";const ts=encodeURIComponent(JSON.stringify(t));const is=encodeURIComponent(t.imgSetup||t.imgResult||"");return`<div class="trade-row" onclick="openSignalDetail('${ts}','${is}')"><div class="tr-icon ${pc}">${ar}</div><div class="tr-date-col"><span class="tr-date">${ds2}</span><span class="tr-time">${time}</span></div><div class="tr-sym">${t.asset}</div><div class="tr-pnl sensitive ${pc}">${t.pnl.toFixed(2)}</div></div>`;}).join("");
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("day-detail-view").classList.remove("hidden");
  const ctx=document.getElementById("dayChart").getContext("2d");if(dayChart)dayChart.destroy();let r=0;const data=dt.map(t=>{r+=t.pnl;return r;});
  dayChart=new Chart(ctx,{type:"line",data:{labels:dt.map(()=>""),datasets:[{data,borderColor:sum>=0?"#00c853":"#ff453a",borderWidth:2,fill:true,backgroundColor:sum>=0?"rgba(0,200,83,.1)":"rgba(255,69,58,.1)",tension:.1,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:"#333"}}}}});
}
function closePopup(){
  const o2=document.getElementById("popup-overlay-2");
  if(o2&&o2.classList.contains("open")){closePopup2();return;}
  document.getElementById("popup-overlay").classList.remove("open");document.querySelectorAll(".modal-base").forEach(el=>{el.classList.add("hidden");el.classList.remove("open");});curDetailId=null;
}
function closePopup2(){document.getElementById("popup-overlay-2").classList.remove("open");document.querySelectorAll(".modal-layer2").forEach(el=>el.classList.add("hidden"));}
function openOnLayer2(modalId){
  const m=document.getElementById(modalId);m.classList.remove("hidden");m.classList.add("modal-layer2");
  document.getElementById("popup-overlay-2").classList.add("open");
  document.getElementById("popup-overlay-2").appendChild(m);
}
function closeLayer2AndReturn(modalId){
  const m=document.getElementById(modalId);m.classList.add("hidden");m.classList.remove("modal-layer2");
  document.getElementById("popup-overlay").appendChild(m);
  document.getElementById("popup-overlay-2").classList.remove("open");
}
async function closeTradeDetail(){const onL2=document.getElementById("trade-detail-view").classList.contains("modal-layer2");if(onL2){closeLayer2AndReturn("trade-detail-view");}else{document.getElementById("trade-detail-view").classList.add("hidden");document.getElementById("popup-overlay").classList.remove("open");}if(curDetailId){const t=trades.find(x=>x.id===curDetailId);if(t&&t.adminFeedback&&!isAdmin&&t.userId===auth.currentUser.uid){await db.collection("trades").doc(curDetailId).update({adminFeedback:"",feedbackRead:true});await loadData();}curDetailId=null;}}
async function analyzeTradeFromDetail(id){await closeTradeDetail();showView('KI');setTimeout(()=>{switchKITab('analyse');_kiPopulateTradeSelect();const sel=document.getElementById('ki-trade-select');if(sel)sel.value=id;analyzeMyTrades();},300);}
function copyText(val,btnId){if(!val)return;navigator.clipboard.writeText(val).then(()=>{const b=document.getElementById(btnId);if(b){b.innerHTML="&#x2714;";setTimeout(()=>{b.innerHTML="&#x1F4CB;";},1500);}});}
function renderHistory(){
  if(!activeJournal&&journals.length>0)activeJournal=journals[0].name;document.getElementById("hist-title").innerText="Trade Historie ("+activeJournal+")";
  let f=trades.filter(t=>(t.journal||"Main")===activeJournal).sort((a,b)=>new Date(b.date)-new Date(a.date));const tb=document.getElementById("tradeBody");if(!tb)return;
  if(!f.length){tb.innerHTML="<tr><td colspan='4' style='text-align:center;padding:20px;color:var(--text-sub)'>Keine Trades</td></tr>";return;}
  tb.innerHTML=f.map(t=>{const time=t.date.split("T")[1];const date=t.date.split("T")[0];const sb=(t.imgSetup||t.imgResult)?`<button class="btn-icon" onclick="shareTrade('${t.id}')" title="Teilen">&#x2197;</button>`:"";const ts=encodeURIComponent(JSON.stringify(t));const is=encodeURIComponent(t.imgSetup||t.imgResult||"");let ph=t.status==="Aktiv"?`<span style="color:var(--text-sub);font-style:italic">Offen</span>`:`<span class="sensitive" style="color:${t.pnl>=0?"var(--success)":"var(--danger)"};font-weight:700">${t.pnl.toFixed(2)}</span>`;return`<tr><td>${date}<span class="time-sub">${time}</span></td><td><b>${t.asset}</b></td><td style="text-align:right">${ph}</td><td style="text-align:right"><button class="btn-icon" onclick="openSignalDetail('${ts}','${is}')" title="Details">&#x1F441;</button> ${sb} <button class="btn-icon" onclick="editTrade('${t.id}')" title="Bearbeiten">&#x270F;&#xFE0E;</button> <button class="btn-icon" onclick="delTrade('${t.id}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button></td></tr>`;}).join("");
}
function prepareCreateView(){
  if(userStatus==="test"){const mt=trades.filter(t=>(t.journal||"Main")===(activeJournal||journals[0]?.name||"Main"));if(mt.length>=5){alert("Test-Limit: Max. 5 Trades!\nUpgrade auf Pro.");return;}}
  document.getElementById("editId").value="";const now=new Date();now.setMinutes(now.getMinutes()-now.getTimezoneOffset());document.getElementById("datetime").value=now.toISOString().slice(0,16);
  ["assetInput","pnl","note","inpEntry","inpSL","inpTP1","inpTP2","inpTP3","imgSetup","imgResult","inpAdminFeedback"].forEach(id=>{const el=document.getElementById(id);if(el)el.value="";});
  clearTradeImg('setup');clearTradeImg('result');
  if(activeJournal)document.getElementById("inpJournalSelect").value=activeJournal;document.getElementById("admin-feedback-container").classList.add("hidden");document.getElementById("status").value="Aktiv";toggleFormFields();document.getElementById("form-title").innerText="Neuer Trade";document.getElementById("trade-form-modal").classList.remove("hidden");document.getElementById("popup-overlay").classList.add("open");
}
async function saveTrade(){
  const id=document.getElementById("editId").value;const asset=document.getElementById("assetInput").value.toUpperCase();if(!asset){alert("Asset fehlt!");return;}
  const jval=document.getElementById("inpJournalSelect").value||activeJournal;
  if(!id&&userStatus==="test"){const mt=trades.filter(t=>(t.journal||"Main")===jval);if(mt.length>=5){alert("Test-Limit: Max. 5 Trades!");return;}}
  const tradeStatus=document.getElementById("status").value;
  const data={userId:auth.currentUser.uid,date:document.getElementById("datetime").value,asset,journal:jval,status:tradeStatus,pnl:parseFloat(document.getElementById("pnl").value)||0,imgSetup:document.getElementById("imgSetup").value,imgResult:document.getElementById("imgResult").value,note:document.getElementById("note").value,entry:document.getElementById("inpEntry").value,sl:document.getElementById("inpSL").value,tp1:document.getElementById("inpTP1").value,tp2:document.getElementById("inpTP2").value,tp3:document.getElementById("inpTP3").value,adminFeedback:document.getElementById("inpAdminFeedback").value};
  if(tradeStatus==="Geschlossen"){const existing=id?trades.find(t=>t.id===id):null;if(!existing||!existing.closedAt){const cn=new Date();cn.setMinutes(cn.getMinutes()-cn.getTimezoneOffset());data.closedAt=cn.toISOString().slice(0,16);}}
  if(id)await db.collection("trades").doc(id).update(data);else{await db.collection("trades").add(data);kiRateNewTrade(data);}await loadData();closePopup();
}
function editTrade(id,cn){const t=trades.find(x=>x.id===id);if(!t)return;document.getElementById("editId").value=t.id;document.getElementById("datetime").value=t.date;document.getElementById("assetInput").value=t.asset;document.getElementById("inpJournalSelect").value=t.journal||(journals[0]?journals[0].name:"Main");document.getElementById("status").value=cn?"Geschlossen":t.status;document.getElementById("pnl").value=t.pnl;document.getElementById("imgSetup").value=t.imgSetup||"";document.getElementById("imgResult").value=t.imgResult||"";if(t.imgSetup)showTradeImgPreview('setup',t.imgSetup);else clearTradeImg('setup');if(t.imgResult)showTradeImgPreview('result',t.imgResult);else clearTradeImg('result');document.getElementById("note").value=t.note||"";document.getElementById("inpEntry").value=t.entry||"";document.getElementById("inpSL").value=t.sl||"";document.getElementById("inpTP1").value=t.tp1||"";document.getElementById("inpTP2").value=t.tp2||"";document.getElementById("inpTP3").value=t.tp3||"";document.getElementById("inpAdminFeedback").value=t.adminFeedback||"";document.getElementById("admin-feedback-container").classList.toggle("hidden",!isAdmin);document.getElementById("form-title").innerText="Trade Bearbeiten";toggleFormFields();document.getElementById("trade-form-modal").classList.remove("hidden");document.getElementById("popup-overlay").classList.add("open");}
async function delTrade(id){if(confirm("Loeschen?")){await db.collection("trades").doc(id).delete();await loadData();showView("Historie");}}
function toggleFormFields(){const s=document.getElementById("status").value;document.getElementById("closedFields").classList.toggle("hidden",s==="Aktiv");}
function openCreateJournal(){
  if(userStatus==="test"&&journals.length>=1){document.getElementById("popup-overlay").classList.add("open");document.getElementById("navguard-modal").classList.remove("hidden");return;}
  editingJournalId=null;document.getElementById("journal-modal-title").innerText="Neues Journal";
  document.getElementById("jmName").value="";document.getElementById("jmCap").value="";document.getElementById("jmMaxDD").value="";document.getElementById("jmDDType").value="eur";
  document.getElementById("btn-jm-save").innerText="Erstellen";
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("journal-form-modal").classList.remove("hidden");
}
function prepareEditJournal(id){
  const j=journals.find(x=>x.id===id);if(!j)return;editingJournalId=id;
  document.getElementById("journal-modal-title").innerText="Journal Bearbeiten";
  document.getElementById("jmName").value=j.name;document.getElementById("jmCap").value=j.startCap||"";document.getElementById("jmMaxDD").value=j.maxDD||"";document.getElementById("jmDDType").value=j.ddType||"eur";
  document.getElementById("btn-jm-save").innerText="Speichern";
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("journal-form-modal").classList.remove("hidden");
}
async function saveJournalModal(){
  const name=document.getElementById("jmName").value.trim();const cap=parseFloat(document.getElementById("jmCap").value)||0;const maxDD=document.getElementById("jmMaxDD").value;const ddType=document.getElementById("jmDDType").value;
  if(!name){alert("Name fehlt!");return;}
  if(editingJournalId){const oj=journals.find(j=>j.id===editingJournalId);await db.collection("journals").doc(editingJournalId).update({name,startCap:cap,maxDD,ddType});if(name!==oj.name){const batch=db.batch();(await db.collection("trades").where("userId","==",auth.currentUser.uid).where("journal","==",oj.name).get()).docs.forEach(d=>batch.update(d.ref,{journal:name}));await batch.commit();if(activeJournal===oj.name)activeJournal=name;}}
  else{await db.collection("journals").add({userId:auth.currentUser.uid,name,startCap:cap,maxDD,ddType,hidden:false});}
  editingJournalId=null;closePopup();await loadData();renderSettingsList();
}
async function toggleJournalVisibility(id,ch){await db.collection("journals").doc(id).update({hidden:!ch});await loadData();renderSettingsList();}
async function deleteJournal(id,name){if(!confirm(`Journal '${name}' und ALLE Trades loeschen?`))return;await db.collection("journals").doc(id).delete();const b=db.batch();(await db.collection("trades").where("userId","==",auth.currentUser.uid).where("journal","==",name).get()).docs.forEach(d=>b.delete(d.ref));await b.commit();if(activeJournal===name)activeJournal=null;await loadData();renderSettingsList();}
function renderSettingsList(){document.getElementById("settings-journal-list").innerHTML=journals.map(j=>{const ih=j.hidden===true;return`<div class="settings-list-item" style="opacity:${ih?.5:1}"><div><strong>${j.name}</strong> <small style="color:var(--text-sub)">${j.startCap?j.startCap+" â‚¬":""}</small></div><div style="display:flex;gap:4px"><button class="btn-icon" onclick="toggleJournalVisibility('${j.id}',${ih})" title="${ih?"Einblenden":"Ausblenden"}">&#x1F441;</button><button class="btn-icon" onclick="prepareEditJournal('${j.id}')" title="Bearbeiten">&#x270F;&#xFE0E;</button><button class="btn-icon" onclick="deleteJournal('${j.id}','${j.name}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button></div></div>`;}).join("");}
let allAdmMembers=[];
async function admLoad(){
  try{const s=await db.collection("users").get();const le=document.getElementById("admList");le.innerHTML="";allAdmMembers=[];
  for(const doc of s.docs){const ud=doc.data();if(ud.email===ADMIN_EMAIL)continue;const cs2=await db.collection("coaches").where("email","==",ud.email).get();if(!cs2.empty)continue;allAdmMembers.push({uid:doc.id,name:ud.displayName||"User",email:ud.email,status:ud.status||"test"});}
  renderAdmMembers(allAdmMembers);
  const cs=await db.collection("coaches").get();const cl=document.getElementById("coachList");cl.innerHTML="";for(const doc of cs.docs){const cd=doc.data();cl.innerHTML+=`<div class="adm-row"><div>${cd.email}</div><button class="btn-icon" onclick="coachDel('${doc.id}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button></div>`;}}catch(e){console.error(e);}
}
function renderAdmMembers(list){const le=document.getElementById("admList");le.innerHTML=list.length?list.map(u=>`<div class="adm-row"><div class="adm-user-info"><div class="adm-text"><span class="adm-name">${u.name}</span><span class="adm-email">${u.email} <span style="color:${u.status==="pro"?"var(--success)":"var(--text-sub)"};font-weight:700;font-size:.7rem;text-transform:uppercase">${u.status}</span></span></div></div><div style="display:flex;gap:4px"><button class="btn-icon" onclick="openMemberDetailByUid('${u.uid}','${u.email}')" title="Details">&#x1F441;</button><button class="btn-icon" onclick="adminResetPassword('${u.email}')" title="Passwort Reset">&#x1F511;</button></div></div>`).join(""):"<div style='color:var(--text-sub);padding:10px'>Keine Mitglieder.</div>";}
function filterAdmMembers(){const q=(document.getElementById("admMemberSearch").value||"").toLowerCase();if(!q){renderAdmMembers(allAdmMembers);return;}renderAdmMembers(allAdmMembers.filter(u=>u.name.toLowerCase().includes(q)||u.email.toLowerCase().includes(q)));}
async function openMemberDetailByUid(uid,email){
  let dn="User";const uDoc=await db.collection("users").doc(uid).get();if(uDoc.exists)dn=uDoc.data().displayName||"User";
  document.getElementById("adm-detail-name").innerText=dn;document.getElementById("adm-detail-email").innerText=email;
  iuFeedbackAllowed=true;const ud=uDoc.data();if(ud&&ud.allowCoachFeedback===false)iuFeedbackAllowed=false;
  if(!iuFeedbackAllowed){document.getElementById("adm-content-area-wrapper").classList.add("hidden");document.getElementById("adm-access-denied").classList.remove("hidden");}
  else{document.getElementById("adm-content-area-wrapper").classList.remove("hidden");document.getElementById("adm-access-denied").classList.add("hidden");}
  const js=await db.collection("journals").where("userId","==",uid).get();iuJournals=js.docs.map(d=>({id:d.id,...d.data()}));
  const ts=await db.collection("trades").where("userId","==",uid).get();iuTrades=ts.docs.map(d=>({id:d.id,...d.data()}));
  const sel=document.getElementById("adm-journal-select");sel.innerHTML=iuJournals.length===0?"<option>Kein Journal</option>":iuJournals.map(j=>`<option value="${j.name}">${j.name}</option>`).join("");
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("admin-member-modal").classList.remove("hidden");
  if(iuFeedbackAllowed)updateAdminMemberView();
}
async function coachAdd(){const e=document.getElementById("coachEmail").value.toLowerCase().trim();if(e){await db.collection("coaches").add({email:e});document.getElementById("coachEmail").value="";admLoad();}}
async function coachDel(id){if(confirm("Coach loeschen?")){await db.collection("coaches").doc(id).delete();admLoad();}}
async function toggleFeedback(val){if(auth.currentUser)await db.collection("users").doc(auth.currentUser.uid).set({allowCoachFeedback:val},{merge:true});}
async function toggleStatsVisible(val){if(auth.currentUser)await db.collection("users").doc(auth.currentUser.uid).set({statsVisible:val},{merge:true});}
function getMutedChats(){try{return JSON.parse(localStorage.getItem("mutedChats")||"[]");}catch(e){return[];}}
function toggleMuteChat(){if(!curChatChannel)return;let muted=getMutedChats();if(muted.includes(curChatChannel))muted=muted.filter(c=>c!==curChatChannel);else muted.push(curChatChannel);localStorage.setItem("mutedChats",JSON.stringify(muted));updateMuteBtn();}
function updateMuteBtn(){const btn=document.getElementById("chat-mute-btn");if(!btn||!curChatChannel)return;const muted=getMutedChats().includes(curChatChannel);btn.innerHTML=muted?"&#x1F515;":"&#x1F514;";btn.classList.toggle("muted",muted);btn.title=muted?"Stumm geschaltet":"Stumm schalten";}
function togglePrivacy(){privacyMode=!privacyMode;document.documentElement.style.setProperty("--blur",privacyMode?"5px":"0px");}
function handleLogout(){auth.signOut().then(()=>location.reload());}
function setTheme(t){document.body.classList.remove("light-mode","neon-mode","black-mode","grey-mode","scifi-mode");if(t==="light")document.body.classList.add("light-mode");else if(t==="neon")document.body.classList.add("neon-mode");else if(t==="black")document.body.classList.add("black-mode");else if(t==="grey")document.body.classList.add("grey-mode");else if(t==="scifi")document.body.classList.add("scifi-mode");localStorage.setItem("tradeTheme",t);document.querySelectorAll("#theme-selector .filter-pill").forEach(b=>{b.classList.toggle("active",b.dataset.theme===t);});if(document.getElementById("view-Statistik").classList.contains("active"))renderStatistics();}
function renderTradingViewWidget(){const c=document.getElementById("tradingview_chart");if(!c)return;c.innerHTML="";if(typeof TradingView!=="undefined")new TradingView.widget({autosize:true,symbol:"FX:EURUSD",interval:"D",timezone:"Etc/UTC",theme:document.body.classList.contains("light-mode")?"light":"dark",style:"1",locale:"de_DE",enable_publishing:false,allow_symbol_change:true,hide_side_toolbar:false,container_id:"tradingview_chart"});}
function detectAssetType(asset){
  const a=asset.toUpperCase().replace(/[^A-Z0-9]/g,"");
  if(["XAUUSD","GOLD"].some(x=>a.includes(x)))return{type:"gold",pipSize:0.1,pipValue:0.92,contractSize:100,label:"Gold"};
  if(["XAGUSD","SILVER"].some(x=>a.includes(x)))return{type:"silver",pipSize:0.01,pipValue:4.60,contractSize:5000,label:"Silber"};
  if(["US30","DJ30","DOW"].some(x=>a.includes(x)))return{type:"index",pipSize:1,pipValue:0.92,contractSize:1,label:"US30 Index"};
  if(["NAS100","USTEC","NDX"].some(x=>a.includes(x)))return{type:"index",pipSize:1,pipValue:0.92,contractSize:1,label:"NAS100 Index"};
  if(["SPX500","US500","SP500"].some(x=>a.includes(x)))return{type:"index",pipSize:0.1,pipValue:0.92,contractSize:1,label:"S&P500 Index"};
  if(["GER40","DAX","DE30"].some(x=>a.includes(x)))return{type:"index",pipSize:1,pipValue:1,contractSize:1,label:"DAX Index"};
  if(["UK100","FTSE"].some(x=>a.includes(x)))return{type:"index",pipSize:1,pipValue:1.16,contractSize:1,label:"UK100 Index"};
  if(["JPN225","JP225","NIKKEI"].some(x=>a.includes(x)))return{type:"index",pipSize:1,pipValue:0.0061,contractSize:1,label:"JPN225 Index"};
  if(["BTCUSD","BITCOIN"].some(x=>a.includes(x)))return{type:"crypto",pipSize:1,pipValue:0.92,contractSize:1,label:"Bitcoin"};
  if(["ETHUSD","ETHEREUM"].some(x=>a.includes(x)))return{type:"crypto",pipSize:0.1,pipValue:0.92,contractSize:1,label:"Ethereum"};
  if(["XRPUSD"].some(x=>a.includes(x)))return{type:"crypto",pipSize:0.0001,pipValue:92,contractSize:1,label:"XRP"};
  if(["SOLUSD"].some(x=>a.includes(x)))return{type:"crypto",pipSize:0.01,pipValue:0.92,contractSize:1,label:"Solana"};
  if(["USOIL","WTI","CRUDEOIL"].some(x=>a.includes(x)))return{type:"commodity",pipSize:0.01,pipValue:0.92,contractSize:1000,label:"US Oil"};
  if(["UKOIL","BRENT"].some(x=>a.includes(x)))return{type:"commodity",pipSize:0.01,pipValue:0.92,contractSize:1000,label:"UK Oil"};
  if(["NATGAS","NGAS"].some(x=>a.includes(x)))return{type:"commodity",pipSize:0.001,pipValue:0.92,contractSize:10000,label:"Natural Gas"};
  const isJpy=a.includes("JPY");
  if(isJpy)return{type:"forex_jpy",pipSize:0.01,pipValue:6.14,contractSize:100000,label:"Forex (JPY)"};
  return{type:"forex",pipSize:0.0001,pipValue:9.20,contractSize:100000,label:"Forex"};
}
function calcLots(){
  const asset=(document.getElementById("cAsset").value||"").toUpperCase().trim();
  const bal=parseFloat(document.getElementById("cBal").value);
  const r=parseFloat(document.getElementById("cRisk").value);
  const ent=parseFloat(document.getElementById("cEnt").value);
  const sl=parseFloat(document.getElementById("cSl").value);
  if(!bal||!r||!ent||!sl){alert("Bitte alle Felder ausfuellen.");return;}
  if(ent===sl){alert("Entry und SL duerfen nicht gleich sein.");return;}
  const info=detectAssetType(asset||"EURUSD");
  const riskAmount=bal*(r/100);
  const pipDist=Math.abs(ent-sl)/info.pipSize;
  const pipValuePerLot=info.pipValue;
  let lot=riskAmount/(pipDist*pipValuePerLot);
  lot=Math.max(lot,0.01);
  lot=Math.round(lot*100)/100;
  document.getElementById("cResLot").innerText=lot.toFixed(2)+" Lot";
  document.getElementById("cResInfo").innerHTML=`Typ: ${info.label} | Risiko: ${riskAmount.toFixed(2)} EUR | Pips: ${pipDist.toFixed(1)} | Pip-Wert: ${pipValuePerLot.toFixed(2)} EUR/Lot`;
}
async function runOCR(){const url=document.getElementById("imgSetup").value;const se=document.getElementById("ocr-status");if(!url){alert("Bitte Bild-URL eingeben!");return;}se.innerText="Lese Bild...";try{const res=await fetch(`https://api.ocr.space/parse/imageurl?apikey=helloworld&url=${url}&language=eng&isOverlayRequired=false`);const data=await res.json();if(data.IsErroredOnProcessing){se.innerText="Fehler";return;}if(data.ParsedResults&&data.ParsedResults.length>0){const text=data.ParsedResults[0].ParsedText.replace(/(\r\n|\n|\r)/gm," ");const slm=text.match(/(?:Stop|SL|Loss)[\s:=-]*(\d+[\.,]\d{2,5})/i);if(slm)document.getElementById("inpSL").value=slm[1].replace(",",".");const em=text.match(/(?:Entry|Open|Price)[\s:=-]*(\d+[\.,]\d{2,5})/i);if(em)document.getElementById("inpEntry").value=em[1].replace(",",".");const tm=text.match(/(?:Target|TP|Profit)[\s:=-]*(\d+[\.,]\d{2,5})/i);if(tm)document.getElementById("inpTP1").value=tm[1].replace(",",".");se.innerText="Daten gefunden!";setTimeout(()=>se.innerText="",3000);}else se.innerText="Kein Text erkannt";}catch(e){se.innerText="Netzwerkfehler";}}
function showView(v){
  const _o2=document.getElementById("popup-overlay-2");const _o1=document.getElementById("popup-overlay");
  if(_o2&&_o2.classList.contains("open")){_o2.classList.remove("open");}
  if(_o1&&_o1.classList.contains("open")){_o1.classList.remove("open");document.querySelectorAll(".modal-base").forEach(el=>{el.classList.add("hidden");el.classList.remove("modal-layer2");});}
  document.querySelectorAll(".view-section").forEach(s=>s.classList.remove("active"));const el=document.getElementById("view-"+v.replace(/\s+/g,"-"));if(!el)return;el.classList.add("active");const titleMap={"Uebersicht":"DASHBOARD","Kalender":"KALENDER","Statistik":"STATISTIK","Historie":"JOURNAL","Chat":"CHAT","Einstellungen":"EINSTELLUNGEN","Feedback":"FEEDBACK","TradingView":"CHART","Lot-Rechner":"LOT RECHNER","News":"NEWS","Kurse":"KURS"};document.getElementById("view-title").innerText=titleMap[v]||v.toUpperCase();
  document.getElementById("navDrawer").classList.remove("open");document.getElementById("menu-overlay").classList.remove("open");
  document.querySelectorAll(".nav-drawer button").forEach(b=>b.classList.remove("nav-active"));const btn=document.getElementById("btn-"+v.replace(/\s+/g,"-"));if(btn)btn.classList.add("nav-active");
  isChatActive=(v==="Chat");if(isChatActive){if(lastMsgCount>0)localStorage.setItem("chatCount",lastMsgCount);updateChatBadge();if(!curChatChannel){document.getElementById("chat-lobby").classList.remove("hidden");document.getElementById("chat-room").classList.add("hidden");}renderChatLobby();}
  if(v==="Einstellungen"&&isAdmin&&!isCoach){loadAdminFeedback();loadAdminZentrale();loadUpgradeRequests();}
  if(v==="Einstellungen"&&isAdmin&&isCoach){loadAdminFeedback();}
  if(v==="Uebersicht")renderDashboard();if(v==="Kalender")renderCalendar();if(v==="Historie")renderHistory();if(v==="Statistik")renderStatistics();if(v==="Einstellungen")renderSettingsList();if(v==="Kurse")loadCourses();
  if(v==="News"){loadNewsView();}
  if(v==="TradingView")setTimeout(renderTradingViewWidget,50);
}
function toggleMenu(){document.getElementById("navDrawer").classList.toggle("open");document.getElementById("menu-overlay").classList.toggle("open");}
async function resetPassword(){
  const email=document.getElementById("login-email").value.trim();
  if(!email){alert("Bitte E-Mail Adresse eingeben.");return;}
  try{await auth.sendPasswordResetEmail(email);alert("Passwort-Reset Link wurde an "+email+" gesendet!");}
  catch(e){alert("Fehler: "+e.message);}
}
async function adminResetPassword(email){
  if(!confirm("Passwort-Reset an "+email+" senden?"))return;
  try{await auth.sendPasswordResetEmail(email);alert("Link gesendet!");}catch(e){alert("Fehler: "+e.message);}
}
function toggleNotifPopup(){
  const p=document.getElementById("notif-popup");const o=document.getElementById("notif-popup-overlay");
  if(p.classList.contains("open")){p.classList.remove("open");o.style.display="none";}
  else{renderNotifPopup();p.classList.add("open");o.style.display="block";}
}
function closeNotifPopup(){document.getElementById("notif-popup").classList.remove("open");document.getElementById("notif-popup-overlay").style.display="none";}
async function renderNotifPopup(){
  const p=document.getElementById("notif-popup");let html="<div style='padding:12px 15px;font-weight:700;border-bottom:1px solid var(--border)'>Benachrichtigungen</div>";
  const items=[];const muted=getMutedChats();
  const uf=trades.filter(t=>t.adminFeedback&&!t.feedbackRead);
  uf.forEach(t=>{items.push({type:"feedback",text:"Coach Feedback zu "+t.asset,data:t});});
  const sc=parseInt(localStorage.getItem("chatCount")||"0");
  if(lastMsgCount>sc&&!muted.includes("public"))items.push({type:"chat",text:"Neue Nachrichten im Chat",channel:"public",channelName:"Public Chat"});
  if(isAdmin&&!isCoach){try{const ur=await db.collection("upgrade_requests").get();const pend=ur.docs.filter(d=>d.data().status==="pending");pend.forEach(d=>{items.push({type:"upgrade",text:"Upgrade-Anfrage von "+(d.data().userName||d.data().userEmail||"User")});});}catch(e){}}
  try{const uid=auth.currentUser.uid;
    const ens=await db.collection("users").doc(uid).collection("emoji_notifs").orderBy("timestamp","desc").limit(10).get();
    ens.docs.forEach(d=>{const r=d.data();if(!muted.includes(r.channel))items.push({type:"emoji",text:r.senderName+" hat mit "+r.emoji+" reagiert",channel:r.channel,channelName:r.channelName||"Chat",docId:d.id});});
  }catch(e){}
  if(!items.length)html+="<div class='notif-empty'>Keine neuen Benachrichtigungen</div>";
  else items.forEach(it=>{
    if(it.type==="feedback"){const ts=encodeURIComponent(JSON.stringify(it.data));const is=encodeURIComponent(it.data.imgSetup||it.data.imgResult||"");html+=`<div class="notif-item" onclick="closeNotifPopup();openSignalDetail('${ts}','${is}')" style="cursor:pointer"><span style="color:var(--accent);font-weight:700">&#x1F4AC;</span> ${it.text}</div>`;}
    else if(it.type==="upgrade")html+=`<div class="notif-item" onclick="closeNotifPopup();showView('Einstellungen')" style="cursor:pointer"><span style="color:var(--success);font-weight:700">&#x1F680;</span> ${it.text}</div>`;
    else if(it.type==="emoji")html+=`<div class="notif-item" onclick="closeNotifPopup();navGuard('Chat');setTimeout(()=>enterChat('${it.channel}','${(it.channelName||"Chat").replace(/'/g,"")}'),300)" style="cursor:pointer"><span style="font-weight:700">&#x1F600;</span> ${it.text}</div>`;
    else html+=`<div class="notif-item" onclick="closeNotifPopup();navGuard('Chat');setTimeout(()=>enterChat('${it.channel}','${(it.channelName||"Chat").replace(/'/g,"")}'),300)" style="cursor:pointer"><span style="color:#0a84ff;font-weight:700">&#x1F4E9;</span> ${it.text}</div>`;
  });
  p.innerHTML=html;
  document.getElementById("notif-dot").classList.toggle("active",items.length>0);
}
async function updateNotifDot(){
  const uf=trades.filter(t=>t.adminFeedback&&!t.feedbackRead);
  const sc=parseInt(localStorage.getItem("chatCount")||"0");const muted=getMutedChats();
  let hasNotifs=uf.length>0||(lastMsgCount>sc&&!muted.includes("public"));
  try{const ens=await db.collection("users").doc(auth.currentUser.uid).collection("emoji_notifs").limit(1).get();if(!ens.empty)hasNotifs=true;}catch(e){}
  if(isAdmin&&!isCoach){try{const ur=await db.collection("upgrade_requests").get();const pend=ur.docs.filter(d=>d.data().status==="pending");if(pend.length)hasNotifs=true;}catch(e){}}
  document.getElementById("notif-dot").classList.toggle("active",hasNotifs);
}
function openProfileModal(){
  const u=auth.currentUser;if(!u)return;
  document.getElementById("prof-name").value=u.displayName||"";
  const initial=(u.displayName||"U").charAt(0).toUpperCase();
  document.getElementById("prof-avatar").innerText=initial;
  document.getElementById("prof-display-name").innerText=u.displayName||"User";
  document.getElementById("prof-display-email").innerText=u.email||"";
  const statusColors={pro:{bg:"rgba(48,209,88,.2)",color:"#30d158",text:"PRO"},test:{bg:"rgba(255,159,10,.2)",color:"#ff9f0a",text:"TEST"},banned:{bg:"rgba(255,61,0,.2)",color:"#ff3d00",text:"GESPERRT"}};
  const sc=statusColors[userStatus]||statusColors.test;const sb=document.getElementById("prof-status-badge");sb.style.background=sc.bg;sb.style.color=sc.color;sb.innerText=sc.text;
  const isEmailPw=u.providerData.some(p=>p.providerId==="password");
  if(isEmailPw){document.getElementById("prof-email-section").classList.remove("hidden");document.getElementById("prof-pw-section").classList.remove("hidden");document.getElementById("prof-email").value=u.email||"";}
  else{document.getElementById("prof-email-section").classList.add("hidden");document.getElementById("prof-pw-section").classList.add("hidden");}
  db.collection("users").doc(u.uid).get().then(doc=>{if(doc.exists&&doc.data().phone)document.getElementById("prof-phone").value=doc.data().phone;});
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("profile-modal").classList.remove("hidden");
}
async function saveProfile(){
  const u=auth.currentUser;if(!u)return;const name=document.getElementById("prof-name").value.trim();
  if(name&&name!==u.displayName){await u.updateProfile({displayName:name});currentUserName=name.split(" ")[0];document.getElementById("user-greeting-name").innerText=currentUserName;}
  const isEmailPw=u.providerData.some(p=>p.providerId==="password");
  if(isEmailPw){const email=document.getElementById("prof-email").value.trim();if(email&&email!==u.email){try{await u.updateEmail(email);}catch(e){alert("E-Mail Aenderung fehlgeschlagen: "+e.message);}}}
  const phone=document.getElementById("prof-phone").value.trim();
  await db.collection("users").doc(u.uid).set({displayName:name||u.displayName,phone:phone},{merge:true});
  alert("Profil gespeichert!");closePopup();
}
async function sendPasswordChange(){
  const u=auth.currentUser;if(!u)return;
  try{await auth.sendPasswordResetEmail(u.email);alert("Passwort-Reset Link an "+u.email+" gesendet!");}catch(e){alert("Fehler: "+e.message);}
}
async function requestUpgrade(){
  if(!auth.currentUser)return;
  try{
    await db.collection("upgrade_requests").doc(auth.currentUser.uid).set({userId:auth.currentUser.uid,userName:currentUserName,userEmail:auth.currentUser.email,status:"pending",timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    closePopup();
    document.getElementById("popup-overlay").classList.add("open");document.getElementById("upgrade-req-modal").classList.remove("hidden");
  }catch(e){alert("Fehler beim Senden: "+e.message);}
}
async function loadUpgradeRequests(){
  const area=document.getElementById("adm-upgrade-requests");if(!area)return;
  try{
    const s=await db.collection("upgrade_requests").get();
    const pending=s.docs.filter(d=>d.data().status==="pending");
    if(!pending.length){area.innerHTML="<div style='color:var(--text-sub);font-size:.85rem;padding:5px'>Keine Anfragen.</div>";return;}
    pending.sort((a,b)=>{const at=a.data().timestamp,bt=b.data().timestamp;if(!at)return 1;if(!bt)return-1;return bt.toMillis()-at.toMillis();});
    area.innerHTML=pending.map(doc=>{const d=doc.data();const dt=d.timestamp?d.timestamp.toDate().toLocaleString():"";return`<div class="adm-row"><div class="adm-user-info"><div class="adm-text"><span class="adm-name">${d.userName||"User"}</span><span class="adm-email">${d.userEmail||""} (${dt})</span></div></div><div style="display:flex;gap:4px"><button class="ua-btn upgrade" onclick="approveUpgrade('${doc.id}','${d.userId}','${d.userEmail||""}')">Genehmigen</button><button class="ua-btn del" onclick="denyUpgrade('${doc.id}')">Ablehnen</button></div></div>`;}).join("");
  }catch(e){area.innerHTML="<div style='color:var(--text-sub);font-size:.85rem;padding:5px'>Keine Anfragen.</div>";}
}
async function approveUpgrade(reqId,uid,email){try{await db.collection("users").doc(uid).update({status:"pro"});await db.collection("upgrade_requests").doc(reqId).update({status:"approved"});alert(email+" auf Pro gesetzt!");loadUpgradeRequests();loadAdminZentrale();}catch(e){alert("Fehler: "+e.message);}}
async function denyUpgrade(reqId){try{await db.collection("upgrade_requests").doc(reqId).update({status:"denied"});loadUpgradeRequests();}catch(e){alert("Fehler: "+e.message);}}
let curCourseId=null,editingCourseId=null,editingModuleId=null,editingModuleCourseId=null,tempQuizQuestions=[];
async function loadCourses(){
  const list=document.getElementById("course-list");if(!list)return;
  const addBtn=document.getElementById("btn-add-course");if(addBtn&&isAdmin&&!isCoach)addBtn.classList.remove("hidden");
  list.innerHTML="<div style='color:var(--text-sub);text-align:center;padding:30px'>Lade...</div>";
  try{
  const s=await db.collection("courses").orderBy("order","asc").get();
  if(s.empty){list.innerHTML="<div style='color:var(--text-sub);text-align:center;padding:30px'>Noch keine Kurse verfuegbar.</div>";return;}
  const courseCompletion=[];
  for(const doc of s.docs){
    const cid=doc.id;const mods=await db.collection("courses").doc(cid).collection("modules").get();
    const prog=await getUserCourseProgress(cid);
    const allDone=!mods.empty&&mods.docs.every(m=>prog.completedModules.includes(m.id));
    courseCompletion.push({docId:cid,data:doc.data(),allDone,moduleCount:mods.size,completedCount:prog.completedModules.length});
  }
  let html="";let courseIndex=0;const totalCourses=courseCompletion.length;
  for(const c of courseCompletion){
    const d=c.data;if(d.disabled&&!isAdmin){courseIndex++;continue;}
    const isUnlocked=isAdmin||courseIndex===0||(courseIndex>0&&courseCompletion[courseIndex-1].allDone);
    const dis=d.disabled?'<span style="color:var(--danger);font-size:.7rem;margin-left:6px">(Deaktiviert)</span>':"";
    const progress=c.moduleCount>0?Math.round(c.completedCount/c.moduleCount*100):0;
    const statusIcon=c.allDone?"&#x2705;":(isUnlocked?"&#x1F4DA;":"&#x1F512;");
    const statusText=c.allDone?"Abgeschlossen":(isUnlocked?`${progress}% abgeschlossen`:"Gesperrt");
    const statusColor=c.allDone?"var(--success)":(isUnlocked?"var(--accent)":"var(--text-sub)");
    const borderLeft=c.allDone?"3px solid var(--success)":(isUnlocked?"3px solid var(--accent)":"3px solid transparent");
    html+=`<div style="background:var(--cell-bg);border:1px solid var(--border);border-left:${borderLeft};border-radius:14px;padding:18px 20px;margin-bottom:10px;cursor:${isUnlocked?"pointer":"default"};opacity:${isUnlocked?1:.45};transition:.2s;position:relative;backdrop-filter:blur(5px)" ${isUnlocked?`onclick="openCourse('${c.docId}')" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'"`:""}><div style="display:flex;align-items:flex-start;gap:15px"><div style="min-width:44px;height:44px;border-radius:12px;background:${c.allDone?"rgba(0,230,118,.12)":(isUnlocked?"linear-gradient(135deg,rgba(108,99,255,.2),rgba(187,134,252,.2))":"rgba(255,255,255,.05)")};display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0">${statusIcon}</div><div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap"><strong style="font-size:1rem">${d.title}</strong>${dis}<span style="font-size:.7rem;color:var(--text-sub);background:rgba(255,255,255,.06);padding:2px 8px;border-radius:6px">${c.moduleCount} Module</span></div><div style="color:var(--text-sub);font-size:.82rem;margin-top:5px;line-height:1.4">${d.description||""}</div><div style="margin-top:10px;display:flex;align-items:center;gap:10px"><span style="color:${statusColor};font-size:.78rem;font-weight:700">${statusText}</span></div>${isUnlocked&&c.moduleCount>0?`<div style="height:4px;background:rgba(255,255,255,.06);border-radius:3px;margin-top:8px;overflow:hidden"><div style="height:100%;background:${c.allDone?"var(--success)":"var(--gradient)"};width:${progress}%;border-radius:3px;transition:width .4s"></div></div>`:""}</div><div style="display:flex;flex-direction:column;align-items:center;gap:4px">${isAdmin&&!isCoach?`<div style="display:flex;gap:3px">${courseIndex>0?`<button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:26px;height:26px;border-radius:6px;font-size:.7rem;display:flex;align-items:center;justify-content:center" onclick="event.stopPropagation();swapCourseOrder('${c.docId}',${d.order||courseIndex},'up')" title="Nach oben">&#x25B2;</button>`:""}<button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:26px;height:26px;border-radius:6px;font-size:.7rem;display:flex;align-items:center;justify-content:center" onclick="event.stopPropagation();swapCourseOrder('${c.docId}',${d.order||courseIndex},'down')" title="Nach unten">&#x25BC;</button></div><div style="display:flex;gap:3px;margin-top:2px"><button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:26px;height:26px;border-radius:6px;font-size:.7rem" onclick="event.stopPropagation();openEditCourse('${c.docId}')" title="Bearbeiten">&#x270F;&#xFE0E;</button><button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:26px;height:26px;border-radius:6px;font-size:.7rem" onclick="event.stopPropagation();toggleCourseDisabled('${c.docId}',${!!d.disabled})" title="${d.disabled?"Aktivieren":"Deaktivieren"}">&#x1F441;</button><button style="background:rgba(255,255,255,.08);border:none;color:var(--danger);cursor:pointer;width:26px;height:26px;border-radius:6px;font-size:.7rem" onclick="event.stopPropagation();deleteCourse('${c.docId}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button></div>`:""}<span style="color:var(--text-sub);font-size:1.2rem;margin-top:4px">&#x276F;</span></div></div></div>`;
    courseIndex++;
  }
  list.innerHTML=html;
  }catch(e){list.innerHTML="<div style='color:var(--text-sub);text-align:center;padding:30px'>Noch keine Kurse verfuegbar.</div>";}
}
function openCreateCourse(){
  editingCourseId=null;document.getElementById("course-modal-title").innerText="Neuer Kurs";
  document.getElementById("cm-title").value="";document.getElementById("cm-desc").value="";
  document.getElementById("btn-cm-save").innerText="Erstellen";
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("course-modal").classList.remove("hidden");
}
async function openEditCourse(id){
  const doc=await db.collection("courses").doc(id).get();if(!doc.exists)return;const d=doc.data();
  editingCourseId=id;document.getElementById("course-modal-title").innerText="Kurs bearbeiten";
  document.getElementById("cm-title").value=d.title||"";document.getElementById("cm-desc").value=d.description||"";
  document.getElementById("btn-cm-save").innerText="Speichern";
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("course-modal").classList.remove("hidden");
}
async function saveCourseModal(){
  const title=document.getElementById("cm-title").value.trim();const desc=document.getElementById("cm-desc").value.trim();
  if(!title){alert("Titel fehlt!");return;}
  if(editingCourseId){await db.collection("courses").doc(editingCourseId).update({title,description:desc});}
  else{const count=(await db.collection("courses").get()).size;await db.collection("courses").add({title,description:desc,order:count,disabled:false,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}
  editingCourseId=null;closePopup();loadCourses();
}
async function toggleCourseDisabled(id,isDisabled){await db.collection("courses").doc(id).update({disabled:!isDisabled});loadCourses();}
async function deleteCourse(id){if(!confirm("Kurs wirklich loeschen?"))return;await db.collection("courses").doc(id).delete();loadCourses();}
async function swapCourseOrder(courseId,currentOrder,direction){
  const s=await db.collection("courses").orderBy("order","asc").get();
  const docs=s.docs;let idx=docs.findIndex(d=>d.id===courseId);
  const targetIdx=direction==="up"?idx-1:idx+1;
  if(targetIdx<0||targetIdx>=docs.length)return;
  const batch=db.batch();
  batch.update(db.collection("courses").doc(docs[idx].id),{order:targetIdx});
  batch.update(db.collection("courses").doc(docs[targetIdx].id),{order:idx});
  await batch.commit();loadCourses();
}
async function swapModuleOrder(courseId,modId,currentOrder,direction){
  const s=await db.collection("courses").doc(courseId).collection("modules").orderBy("order","asc").get();
  const docs=s.docs;let idx=docs.findIndex(d=>d.id===modId);
  const targetIdx=direction==="up"?idx-1:idx+1;
  if(targetIdx<0||targetIdx>=docs.length)return;
  const batch=db.batch();
  batch.update(db.collection("courses").doc(courseId).collection("modules").doc(docs[idx].id),{order:targetIdx});
  batch.update(db.collection("courses").doc(courseId).collection("modules").doc(docs[targetIdx].id),{order:idx});
  await batch.commit();loadModules(courseId);
}
async function resetCourseProgress(){
  if(!curCourseId||!auth.currentUser)return;
  if(!confirm("Kurs wirklich zuruecksetzen? Dein gesamter Fortschritt wird geloescht."))return;
  const progId=auth.currentUser.uid+"_"+curCourseId;
  await db.collection("course_progress").doc(progId).set({completedModules:[],watchedVideos:[]});
  loadModules(curCourseId);
}
let mdCurrentCourseId=null,mdCurrentModId=null;
async function openNextModule(){
  if(!mdCurrentCourseId)return;
  const mods=await db.collection("courses").doc(mdCurrentCourseId).collection("modules").orderBy("order","asc").get();
  const prog=await getUserCourseProgress(mdCurrentCourseId);
  let nextModId=null;
  for(const d of mods.docs){if(!prog.completedModules.includes(d.id)){nextModId=d.id;break;}}
  closeModuleDetail();
  if(nextModId){openModuleDetail(mdCurrentCourseId,nextModId);}
  else{loadModules(mdCurrentCourseId);}
}
async function openCourse(id){
  curCourseId=id;document.getElementById("course-list").parentElement.classList.add("hidden");document.getElementById("course-detail-area").classList.remove("hidden");
  const doc=await db.collection("courses").doc(id).get();if(!doc.exists)return;const d=doc.data();
  document.getElementById("course-detail-title").innerText=d.title;document.getElementById("course-detail-desc").innerText=d.description||"";
  loadModules(id);
}
function backToCourseList(){document.getElementById("course-list").parentElement.classList.remove("hidden");document.getElementById("course-detail-area").classList.add("hidden");curCourseId=null;}
async function loadModules(courseId){
  const area=document.getElementById("course-modules-list");area.innerHTML="Lade...";
  const s=await db.collection("courses").doc(courseId).collection("modules").orderBy("order","asc").get();
  const addBtn=isAdmin&&!isCoach?`<button style="margin-top:12px;width:100%;padding:14px;background:var(--cell-bg);border:2px dashed var(--border);border-radius:12px;color:var(--accent);cursor:pointer;font-weight:700;font-size:.9rem;transition:.2s" onclick="openAddModule('${courseId}')" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">&#x2795; Modul hinzufuegen</button>`:"";
  if(s.empty){area.innerHTML="<div style='color:var(--text-sub);padding:20px;text-align:center'>Keine Module vorhanden.</div>"+addBtn;return;}
  const progress=await getUserCourseProgress(courseId);
  let html="";let moduleIndex=0;const totalMods=s.docs.length;
  for(const doc of s.docs){
    const m=doc.data();const isUnlocked=moduleIndex===0||progress.completedModules.includes(s.docs[moduleIndex-1].id);
    const isCompleted=progress.completedModules.includes(doc.id);
    const hasQuiz=m.quizQuestions&&m.quizQuestions.length>0;
    const videoWatched=progress.watchedVideos&&progress.watchedVideos.includes(doc.id);
    const statusIcon=isCompleted?"&#x2705;":(isUnlocked?(m.videoUrl&&!videoWatched?"&#x25B6;&#xFE0F;":(hasQuiz?"&#x1F9E0;":"&#x1F4CB;")):"&#x1F512;");
    const statusText=isCompleted?"Abgeschlossen":(isUnlocked?(m.videoUrl&&!videoWatched?"Video ansehen":(hasQuiz?"Quiz verfuegbar":"Bereit")):"Gesperrt");
    const statusColor=isCompleted?"var(--success)":(isUnlocked?"var(--accent)":"var(--text-sub)");
    const borderL=isCompleted?"3px solid var(--success)":(isUnlocked?"3px solid var(--accent)":"3px solid transparent");
    html+=`<div style="background:var(--cell-bg);border:1px solid var(--border);border-left:${borderL};border-radius:12px;padding:16px 18px;margin-bottom:8px;opacity:${isUnlocked?1:.4};cursor:${isUnlocked?"pointer":"default"};transition:.2s;backdrop-filter:blur(5px);${!isUnlocked?"pointer-events:none":""}" ${isUnlocked?`onclick="openModuleDetail('${courseId}','${doc.id}')" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'"`:""}><div style="display:flex;align-items:center;gap:14px"><div style="min-width:38px;height:38px;border-radius:10px;background:${isCompleted?"rgba(0,230,118,.12)":(isUnlocked?"linear-gradient(135deg,rgba(108,99,255,.15),rgba(187,134,252,.15))":"rgba(255,255,255,.04)")};display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0">${statusIcon}</div><div style="flex:1;min-width:0"><div style="font-weight:700;font-size:.95rem">Modul ${moduleIndex+1}: ${m.title}</div><div style="display:flex;align-items:center;gap:8px;margin-top:6px"><span style="color:${statusColor};font-size:.78rem;font-weight:600">${statusText}</span>${hasQuiz?'<span style="font-size:.65rem;color:var(--text-sub);background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px">Quiz</span>':""}${m.videoUrl?'<span style="font-size:.65rem;color:var(--text-sub);background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px">Video</span>':""}</div></div><div style="display:flex;align-items:center;gap:4px;pointer-events:all">${isAdmin&&!isCoach?`${moduleIndex>0?`<button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:24px;height:24px;border-radius:6px;font-size:.65rem;display:flex;align-items:center;justify-content:center" onclick="event.stopPropagation();swapModuleOrder('${courseId}','${doc.id}',${m.order!=null?m.order:moduleIndex},'up')" title="Nach oben">&#x25B2;</button>`:""}<button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:24px;height:24px;border-radius:6px;font-size:.65rem;display:flex;align-items:center;justify-content:center" onclick="event.stopPropagation();swapModuleOrder('${courseId}','${doc.id}',${m.order!=null?m.order:moduleIndex},'down')" title="Nach unten">&#x25BC;</button><button style="background:rgba(255,255,255,.08);border:none;color:var(--text-sub);cursor:pointer;width:24px;height:24px;border-radius:6px;font-size:.65rem" onclick="event.stopPropagation();openEditModule('${courseId}','${doc.id}')" title="Bearbeiten">&#x270F;&#xFE0E;</button><button style="background:rgba(255,255,255,.08);border:none;color:var(--danger);cursor:pointer;width:24px;height:24px;border-radius:6px;font-size:.65rem" onclick="event.stopPropagation();deleteModule('${courseId}','${doc.id}')" title="Loeschen">&#x1F5D1;&#xFE0E;</button>`:""}<span style="color:var(--text-sub);font-size:1rem;margin-left:4px">&#x276F;</span></div></div></div>`;
    moduleIndex++;
  }
  area.innerHTML=html+addBtn;
}
async function openModuleDetail(courseId,modId){
  mdCurrentCourseId=courseId;mdCurrentModId=modId;
  const doc=await db.collection("courses").doc(courseId).collection("modules").doc(modId).get();
  if(!doc.exists)return;const m=doc.data();
  const progress=await getUserCourseProgress(courseId);
  const isCompleted=progress.completedModules.includes(modId);
  const videoWatched=progress.watchedVideos&&progress.watchedVideos.includes(modId);
  const hasQuiz=m.quizQuestions&&m.quizQuestions.length>0;
  document.getElementById("md-title").innerText=m.title||"Modul";
  document.getElementById("md-subtitle").innerText=hasQuiz?"Video & Quiz":(m.videoUrl?"Video & Lernmaterial":"Lernmaterial");
  const va=document.getElementById("md-video-area");const da=document.getElementById("md-desc-area");
  const doa=document.getElementById("md-doc-area");const qa=document.getElementById("md-quiz-area");
  const vh=document.getElementById("md-video-hint");const ca=document.getElementById("md-completed-area");
  const nqh=document.getElementById("md-no-quiz-hint");const nb=document.getElementById("md-next-btn");
  va.classList.add("hidden");da.classList.add("hidden");doa.classList.add("hidden");qa.classList.add("hidden");vh.classList.add("hidden");ca.classList.add("hidden");nqh.classList.add("hidden");nb.classList.add("hidden");
  if(m.videoUrl){
    va.classList.remove("hidden");const player=document.getElementById("md-player");player.src=m.videoUrl;
    player.onended=async function(){
      await markVideoWatched(courseId,modId);
      if(!hasQuiz){
        await completeModule(courseId,modId);
        ca.classList.remove("hidden");nb.classList.remove("hidden");
        va.classList.add("hidden");nqh.classList.add("hidden");
        loadModules(courseId);
      }else{
        const player2=document.getElementById("md-player");player2.pause();
        va.classList.add("hidden");nqh.classList.add("hidden");vh.classList.add("hidden");
        qa.classList.remove("hidden");
        document.getElementById("md-quiz-btn").onclick=function(){startQuiz(courseId,modId);};
      }
    };
    if(!videoWatched&&!isCompleted){
      const markBtn=document.createElement("div");
      markBtn.style.cssText="text-align:center;margin-top:10px;padding:0 20px 10px";
      markBtn.innerHTML=`<button style="font-size:.8rem;padding:10px 20px;background:rgba(255,255,255,.08);border:1px solid var(--border);color:var(--text-main);border-radius:10px;cursor:pointer;font-weight:600;transition:.2s;width:100%" onclick="manualMarkWatched('${courseId}','${modId}',${hasQuiz})" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">&#x2705; Video komplett angesehen</button>`;
      va.appendChild(markBtn);
    }
  }
  if(m.description){da.classList.remove("hidden");document.getElementById("md-desc-text").innerText=m.description;}
  if(m.docUrl){doa.classList.remove("hidden");document.getElementById("md-doc-link").href=m.docUrl;}
  if(isCompleted){ca.classList.remove("hidden");nb.classList.remove("hidden");}
  else if(hasQuiz){
    if(!m.videoUrl||videoWatched){qa.classList.remove("hidden");document.getElementById("md-quiz-btn").onclick=function(){startQuiz(courseId,modId);};}
    else{vh.classList.remove("hidden");}
  }else if(m.videoUrl&&!videoWatched){nqh.classList.remove("hidden");}
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("module-detail-modal").classList.remove("hidden");
}
function closeModuleDetail(){
  const player=document.getElementById("md-player");if(player){player.pause();player.src="";}
  document.getElementById("module-detail-modal").classList.add("hidden");
  document.getElementById("popup-overlay").classList.remove("open");
  const va=document.getElementById("md-video-area");
  const markBtns=va.querySelectorAll("div:last-child");markBtns.forEach(b=>{if(b.querySelector("button[onclick*='manualMarkWatched']"))b.remove();});
}
async function getUserCourseProgress(courseId){
  if(!auth.currentUser)return{completedModules:[],watchedVideos:[]};
  try{const doc=await db.collection("course_progress").doc(auth.currentUser.uid+"_"+courseId).get();
  const d=doc.exists?doc.data():{};return{completedModules:d.completedModules||[],watchedVideos:d.watchedVideos||[]};}catch(e){return{completedModules:[],watchedVideos:[]};}
}
function resetModuleModal(){
  document.getElementById("mm-title").value="";document.getElementById("mm-desc").value="";
  document.getElementById("mm-video-url").value="";document.getElementById("mm-video-file").value="";
  document.getElementById("mm-video-url-input").value="";document.getElementById("mm-doc-url").value="";
  document.getElementById("mm-doc-file").value="";document.getElementById("mm-doc-url-input").value="";
  document.getElementById("mm-upload-progress").classList.add("hidden");
  document.getElementById("mm-upload-error").classList.add("hidden");
  document.getElementById("mm-doc-progress").classList.add("hidden");
  document.getElementById("mm-video-preview").classList.add("hidden");
  document.getElementById("mm-doc-preview").classList.add("hidden");
}
function openAddModule(courseId){
  editingModuleId=null;editingModuleCourseId=courseId;tempQuizQuestions=[];
  document.getElementById("module-modal-title").innerText="Neues Modul";
  resetModuleModal();
  document.getElementById("btn-mm-save").innerText="Erstellen";
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("module-modal").classList.remove("hidden");
}
async function openEditModule(courseId,modId){
  const doc=await db.collection("courses").doc(courseId).collection("modules").doc(modId).get();
  if(!doc.exists)return;const m=doc.data();
  editingModuleId=modId;editingModuleCourseId=courseId;tempQuizQuestions=m.quizQuestions||[];
  document.getElementById("module-modal-title").innerText="Modul bearbeiten";
  resetModuleModal();
  document.getElementById("mm-title").value=m.title||"";document.getElementById("mm-desc").value=m.description||"";
  document.getElementById("mm-video-url").value=m.videoUrl||"";
  document.getElementById("mm-doc-url").value=m.docUrl||"";
  if(m.videoUrl){
    document.getElementById("mm-video-preview").classList.remove("hidden");
    document.getElementById("mm-video-player").src=m.videoUrl;
    document.getElementById("mm-video-url-input").value=m.videoUrl;
  }
  if(m.docUrl){
    document.getElementById("mm-doc-preview").classList.remove("hidden");
    document.getElementById("mm-doc-url-input").value=m.docUrl;
  }
  document.getElementById("btn-mm-save").innerText="Speichern";
  updateQuizBtnLabel();
  document.getElementById("popup-overlay").classList.add("open");document.getElementById("module-modal").classList.remove("hidden");
}
function handleVideoSelect(input){
  const file=input.files[0];if(!file)return;
  if(!file.type.startsWith("video/")){alert("Bitte eine MP4-Videodatei waehlen.");return;}
  if(file.size>500*1024*1024){alert("Datei zu gross (max 500MB).");return;}
  document.getElementById("mm-upload-error").classList.add("hidden");
  document.getElementById("mm-upload-progress").classList.remove("hidden");
  document.getElementById("mm-upload-status").innerText="Hochladen... 0%";
  const fileName=Date.now()+"_"+file.name.replace(/[^a-zA-Z0-9._-]/g,"");
  const ref=storage.ref("courses/videos/"+fileName);
  const md={contentType:file.type,customMetadata:{uploadedBy:auth.currentUser.uid}};
  const task=ref.put(file,md);
  task.on("state_changed",
    snap=>{const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      document.getElementById("mm-progress-bar").style.width=pct+"%";
      document.getElementById("mm-upload-status").innerText="Hochladen... "+pct+"%";},
    err=>{document.getElementById("mm-upload-progress").classList.add("hidden");
      const errEl=document.getElementById("mm-upload-error");errEl.classList.remove("hidden");
      if(err.code==="storage/unauthorized"||err.code==="storage/retry-limit-exceeded"){
        errEl.innerHTML="<b>Firebase Storage nicht konfiguriert.</b><br><br>Gehe zu <b>Firebase Console</b> > Storage > Rules und setze:<br><code style='background:#222;padding:4px 8px;border-radius:4px;display:block;margin-top:8px'>allow read, write: if request.auth != null;</code><br>Alternativ: Video auf <b>Google Drive</b> oder <b>YouTube</b> hochladen und den Link oben einfuegen.";
      }else{errEl.innerHTML="Upload fehlgeschlagen: "+err.message+"<br>Nutze stattdessen das URL-Feld oben.";}},
    ()=>{task.snapshot.ref.getDownloadURL().then(url=>{
      setVideoUrl(url);
      document.getElementById("mm-upload-progress").classList.add("hidden");
    });}
  );
}
function handleDocSelect(input){
  const file=input.files[0];if(!file)return;
  if(file.size>50*1024*1024){alert("Datei zu gross (max 50MB).");return;}
  document.getElementById("mm-doc-progress").classList.remove("hidden");
  const fileName=Date.now()+"_"+file.name.replace(/[^a-zA-Z0-9._-]/g,"");
  const ref=storage.ref("courses/docs/"+fileName);
  const task=ref.put(file,{contentType:file.type});
  task.on("state_changed",
    snap=>{const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      document.getElementById("mm-doc-bar").style.width=pct+"%";
      document.getElementById("mm-doc-status").innerText="Hochladen... "+pct+"%";},
    err=>{document.getElementById("mm-doc-progress").classList.add("hidden");
      alert("Dokument-Upload fehlgeschlagen.\nFirebase Storage Regeln pruefen oder URL-Feld nutzen.");},
    ()=>{task.snapshot.ref.getDownloadURL().then(url=>{
      setDocUrl(url);
      document.getElementById("mm-doc-progress").classList.add("hidden");
    });}
  );
}
function setVideoUrl(url){
  document.getElementById("mm-video-url").value=url;
  document.getElementById("mm-video-url-input").value=url;
  document.getElementById("mm-video-preview").classList.remove("hidden");
  document.getElementById("mm-video-player").src=url;
}
function setDocUrl(url){
  document.getElementById("mm-doc-url").value=url;
  document.getElementById("mm-doc-url-input").value=url;
  document.getElementById("mm-doc-preview").classList.remove("hidden");
}
function removeModuleVideo(){
  document.getElementById("mm-video-url").value="";document.getElementById("mm-video-url-input").value="";
  document.getElementById("mm-video-preview").classList.add("hidden");
  document.getElementById("mm-video-player").src="";
  document.getElementById("mm-video-file").value="";
}
function removeModuleDoc(){
  document.getElementById("mm-doc-url").value="";document.getElementById("mm-doc-url-input").value="";
  document.getElementById("mm-doc-preview").classList.add("hidden");
  document.getElementById("mm-doc-file").value="";
}
async function saveModuleModal(){
  const title=document.getElementById("mm-title").value.trim();
  if(!title){alert("Titel fehlt!");return;}
  const desc=document.getElementById("mm-desc").value.trim();
  const videoUrl=document.getElementById("mm-video-url-input").value.trim()||document.getElementById("mm-video-url").value;
  const docUrl=document.getElementById("mm-doc-url-input").value.trim()||document.getElementById("mm-doc-url").value;
  if(editingModuleId){
    await db.collection("courses").doc(editingModuleCourseId).collection("modules").doc(editingModuleId).update({title,description:desc,videoUrl,docUrl,quizQuestions:tempQuizQuestions});
  }else{
    const count=(await db.collection("courses").doc(editingModuleCourseId).collection("modules").get()).size;
    await db.collection("courses").doc(editingModuleCourseId).collection("modules").add({title,description:desc,videoUrl,docUrl,quizQuestions:tempQuizQuestions,order:count});
  }
  closePopup();if(curCourseId)loadModules(curCourseId);
}
function openQuizEditor(){
  openOnLayer2("quiz-edit-modal");
  renderQuizEditor();
}
function updateQuizBtnLabel(){const btn=document.getElementById("btn-mm-quiz");if(btn)btn.innerHTML=tempQuizQuestions.length?`&#x1F9E0; Quiz (${tempQuizQuestions.length} Fragen)`:"&#x1F9E0; Quiz";}
function closeQuizEditor(){
  closeLayer2AndReturn("quiz-edit-modal");
}
function renderQuizEditor(){
  const area=document.getElementById("qe-questions");
  if(!tempQuizQuestions.length){area.innerHTML="<div style='color:var(--text-sub);text-align:center;padding:15px;font-size:.85rem'>Noch keine Fragen. Klicke unten um eine hinzuzufuegen.</div>";return;}
  area.innerHTML=tempQuizQuestions.map((q,qi)=>{
    let html=`<div class="quiz-q-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><label style="margin:0">Frage ${qi+1}</label><button class="btn-icon" onclick="removeQuizQuestion(${qi})" title="Entfernen" style="font-size:.75rem">&#x1F5D1;&#xFE0E;</button></div>`;
    html+=`<input type="text" value="${(q.q||"").replace(/"/g,"&quot;")}" onchange="tempQuizQuestions[${qi}].q=this.value" placeholder="Frage..." style="margin-bottom:8px">`;
    const answers=q.a||["","",""];
    answers.forEach((a,ai)=>{
      html+=`<div class="quiz-answer-row"><input type="radio" name="quiz-correct-${qi}" ${q.correct===ai?"checked":""} onchange="tempQuizQuestions[${qi}].correct=${ai}"><input type="text" value="${(a||"").replace(/"/g,"&quot;")}" onchange="tempQuizQuestions[${qi}].a[${ai}]=this.value" placeholder="Antwort ${ai+1}"></div>`;
    });
    html+=`<button class="btn-small" onclick="addQuizAnswer(${qi})" style="font-size:.7rem;margin-top:4px">+ Antwort</button></div>`;
    return html;
  }).join("");
}
function addQuizQuestion(){
  tempQuizQuestions.push({q:"",a:["","",""],correct:0});
  renderQuizEditor();
}
function removeQuizQuestion(idx){
  tempQuizQuestions.splice(idx,1);
  renderQuizEditor();
}
function addQuizAnswer(qi){
  tempQuizQuestions[qi].a.push("");
  renderQuizEditor();
}
function saveQuizToModule(){
  const valid=tempQuizQuestions.filter(q=>q.q&&q.a.some(a=>a));
  tempQuizQuestions=valid;
  closeQuizEditor();updateQuizBtnLabel();
}
let vpmCourseId=null,vpmModId=null,vpmHasQuiz=false;
function openVideoPopup(encodedUrl,courseId,modId,hasQuiz){
  const url=decodeURIComponent(encodedUrl);
  vpmCourseId=courseId;vpmModId=modId;vpmHasQuiz=hasQuiz;
  document.getElementById("vpm-title").innerText="Video";
  const player=document.getElementById("vpm-player");player.src=url;
  player.onended=function(){onVideoEnded(courseId,modId,hasQuiz);};
  const mdOpen=!document.getElementById("module-detail-modal").classList.contains("hidden");
  if(mdOpen){openOnLayer2("video-player-modal");}
  else{document.getElementById("popup-overlay").classList.add("open");document.getElementById("video-player-modal").classList.remove("hidden");}
}
function closeVideoPopup(){
  const player=document.getElementById("vpm-player");player.pause();player.src="";
  const onLayer2=document.getElementById("video-player-modal").classList.contains("modal-layer2");
  if(onLayer2){closeLayer2AndReturn("video-player-modal");}
  else{document.getElementById("video-player-modal").classList.add("hidden");document.getElementById("popup-overlay").classList.remove("open");}
}
async function manualMarkWatched(courseId,modId,hasQuiz){
  await markVideoWatched(courseId,modId);
  if(!hasQuiz){
    await completeModule(courseId,modId);
    document.getElementById("md-video-area").classList.add("hidden");
    document.getElementById("md-no-quiz-hint").classList.add("hidden");
    document.getElementById("md-completed-area").classList.remove("hidden");
    document.getElementById("md-next-btn").classList.remove("hidden");
    loadModules(courseId);
  }else{
    const va=document.getElementById("md-video-area");const vh=document.getElementById("md-video-hint");const nqh=document.getElementById("md-no-quiz-hint");const qa=document.getElementById("md-quiz-area");
    const player=document.getElementById("md-player");player.pause();
    va.classList.add("hidden");vh.classList.add("hidden");nqh.classList.add("hidden");
    qa.classList.remove("hidden");document.getElementById("md-quiz-btn").onclick=function(){startQuiz(courseId,modId);};
  }
}
async function markVideoWatched(courseId,modId){
  const progId=auth.currentUser.uid+"_"+courseId;
  const progDoc=await db.collection("course_progress").doc(progId).get();
  const watched=progDoc.exists&&progDoc.data().watchedVideos?progDoc.data().watchedVideos:[];
  if(!watched.includes(modId)){watched.push(modId);await db.collection("course_progress").doc(progId).set({watchedVideos:watched},{merge:true});}
}
async function onVideoEnded(courseId,modId,hasQuiz){
  await markVideoWatched(courseId,modId);
  if(!hasQuiz){await completeModule(courseId,modId);}
  closeVideoPopup();loadModules(courseId);
}
async function completeModule(courseId,modId){
  const progId=auth.currentUser.uid+"_"+courseId;
  const progDoc=await db.collection("course_progress").doc(progId).get();
  const d=progDoc.exists?progDoc.data():{};
  const completed=d.completedModules||[];
  if(!completed.includes(modId)){completed.push(modId);await db.collection("course_progress").doc(progId).set({completedModules:completed},{merge:true});}
}
async function deleteModule(courseId,modId){if(!confirm("Modul loeschen?"))return;await db.collection("courses").doc(courseId).collection("modules").doc(modId).delete();loadModules(courseId);}
let quizState={questions:[],current:0,correct:0,selected:-1,answered:false,courseId:"",modId:""};
let quizOnLayer2=false;
async function startQuiz(courseId,modId){
  const doc=await db.collection("courses").doc(courseId).collection("modules").doc(modId).get();if(!doc.exists)return;
  const m=doc.data();const questions=m.quizQuestions;if(!questions||!questions.length){alert("Kein Quiz vorhanden.");return;}
  quizState={questions,current:0,correct:0,selected:-1,answered:false,courseId,modId};
  document.getElementById("qp-result").classList.add("hidden");
  document.getElementById("qp-question").parentElement.style.display="";
  const mdOpen=!document.getElementById("module-detail-modal").classList.contains("hidden");
  quizOnLayer2=mdOpen;
  if(mdOpen){openOnLayer2("quiz-play-modal");}
  else{document.getElementById("popup-overlay").classList.add("open");document.getElementById("quiz-play-modal").classList.remove("hidden");}
  renderQuizQuestion();
}
function closeQuizPopup(){
  if(quizOnLayer2){closeLayer2AndReturn("quiz-play-modal");quizOnLayer2=false;}
  else{document.getElementById("quiz-play-modal").classList.add("hidden");document.getElementById("popup-overlay").classList.remove("open");}
}
function renderQuizQuestion(){
  const qs=quizState;const q=qs.questions[qs.current];
  document.getElementById("qp-header").innerText="Quiz";
  document.getElementById("qp-progress").innerText="Frage "+(qs.current+1)+" / "+qs.questions.length;
  document.getElementById("qp-question").innerText=q.q;
  document.getElementById("qp-feedback").classList.add("hidden");
  document.getElementById("qp-btn-next").disabled=true;
  qs.selected=-1;qs.answered=false;
  document.getElementById("qp-answers").innerHTML=q.a.map((a,i)=>`<button class="qp-answer-btn" onclick="selectQuizAnswer(${i})">${a}</button>`).join("");
}
function selectQuizAnswer(idx){
  const qs=quizState;if(qs.answered)return;
  qs.selected=idx;qs.answered=true;
  const q=qs.questions[qs.current];const isCorrect=idx===q.correct;
  if(isCorrect)qs.correct++;
  const btns=document.getElementById("qp-answers").querySelectorAll(".qp-answer-btn");
  btns.forEach((btn,i)=>{
    btn.style.pointerEvents="none";
    if(i===q.correct)btn.classList.add("correct");
    if(i===idx&&!isCorrect)btn.classList.add("wrong");
    if(i===idx)btn.classList.add("selected");
  });
  const fb=document.getElementById("qp-feedback");fb.classList.remove("hidden");
  fb.style.background=isCorrect?"rgba(0,200,83,.15)":"rgba(255,61,0,.15)";
  fb.style.color=isCorrect?"var(--success)":"var(--danger)";
  fb.innerText=isCorrect?"Richtig!":"Falsch! Richtige Antwort: "+q.a[q.correct];
  const btn=document.getElementById("qp-btn-next");btn.disabled=false;
  btn.innerText=qs.current<qs.questions.length-1?"Naechste Frage":"Ergebnis anzeigen";
}
function quizNext(){
  const qs=quizState;
  if(qs.current<qs.questions.length-1){qs.current++;renderQuizQuestion();return;}
  const pct=Math.round((qs.correct/qs.questions.length)*100);
  const passed=pct>=80;
  document.getElementById("qp-question").parentElement.style.display="none";
  const res=document.getElementById("qp-result");res.classList.remove("hidden");
  document.getElementById("qp-result-icon").innerHTML=passed?"&#x1F389;":"&#x274C;";
  document.getElementById("qp-result-title").innerText=passed?"Bestanden!":"Nicht bestanden";
  document.getElementById("qp-result-title").style.color=passed?"var(--success)":"var(--danger)";
  document.getElementById("qp-result-text").innerText=qs.correct+"/"+qs.questions.length+" richtig ("+pct+"%)."+(passed?"":" Mindestens 80% noetig.");
  const resultBtn=document.getElementById("qp-result-btn");
  resultBtn.removeAttribute("onclick");
  const savedCourseId=qs.courseId;const savedModId=qs.modId;
  if(passed){
    resultBtn.innerText="Weiter >";
    resultBtn.onclick=async function(){
      try{
        resultBtn.disabled=true;resultBtn.innerText="Lade...";
        await completeModule(savedCourseId,savedModId);
        const mods=await db.collection("courses").doc(savedCourseId).collection("modules").orderBy("order","asc").get();
        const prog=await getUserCourseProgress(savedCourseId);
        let nextModId=null;
        for(const d of mods.docs){if(!prog.completedModules.includes(d.id)){nextModId=d.id;break;}}
        /* close all popups cleanly */
        document.getElementById("quiz-play-modal").classList.add("hidden");
        document.getElementById("quiz-play-modal").classList.remove("modal-layer2");
        document.getElementById("popup-overlay-2").classList.remove("open");
        quizOnLayer2=false;
        const mdPlayer=document.getElementById("md-player");if(mdPlayer){mdPlayer.pause();mdPlayer.src="";}
        document.getElementById("module-detail-modal").classList.add("hidden");
        document.getElementById("popup-overlay").classList.remove("open");
        await loadModules(savedCourseId);
        if(nextModId){setTimeout(()=>openModuleDetail(savedCourseId,nextModId),250);}
      }catch(e){console.error("Weiter-Button Fehler:",e);resultBtn.innerText="Weiter >";resultBtn.disabled=false;}
    };
  }else{
    resultBtn.innerText="Erneut versuchen";
    resultBtn.onclick=function(){closeQuizPopup();startQuiz(savedCourseId,savedModId);};
  }
}
const ASSET_LIST=[
{s:"EURUSD",c:"Forex"},{s:"GBPUSD",c:"Forex"},{s:"USDJPY",c:"Forex"},{s:"USDCHF",c:"Forex"},{s:"AUDUSD",c:"Forex"},{s:"NZDUSD",c:"Forex"},{s:"USDCAD",c:"Forex"},{s:"EURGBP",c:"Forex"},{s:"EURJPY",c:"Forex"},{s:"GBPJPY",c:"Forex"},{s:"EURAUD",c:"Forex"},{s:"EURCHF",c:"Forex"},{s:"AUDCAD",c:"Forex"},{s:"AUDJPY",c:"Forex"},{s:"GBPCAD",c:"Forex"},{s:"GBPCHF",c:"Forex"},{s:"CADJPY",c:"Forex"},{s:"NZDJPY",c:"Forex"},{s:"AUDNZD",c:"Forex"},{s:"CADCHF",c:"Forex"},
{s:"XAUUSD",c:"Metall"},{s:"XAGUSD",c:"Metall"},
{s:"US30",c:"Index"},{s:"NAS100",c:"Index"},{s:"SPX500",c:"Index"},{s:"GER40",c:"Index"},{s:"UK100",c:"Index"},{s:"JPN225",c:"Index"},
{s:"BTCUSD",c:"Crypto"},{s:"ETHUSD",c:"Crypto"},{s:"XRPUSD",c:"Crypto"},{s:"SOLUSD",c:"Crypto"},
{s:"USOIL",c:"Rohstoff"},{s:"UKOIL",c:"Rohstoff"},{s:"NATGAS",c:"Rohstoff"}
];
function showAssetDropdown(input,ddId){
  const dd=document.getElementById(ddId);const v=input.value.toUpperCase().trim();
  const filtered=v?ASSET_LIST.filter(a=>a.s.includes(v)):ASSET_LIST;
  if(!filtered.length){dd.classList.remove("open");return;}
  dd.innerHTML=filtered.slice(0,12).map(a=>`<div class="asset-dropdown-item" onmousedown="selectAsset('${input.id}','${a.s}','${ddId}')"><span>${a.s}</span><span class="asset-dd-cat">${a.c}</span></div>`).join("");
  dd.classList.add("open");
  input.onblur=function(){setTimeout(()=>dd.classList.remove("open"),150);};
}
function selectAsset(inputId,symbol,ddId){document.getElementById(inputId).value=symbol;document.getElementById(ddId).classList.remove("open");}

// â”€â”€â”€ KI-ASSISTENT (Gemini) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _GK='gsk_kdobgI6P6Z6yjxMpvwTk'+'WGdyb3FYz0bVlUXloHlUXCJ4cePBLHsc';
const _GM='llama-3.1-8b-instant';
const _GMV='meta-llama/llama-4-scout-17b-16e-instruct';
const _GU='https://api.groq.com/openai/v1/chat/completions';
console.log('[KI] Modell aktiv:',_GM);
let _kiHistory=[];

// â”€â”€â”€ STRATEGIE DES NUTZERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _STRATEGY=`
WICHTIG â€“ Das ist die exakte Trading-Strategie des Nutzers (Smart Money Concepts / SMC):

SCHRITT 1 â€“ LIQUIDITY SWEEP:
  Der Markt macht einen gezielten Run auf ein vorheriges High (Buy-Side Liquidity) oder Low (Sell-Side Liquidity).
  Dabei werden Stopps anderer Trader abgeholt. Dieser Sweep ist das erste BestÃ¤tigungssignal.

SCHRITT 2 â€“ BREAK OF STRUCTURE (BOS):
  Direkt nach dem Sweep bricht der Markt eine wichtige Struktur in die entgegengesetzte Richtung.
  Bullish: Sweep des Lows â†’ BOS nach oben (hÃ¶heres High).
  Bearish: Sweep des Highs â†’ BOS nach unten (tieferes Low).
  Der BOS bestÃ¤tigt, dass die RichtungsÃ¤nderung real ist.

SCHRITT 3 â€“ ENTRY BEI FIBONACCI-RETRACEMENT (0.618 oder 0.718):
  Nach dem BOS zieht der Markt zurÃ¼ck. Der Entry liegt beim Retracement auf:
    - 0.618 Fibonacci-Level (Golden Ratio) â€” primÃ¤res Ziel
    - 0.718 Fibonacci-Level â€” alternatives / tieferes Entry-Level
  An diesen Levels reagiert der Markt typischerweise mit der erwarteten Bewegung.

BEISPIEL LONG-SETUP:
  1. Markt swept das letzte Swing-Low (Sell-Side Liquidity wird abgeholt)
  2. Starker Anstieg â†’ BOS nach oben (bullishes Momentum)
  3. Retracement zurÃ¼ck auf 0.618 oder 0.718 Fib der letzten AufwÃ¤rtsbewegung = ENTRY LONG

BEISPIEL SHORT-SETUP:
  1. Markt swept das letzte Swing-High (Buy-Side Liquidity wird abgeholt)
  2. Starker Absturz â†’ BOS nach unten (bearishes Momentum)
  3. Retracement zurÃ¼ck auf 0.618 oder 0.718 Fib der letzten AbwÃ¤rtsbewegung = ENTRY SHORT

ZUSÃ„TZLICHE BESTÃ„TIGUNGEN (erhÃ¶hen die Setup-QualitÃ¤t):

TREND-KONTEXT:
  Identifiziere den Ã¼bergeordneten Trend (Higher Highs & Higher Lows = bullish / Lower Highs & Lower Lows = bearish).
  Ein Long-Setup ist nur in einem bullischen Trend valide. Ein Short-Setup nur in einem bÃ¤rischen Trend.
  Counter-Trend-Setups gelten automatisch als schwÃ¤cher und riskanter.

ORDER BLOCK (OB):
  Eine Order Block Zone ist die letzte bearishe Candle vor einer starken bullischen Bewegung (Bullisher OB)
  bzw. die letzte bullishe Candle vor einer starken bÃ¤rischen Bewegung (BÃ¤rischer OB).
  Ein Entry im Bereich des 0.618/0.718 Fib, der auch mit einem OB Ã¼bereinstimmt, ist eine sehr starke BestÃ¤tigung.

FAIR VALUE GAP (FVG):
  Ein FVG entsteht, wenn zwischen drei Kerzen eine LÃ¼cke bleibt (die Dochte der ersten und dritten Kerze Ã¼berschneiden sich nicht).
  LÃ¤uft der Preis in einen FVG im Bereich des Fib-Entrys zurÃ¼ck, ist das eine starke BestÃ¤tigung fÃ¼r den Entry.

BEWERTUNGSSTUFEN:
  GUTER TRADE      â€“ Alle 5 erfÃ¼llt: Sweep + BOS + Fib-Entry + Trend passt + mind. OB oder FVG vorhanden.
  RISKANTER TRADE  â€“ Kernbedingungen (Sweep, BOS, Fib) erfÃ¼llt, aber Trend oder OB/FVG fehlen (3â€“4 von 5).
  SCHLECHTER TRADE â€“ Mindestens eine Kernbedingung (Sweep, BOS oder Fib) fehlt.

Beurteile JEDEN Aspekt immer anhand dieser Strategie. Wenn Trades oder Charts analysiert werden,
prÃ¼fe ob Liquidity Sweep, BOS, das 0.618/0.718 Fib-Level, der Trend-Kontext und OB/FVG-BestÃ¤tigungen vorhanden sind.
`;

function switchKITab(tab){
  ['chat','analyse','chart'].forEach(t=>{
    document.getElementById('ki-tab-'+t).classList.toggle('active',t===tab);
    document.getElementById('ki-panel-'+t).classList.toggle('hidden',t!==tab);
  });
  if(tab==='analyse')_kiPopulateTradeSelect();
}

async function kiRateNewTrade(data){
  const promptText=`Du bist ein Trading-Coach. Bewerte diesen Trade anhand der SMC-Strategie (Liquidity Sweep â†’ BOS â†’ 0.618/0.718 Fib-Entry).\n\n${_STRATEGY}\n\nTrade-Daten: Asset: ${data.asset} | Status: ${data.status} | PnL: ${data.pnl}â‚¬ | Entry: ${data.entry||'-'} | SL: ${data.sl||'-'} | TP1: ${data.tp1||'-'} | Notiz: ${data.note||'-'}\n\nAnalysiere die beigefÃ¼gten Chart-Screenshots (falls vorhanden) und bewerte ob der Trade die Strategie erfÃ¼llt.\n\nAntworte NUR in diesem Format:\nBEWERTUNG: GUTER_TRADE oder SCHLECHTER_TRADE\nGRUND: (max. 1 Satz)`;
  const rawImgs=[data.imgSetup,data.imgResult].filter(Boolean);
  const useVision=rawImgs.length>0;
  let msgContent;
  if(useVision){
    const compressed=await Promise.all(rawImgs.map(u=>_compressImg(u)));
    msgContent=compressed.map(url=>({type:'image_url',image_url:{url}}));
    msgContent.push({type:'text',text:promptText});
  }else{
    msgContent=promptText;
  }
  try{
    const r=await fetch(_GU,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+_GK},body:JSON.stringify({model:useVision?_GMV:_GM,messages:[{role:'user',content:msgContent}],temperature:0.3,max_tokens:80})});
    if(!r.ok){console.error('[KiRate] Groq error:',r.status);return;}
    const d=await r.json();
    const txt=d.choices?.[0]?.message?.content||'';
    const isGood=txt.includes('GUTER_TRADE');
    const grund=(txt.split('GRUND:')[1]||'').trim();
    _showKIToast(isGood?'âœ… Guter Trade':'âŒ Schlechter Trade',grund,isGood);
  }catch(e){console.error('[KiRate] Fehler:',e);}
}
function _showKIToast(title,text,isGood){
  const ex=document.getElementById('ki-toast');if(ex)ex.remove();
  const t=document.createElement('div');t.id='ki-toast';
  t.style.cssText=`position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:${isGood?'rgba(48,209,88,.15)':'rgba(255,69,58,.15)'};border:2px solid ${isGood?'#30d158':'#ff453a'};color:#fff;padding:14px 22px;border-radius:16px;z-index:9999;text-align:center;max-width:88vw;box-shadow:0 4px 24px rgba(0,0,0,.6);animation:fadeIn .3s`;
  t.innerHTML=`<div style="font-weight:800;font-size:1.05rem;margin-bottom:4px">${title}</div><div style="font-size:.85rem;opacity:.8">${text}</div>`;
  document.body.appendChild(t);setTimeout(()=>t.remove(),6000);
}
function _kiPopulateTradeSelect(){
  const sel=document.getElementById('ki-trade-select');
  if(!sel)return;
  const all=(trades||[]).filter(t=>(t.journal||'Main')===activeJournal);
  const sorted=[...all].filter(t=>t.status==='Geschlossen'||!t.status).sort((a,b)=>new Date(b.date)-new Date(a.date));
  const prev=sel.value;
  sel.innerHTML='<option value="">&#x1F4CA; Alle Trades (Portfolio-Analyse)</option>';
  sorted.forEach(t=>{
    const pnl=parseFloat(t.pnl)||0;
    const icon=pnl>0?'\u2705':'\u274C';
    const opt=document.createElement('option');
    opt.value=t.id;
    opt.textContent=icon+' '+(t.date||'-')+' | '+(t.asset||'-')+' '+(t.direction||'-')+' | PnL: '+pnl.toFixed(2)+'\u20AC';
    sel.appendChild(opt);
  });
  if(prev)sel.value=prev;
}

function _kiTradeCtx(){
  const all=(trades||[]).filter(t=>(t.journal||'Main')===activeJournal);
  if(!all.length)return'Noch keine Trades im Journal.';
  const wins=all.filter(t=>parseFloat(t.pnl)>0).length;
  const pnl=all.reduce((s,t)=>s+(parseFloat(t.pnl)||0),0);
  const pairs=[...new Set(all.map(t=>t.asset))].slice(0,10).join(', ');
  const recent=all.slice(-10).map(t=>`${t.asset||'-'} ${t.direction||'-'} PnL:${t.pnl||0} Datum:${t.date||'-'}`).join('\n');
  return`Gesamttrades: ${all.length} | Wins: ${wins} | Winrate: ${Math.round(wins/all.length*100)}% | Gesamt-PnL: ${pnl.toFixed(2)}\nInstrumente: ${pairs}\nLetzte 10 Trades:\n${recent}`;
}

async function _gemini(contents){
  const messages=contents.map(c=>({role:c.role==='model'?'assistant':'user',content:c.parts.map(p=>p.text).join('')}));
  const r=await fetch(_GU,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+_GK},body:JSON.stringify({model:_GM,messages,temperature:0.7,max_tokens:400})});
  if(!r.ok){
    let errMsg='HTTP '+r.status;
    try{const ed=await r.json();errMsg+=' â€“ '+(ed?.error?.message||JSON.stringify(ed));}catch(_){}
    throw new Error(errMsg);
  }
  const d=await r.json();
  return d.choices?.[0]?.message?.content||'Keine Antwort erhalten.';
}

async function sendKIChat(){
  const inp=document.getElementById('ki-chat-input');
  const txt=inp.value.trim();if(!txt)return;
  inp.value='';inp.style.height='110px';
  _kiAppend(txt,'user');
  const box=document.getElementById('ki-messages');
  const dot=document.createElement('div');dot.className='ki-typing';dot.id='ki-dot';
  dot.innerHTML='<span></span><span></span><span></span>';
  box.appendChild(dot);box.scrollTop=box.scrollHeight;
  const sys=`Du bist ein professioneller Trading-Coach fÃ¼r eine Trading-Journal-App. Antworte immer auf Deutsch, sehr kurz und prÃ¤gnant (max. 3-4 SÃ¤tze). Keine langen ErklÃ¤rungen, kein FÃ¼lltext â€“ nur das Wesentliche.\n\n${_STRATEGY}\n\nTrading-Daten des Nutzers:\n${_kiTradeCtx()}\n\nBeziehe dich bei allen Antworten auf die Strategie des Nutzers (Liquidity Sweep â†’ BOS â†’ 0.618/0.718 Fib-Entry). Sei direkt und konkret.`;
  _kiHistory.push({role:'user',parts:[{text:txt}]});
  const ctx=_kiHistory.slice(-8);ctx[0]={role:'user',parts:[{text:sys+'\n\nFrage: '+txt}]};
  try{
    const rep=await _gemini(ctx);
    document.getElementById('ki-dot')?.remove();
    _kiAppend(rep,'ai');
    _kiHistory.push({role:'model',parts:[{text:rep}]});
  }catch(e){
    document.getElementById('ki-dot')?.remove();
    _kiAppend('Fehler: '+(e.message||'KI nicht erreichbar'),'ai');
  }
}

function _kiAppend(text,role){
  const el=document.createElement('div');el.className='ki-msg '+role;
  el.textContent=text;
  const box=document.getElementById('ki-messages');
  box.appendChild(el);box.scrollTop=box.scrollHeight;
}

function _renderKIResult(text){
  // Strip markdown symbols
  let t=text
    .replace(/\*\*([^*\n]+)\*\*/g,'$1')
    .replace(/\*([^*\n]+)\*/g,'$1')
    .replace(/^#{1,4}\s*/gm,'')
    .trim();
  const TITLE_MAP={
    'SWEEP':          {icon:'ðŸŒŠ',color:'#5ac8fa'},
    'BOS':            {icon:'ðŸ“',color:'#30d158'},
    'FIB-ENTRY':      {icon:'ðŸŽ¯',color:'#ffd60a'},
    'TREND':          {icon:'ðŸ“ˆ',color:'#bf5af2'},
    'BESTÃ„TIGUNGEN':  {icon:'ðŸ”',color:'#64d2ff'},
    'NEWS-RISIKO':    {icon:'ðŸ“°',color:'#ff9f0a'},
    'FAZIT':          {icon:'ðŸ’¡',color:'var(--accent)'},
    'STRATEGIE-COMPLIANCE':{icon:'ðŸ“‹',color:'#5ac8fa'},
    'EINSTIEG':       {icon:'ðŸŽ¯',color:'#30d158'},
    'SETUP-QUALITÃ„T': {icon:'â­',color:'#ffd60a'},
    'ERGEBNIS-ANALYSE':{icon:'ðŸ“Š',color:'#ff9f0a'},
    'KONKRETE VERBESSERUNGEN':{icon:'ðŸ”§',color:'#ff453a'},
    'LERNPUNKTE':     {icon:'ðŸ’¡',color:'#bf5af2'},
    'STÃ„RKEN':        {icon:'ðŸ’ª',color:'#30d158'},
    'SCHWÃ„CHEN':      {icon:'âš ï¸',color:'#ff9f0a'},
    'PSYCHOLOGIE':    {icon:'ðŸ§ ',color:'#bf5af2'},
    'MUSTER BEI VERLUST-TRADES':{icon:'ðŸ“‰',color:'#ff453a'},
    'KONKRETE HANDLUNGSEMPFEHLUNGEN':{icon:'ðŸŽ¯',color:'#5ac8fa'},
  };
  const FALLBACK_ICONS=['ðŸŒŠ','ðŸ“','ðŸŽ¯','ðŸ“ˆ','ðŸ”','ðŸ“°','ðŸ’¡','ðŸ“‹','ðŸ’ª','âš ï¸','ðŸ“‰'];
  const FALLBACK_COLORS=['#5ac8fa','#30d158','#ffd60a','#bf5af2','#64d2ff','#ff9f0a','var(--accent)','#5ac8fa','#30d158','#ff9f0a','#ff453a'];
  // Parse numbered sections: "1. TITLE â€“ content" or "1. TITLE\ncontent"
  const lines=t.split('\n');
  let html='',cur=null;
  function flush(){
    if(!cur)return;
    const tm=TITLE_MAP[cur.title]||{};
    const i=cur.n-1,ic=tm.icon||FALLBACK_ICONS[i]||'â—',cl=tm.color||FALLBACK_COLORS[i]||'var(--accent)';
    html+=`<div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:11px 14px;margin-bottom:8px;border-left:3px solid ${cl}">
      <div style="color:${cl};font-size:.7rem;font-weight:700;letter-spacing:.7px;margin-bottom:5px;text-transform:uppercase">${ic} ${cur.title}</div>
      <div style="font-size:.87rem;line-height:1.58;color:var(--text)">${cur.body.filter(Boolean).join('<br>')}</div>
    </div>`;
    cur=null;
  }
  for(const line of lines){
    const m=line.match(/^(\d+)\.\s+([^\nâ€“â€”:]+?)(?:\s*[â€“â€”:]\s*(.*))?$/);
    if(m){
      flush();
      cur={n:parseInt(m[1]),title:m[2].trim().toUpperCase(),body:m[3]?[m[3].trim()]:[]};
    }else if(cur){
      const s=line.trim();if(s)cur.body.push(s);
    }else{
      const s=line.trim();if(s)html+=`<p style="font-size:.87rem;line-height:1.58;margin:0 0 6px">${s}</p>`;
    }
  }
  flush();
  // Highlight FAZIT card based on 3-level trade quality verdict
  html=html.replace(
    /(<div style="background[^>]*border-left:3px solid [^"]+[^>]*>)\s*(<div[^>]*>ðŸ’¡ FAZIT<\/div>)\s*(<div[^>]*>)(.*?)(<\/div>\s*<\/div>)/s,
    (match,wrap,label,contentDiv,body,close)=>{
      const isGood=/GUTER\s+TRADE/i.test(body);
      const isRisky=/RISKANTER\s+TRADE/i.test(body);
      const isBad=/SCHLECHTER\s+TRADE/i.test(body);
      if(!isGood&&!isRisky&&!isBad)return match;
      const cl=isGood?'#30d158':isRisky?'#ff9f0a':'#ff453a';
      const badge=isGood
        ?'<span style="background:rgba(48,209,88,.15);color:#30d158;font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:20px;margin-bottom:6px;display:inline-block">âœ… GUTER TRADE</span><br>'
        :isRisky
          ?'<span style="background:rgba(255,159,10,.15);color:#ff9f0a;font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:20px;margin-bottom:6px;display:inline-block">âš ï¸ RISKANTER TRADE</span><br>'
          :'<span style="background:rgba(255,69,58,.15);color:#ff453a;font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:20px;margin-bottom:6px;display:inline-block">âŒ SCHLECHTER TRADE</span><br>';
      const cleanBody=body
        .replace(/GUTER\s+TRADE[,.\sâ€“â€”]*/i,'')
        .replace(/RISKANTER\s+TRADE[,.\sâ€“â€”]*/i,'')
        .replace(/SCHLECHTER\s+TRADE[,.\sâ€“â€”]*/i,'')
        .trim();
      const origColor=wrap.match(/border-left:3px solid ([^"]+)/)?.[1]||'var(--accent)';
      return wrap.replace(origColor,cl)+label.replace(origColor,cl)+contentDiv+badge+cleanBody+close;
    }
  );
  return html||`<div style="font-size:.87rem;line-height:1.6">${t.replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>`;
}
async function analyzeMyTrades(){
  const btn=document.getElementById('ki-analyse-btn');
  const res=document.getElementById('ki-analyse-result');
  btn.disabled=true;btn.textContent='Analysiere\u2026';res.innerHTML='';
  const all=(trades||[]).filter(t=>(t.journal||'Main')===activeJournal);
  const sel=document.getElementById('ki-trade-select');
  const selectedId=sel?sel.value:'';
  let prompt;
  if(selectedId){
    const t=all.find(x=>x.id===selectedId);
    if(!t){res.innerHTML='<div style="color:var(--danger);margin-top:12px">Trade nicht gefunden.</div>';btn.disabled=false;btn.textContent='&#x1F4CA; Erneut analysieren';return;}
    const detail=`Asset: ${t.asset||'-'} | Richtung: ${t.direction||'-'} | PnL: ${t.pnl||0}\u20AC | Datum: ${t.date||'-'} | Setup: ${t.setup||'-'} | RRR: ${t.rrr||'-'} | Anmerkungen: ${t.notes||t.comment||'-'}`;
    prompt=`Du bist ein professioneller Trading-Coach. Analysiere diesen einzelnen Trade strikt anhand der SMC-Strategie und gib ausf\u00FChrliches Feedback auf Deutsch.\n\n${_STRATEGY}\n\nTrade-Details:\n${detail}\n\nBitte analysiere genau anhand der Strategie (Liquidity Sweep \u2192 BOS \u2192 0.618/0.718 Fib-Entry):\n1. STRATEGIE-COMPLIANCE \u2014 Entspricht dieser Trade der Strategie? Was wurde richtig/falsch gemacht?\n2. EINSTIEG \u2014 War der Entry korrekt (beim 0.618 oder 0.718 Fib nach BOS)?\n3. SETUP-QUALIT\u00C4T \u2014 Wie klar war das Setup? Wurde auf alle 3 Bedingungen gewartet?\n4. ERGEBNIS-ANALYSE \u2014 Was hat zu diesem PnL gef\u00FChrt?\n5. KONKRETE VERBESSERUNGEN \u2014 Was h\u00E4tte bei diesem Trade besser gemacht werden k\u00F6nnen?\n6. LERNPUNKTE \u2014 Was kann der Nutzer aus diesem Trade mitnehmen?\n\nSei direkt, konkret und lehrreich.`;
  } else {
    const detail=all.slice(-30).map(t=>`Asset:${t.asset||'-'} Richtung:${t.direction||'-'} PnL:${t.pnl||0} Datum:${t.date||'-'} Setup:${t.setup||'-'}`).join('\n');
    prompt=`Du bist ein professioneller Trading-Coach. Analysiere die Trading-Daten des Nutzers strikt anhand seiner SMC-Strategie und gib ausf\u00FChrliches Feedback auf Deutsch.\n\n${_STRATEGY}\n\nTrading-\u00DCbersicht:\n${_kiTradeCtx()}\n\nDetaillierte Trades (letzte 30):\n${detail}\n\nBitte analysiere genau anhand der Strategie (Liquidity Sweep \u2192 BOS \u2192 0.618/0.718 Fib-Entry):\n1. STRATEGIE-COMPLIANCE \u2014 Wie konsequent folgt der Nutzer seinen eigenen Regeln?\n2. ST\u00C4RKEN \u2014 Was l\u00E4uft strategiekonform gut?\n3. SCHW\u00C4CHEN \u2014 Wo wird von der Strategie abgewichen?\n4. MUSTER BEI VERLUST-TRADES \u2014 Welcher Strategieschritt fehlt typischerweise bei Verlustern?\n5. KONKRETE HANDLUNGSEMPFEHLUNGEN \u2014 Spezifisch f\u00FCr Liquidity Sweep, BOS-Erkennung und Fib-Entry\n6. PSYCHOLOGIE \u2014 Wird ungeduldig eingestiegen bevor alle 3 Bedingungen erf\u00FCllt sind?\n\nStrukturiere die Antwort klar mit \u00DCberschriften. Sei direkt und konkret.`;
  }
  try{
    const rep=await _gemini([{role:'user',parts:[{text:prompt}]}]);
    res.innerHTML='<div style="margin-top:14px">'+_renderKIResult(rep)+'</div>';
  }catch(e){res.innerHTML='<div style="color:var(--danger);margin-top:12px">Fehler: '+(e.message||'Analyse fehlgeschlagen')+'</div>';}
  btn.disabled=false;btn.textContent='&#x1F4CA; Erneut analysieren';
}

async function _getNewsCtx(asset=''){
  try{
    const data=await _calCached();
    const now=Date.now();
    const up=asset.toUpperCase();
    const ccys=['USD','EUR','GBP','JPY','CHF','CAD','AUD','NZD','CNY'];
    const rel=asset
      ? ccys.filter(c=>up.includes(c)||(up.includes('XAU')&&c==='USD')||(up.replace(/\d+/g,'').endsWith('US')&&c==='USD'))
      : null;
    const evts=data
      .filter(e=>rel?rel.includes(e.country):e.impact==='High')
      .filter(e=>new Date(e.date).getTime()>now)
      .slice(0,5);
    if(!evts.length)return '';
    return evts.map(e=>{
      const diff=Math.round((new Date(e.date).getTime()-now)/60000);
      const when=diff<60?`in ${diff} Min.`:diff<1440?`in ${Math.round(diff/60)}h`
        :new Date(e.date).toLocaleDateString('de-DE',{weekday:'short',day:'numeric',month:'short'})+' '+new Date(e.date).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
      return `[${e.impact}] ${e.title} (${e.country}) â€“ ${when}`;
    }).join('\n');
  }catch(_){return '';}
}
function _buildChartPrompt(newsCtx=''){
  const fazitN=newsCtx?7:6;
  const newsPoint=newsCtx
    ?`\n6. NEWS-RISIKO â€“ Folgende relevante Nachrichten stehen bevor:\n${newsCtx}\nBewerte kurz das Risiko fÃ¼r diesen Trade (High-Impact vor Entry = hohes Risiko).`
    :'';
  return `Du bist ein SMC-Chart-Analyst. Analysiere diesen Chart kurz und prÃ¤zise auf Deutsch.\n\n${_STRATEGY}\n\nBeantworte in genau ${fazitN} knappen Punkten:\n1. SWEEP â€“ Buy-Side oder Sell-Side? Kurz beschreiben.\n2. BOS â€“ Vorhanden / ausstehend?\n3. FIB-ENTRY â€“ 0.618 oder 0.718 Level erreicht oder noch nicht?\n4. TREND â€“ Ãœbergeordneter Trend bullisch oder bÃ¤risch? Passt das Setup zur Trendrichtung?\n5. BESTÃ„TIGUNGEN â€“ Order Block (OB) und/oder Fair Value Gap (FVG) im Entry-Bereich vorhanden? Wenn ja, kurz wo.${newsPoint}\n${fazitN}. FAZIT â€“ Beginne mit genau einem dieser Begriffe: "GUTER TRADE", "RISKANTER TRADE" oder "SCHLECHTER TRADE". GUTER TRADE: alle 5 Bedingungen erfÃ¼llt. RISKANTER TRADE: Sweep+BOS+Fib vorhanden, aber Trend oder OB/FVG fehlt. SCHLECHTER TRADE: Sweep, BOS oder Fib fehlt. Dann 1 Satz was jetzt zu tun ist.\n\nKeine langen ErklÃ¤rungen. Direkt und kompakt.`;
}
async function analyzeChartImage(dataUrl){
  const res=document.getElementById('ki-chart-result');
  res.innerHTML='<div style="color:var(--text-sub);font-size:.9rem;margin-top:10px">&#x1F50D; Analysiere Chartâ€¦</div>';
  const newsCtx=await _getNewsCtx();
  const prompt=_buildChartPrompt(newsCtx);
  try{
    const img=await _compressImg(dataUrl);
    const r=await fetch(_GU,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+_GK},body:JSON.stringify({model:_GMV,messages:[{role:'user',content:[{type:'image_url',image_url:{url:img}},{type:'text',text:prompt}]}],temperature:0.5,max_tokens:newsCtx?680:580})});
    if(!r.ok){let em='HTTP '+r.status;try{const ed=await r.json();em+=' â€“ '+(ed?.error?.message||JSON.stringify(ed));}catch(_){}throw new Error(em);}
    const d=await r.json();
    const rep=d.choices?.[0]?.message?.content||'Keine Analyse mÃ¶glich.';
    res.innerHTML='<div style="margin-top:12px">'+_renderKIResult(rep)+'</div>';
  }catch(err){console.error('[ChartAnalyse] Fehler:',err);res.innerHTML='<div style="color:var(--danger);margin-top:10px">Fehler: '+(err.message||'Analyse fehlgeschlagen')+'</div>';}
}
async function analyzeTradeSetupImg(){
  const dataUrl=document.getElementById('imgSetup').value;
  if(!dataUrl)return;
  const res=document.getElementById('tradeChartResult');
  if(!res)return;
  res.style.display='block';
  res.innerHTML='<div style="color:var(--text-sub);font-size:.85rem;padding:8px 0">&#x23F3; KI analysiert Chart + Newsâ€¦</div>';
  const asset=(document.getElementById('assetInput')?.value||'').trim();
  const newsCtx=await _getNewsCtx(asset);
  const prompt=_buildChartPrompt(newsCtx);
  try{
    const img=await _compressImg(dataUrl);
    const r=await fetch(_GU,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+_GK},body:JSON.stringify({model:_GMV,messages:[{role:'user',content:[{type:'image_url',image_url:{url:img}},{type:'text',text:prompt}]}],temperature:0.5,max_tokens:newsCtx?680:580})});
    if(!r.ok){let em='HTTP '+r.status;try{const ed=await r.json();em+=' â€“ '+(ed?.error?.message||JSON.stringify(ed));}catch(_){}throw new Error(em);}
    const d=await r.json();
    const rep=d.choices?.[0]?.message?.content||'Keine Analyse mÃ¶glich.';
    res.innerHTML=_renderKIResult(rep);
  }catch(err){console.error('[TradeAnalyse] Fehler:',err);res.innerHTML='<div style="color:var(--danger);font-size:.85rem">Fehler: '+(err.message||'Analyse fehlgeschlagen')+'</div>';}
}
function processChartBlob(blob){
  const prev=document.getElementById('ki-chart-preview');
  document.getElementById('ki-chart-result').innerHTML='';
  const reader=new FileReader();
  reader.onload=ev=>{
    prev.innerHTML=`<img src="${ev.target.result}" style="width:100%;border-radius:12px;max-height:320px;object-fit:contain;margin-bottom:4px">`;
    analyzeChartImage(ev.target.result);
  };
  reader.readAsDataURL(blob);
}
function handleChartUpload(e){const file=e.target.files[0];if(file)processChartBlob(file);}
async function pasteFromClipboard(){
  try{
    const items=await navigator.clipboard.read();
    for(const item of items){
      const imgType=item.types.find(t=>t.startsWith('image/'));
      if(imgType){processChartBlob(await item.getType(imgType));return;}
    }
    alert('Kein Bild in der Zwischenablage. Bitte zuerst einen Chart-Screenshot kopieren (Strg+C / Strg+Druck).');
  }catch(_){
    alert('Zwischenablage nicht lesbar. Bitte Strg+V direkt auf der Seite drÃ¼cken.');
  }
}
window.addEventListener('paste',e=>{
  const panel=document.getElementById('ki-panel-chart');
  if(panel&&!panel.classList.contains('hidden')){
    const item=Array.from(e.clipboardData?.items||[]).find(i=>i.type.startsWith('image/'));
    if(item){e.preventDefault();processChartBlob(item.getAsFile());return;}
  }
  const modal=document.getElementById('trade-form-modal');
  if(modal&&!modal.classList.contains('hidden')){
    const item=Array.from(e.clipboardData?.items||[]).find(i=>i.type.startsWith('image/'));
    if(item){
      e.preventDefault();
      const closedOpen=!document.getElementById('closedFields').classList.contains('hidden');
      const field=(closedOpen&&document.getElementById('imgSetup').value&&!document.getElementById('imgResult').value)?'result':'setup';
      loadTradeImgFromBlob(item.getAsFile(),field);
    }
  }
});
function showTradeImgPreview(field,dataUrl){
  document.getElementById(field+'ImgPreview').innerHTML=`<div style="position:relative;margin-top:6px"><img src="${dataUrl}" style="width:100%;max-height:160px;object-fit:contain;border-radius:10px;border:1px solid var(--border)"><button type="button" onclick="clearTradeImg('${field}')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.8);border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;color:#fff;font-size:.75rem;line-height:1">&#x2715;</button></div>`;
}
function clearTradeImg(field){
  document.getElementById('img'+(field==='setup'?'Setup':'Result')).value='';
  document.getElementById(field+'ImgPreview').innerHTML='';
  const fi=document.getElementById(field+'ImgFile');if(fi)fi.value='';
  if(field==='setup'){
    const h=document.getElementById('tradeImgAiHint');if(h)h.innerHTML='';
    const btn=document.getElementById('tradeChartAnalyseBtn');if(btn)btn.style.display='none';
    const r=document.getElementById('tradeChartResult');if(r){r.style.display='none';r.innerHTML='';}
  }
}
function loadTradeImgFromBlob(blob,field){
  const reader=new FileReader();
  reader.onload=ev=>{
    document.getElementById('img'+(field==='setup'?'Setup':'Result')).value=ev.target.result;
    showTradeImgPreview(field,ev.target.result);
    if(field==='setup'){
      autoFillTradeFields(ev.target.result);
      const btn=document.getElementById('tradeChartAnalyseBtn');if(btn)btn.style.display='';
    }
  };
  reader.readAsDataURL(blob);
}
function _compressImg(dataUrl,maxW=1800,quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1,maxW/img.width);
      const w=Math.round(img.width*scale),h=Math.round(img.height*scale);
      const c=document.createElement('canvas');c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',quality));
    };
    img.onerror=()=>resolve(dataUrl);
    img.src=dataUrl;
  });
}
function _cleanModelJSON(raw){
  let s=raw.replace(/```[\w]*\s*/g,'').replace(/```/g,'').trim();
  const m=s.match(/\{[\s\S]*\}/);if(!m)return null;s=m[0];
  s=s
    .replace(/,\s*([}\]])/g,'$1')
    .replace(/([{,]\s*)([a-zA-Z_]\w*)\s*:/g,'$1"$2":')
    .replace(/:\s*'([^']*)'/g,':"$1"')
    .replace(/:\s*None\b/gi,':null')
    .replace(/:\s*undefined\b/gi,':null');
  try{return JSON.parse(s);}
  catch(e){console.error('[AutoFill] JSON parse:',s,'|',e.message);return null;}
}
async function autoFillTradeFields(dataUrl){
  const hint=document.getElementById('tradeImgAiHint');
  if(hint)hint.innerHTML='<span style="color:var(--text-sub);font-size:.82rem">&#x23F3; KI erkennt Entry, SL &amp; TPsâ€¦</span>';
  const sysMsg='You are a trading chart price extractor. You ALWAYS respond with valid JSON only â€” no markdown, no explanation, no code fences.';
  const userMsg='Look at this trading chart. Find price levels explicitly labeled as Entry, Stop Loss (SL), TP1, TP2, TP3. IGNORE Fibonacci ratio lines (0.618, 0.786 etc.). Return ONLY this JSON with exact numbers or null:\n{"entry":null,"sl":null,"tp1":null,"tp2":null,"tp3":null}';
  try{
    const img=await _compressImg(dataUrl);
    const r=await fetch(_GU,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+_GK},body:JSON.stringify({model:_GMV,messages:[{role:'system',content:sysMsg},{role:'user',content:[{type:'image_url',image_url:{url:img}},{type:'text',text:userMsg}]}],temperature:0,max_tokens:80})});
    if(!r.ok){
      const eb=await r.json().catch(()=>({}));
      console.error('[AutoFill] Groq',r.status,(eb.error?.message)||'');
      throw new Error('HTTP '+r.status);
    }
    const d=await r.json();
    const vals=_cleanModelJSON(d.choices?.[0]?.message?.content||'');
    if(!vals){
      if(hint)hint.innerHTML='<span style="color:var(--text-sub);font-size:.82rem">Keine Labels erkannt â€“ Entry/SL/TP sichtbar?</span>';
      return;
    }
    const map={entry:'inpEntry',sl:'inpSL',tp1:'inpTP1',tp2:'inpTP2',tp3:'inpTP3'};
    let filled=0;
    Object.entries(map).forEach(([k,id])=>{
      if(vals[k]!=null&&vals[k]!=='null'){
        const el=document.getElementById(id);
        if(el){el.value=vals[k];el.style.transition='border-color .4s';el.style.borderColor='var(--accent)';setTimeout(()=>{el.style.borderColor='';},2500);filled++;}
      }
    });
    if(hint)hint.innerHTML=filled>0
      ?`<span style="color:var(--accent);font-size:.82rem">&#x2714; ${filled} Werte erkannt &amp; ausgef&#xFC;llt</span>`
      :'<span style="color:var(--text-sub);font-size:.82rem">Keine Labels erkannt â€“ Entry/SL/TP sichtbar?</span>';
  }catch(err){
    console.error('[AutoFill] Fehler:',err);
    if(hint)hint.innerHTML='<span style="color:var(--text-sub);font-size:.82rem">&#x26A0; Erkennung fehlgeschlagen ('+err.message+')</span>';
  }
}
function handleTradeImgUpload(e,field){const f=e.target.files[0];if(f)loadTradeImgFromBlob(f,field);}
async function pasteTradeImg(field){
  try{
    const items=await navigator.clipboard.read();
    for(const item of items){const t=item.types.find(x=>x.startsWith('image/'));if(t){loadTradeImgFromBlob(await item.getType(t),field);return;}}
    alert('Kein Bild in der Zwischenablage. Bitte zuerst einen Screenshot kopieren.');
  }catch(_){alert('Zwischenablage nicht lesbar. Bitte Strg+V im Formular drÃ¼cken.');}
}

// â”€â”€â”€ DASHBOARD NEWS COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _newsEvents=[],_newsTick=null;
const _NEWS_FLAGS={USD:'&#x1F1FA;&#x1F1F8;',EUR:'&#x1F1EA;&#x1F1FA;',GBP:'&#x1F1EC;&#x1F1E7;',JPY:'&#x1F1EF;&#x1F1F5;',CHF:'&#x1F1E8;&#x1F1ED;',CAD:'&#x1F1E8;&#x1F1E6;',AUD:'&#x1F1E6;&#x1F1FA;',NZD:'&#x1F1F3;&#x1F1FF;',CNY:'&#x1F1E8;&#x1F1F3;'};
const _NEWS_IMP={High:'#ff3b30',Medium:'#ff9f0a',Low:'#8e8e93'};
const _FF_CK='ffcal_v4',_FF_TTL=30*60*1000;
const _TV_CCY={US:'USD',EU:'EUR',GB:'GBP',DE:'EUR',JP:'JPY',CH:'CHF',CA:'CAD',AU:'AUD',NZ:'NZD',CN:'CNY',FR:'EUR',IT:'EUR',ES:'EUR'};
function toggleDashboardNews(val){
  showDashboardNews=val;
  localStorage.setItem('dashboardNews',val?'true':'false');
  const w=document.getElementById('dashboard-news-widget');
  if(!val){
    if(_newsTick){clearInterval(_newsTick);_newsTick=null;}
    if(w)w.innerHTML='';
  }else{
    loadDashboardNews();
  }
}
async function _tvCalFetch(){
  const from=new Date().toISOString();
  const to=new Date(Date.now()+14*24*3600*1000).toISOString();
  const r=await fetch(`https://economic-calendar.tradingview.com/events?from=${from}&to=${to}&countries=US,EU,GB,DE,JP,CH,CA,AU,NZ,CN,FR,IT,ES&minImportance=0`,{cache:'no-cache'});
  if(!r.ok)throw 0;
  const json=await r.json();
  return(json.result||[]).map(e=>({title:e.title,country:_TV_CCY[e.country]||e.country,date:e.date,impact:e.importance>=2?'High':e.importance>=1?'Medium':'Low'}));
}
async function _ffFetch(slug){
  const base='https://nfs.faireconomy.media/ff_calendar_'+slug+'.json';
  const enc=encodeURIComponent(base);
  const tries=[
    ()=>fetch('https://api.allorigins.win/get?url='+enc,{cache:'no-cache'}).then(async r=>{if(!r.ok)throw 0;const j=await r.json();const d=JSON.parse(j.contents);if(!Array.isArray(d))throw 0;return d;}),
    ()=>fetch('https://api.allorigins.win/raw?url='+enc,{cache:'no-cache'}).then(r=>{if(!r.ok)throw 0;return r.json();}),
    ()=>fetch('https://api.cors.lol/?url='+base,{cache:'no-cache'}).then(r=>{if(!r.ok)throw 0;return r.json();}),
    ()=>fetch('https://cors.eu.org/'+base,{cache:'no-cache'}).then(r=>{if(!r.ok)throw 0;return r.json();}),
    ()=>fetch('https://corsproxy.io/?url='+enc,{cache:'no-cache'}).then(async r=>{if(!r.ok)throw 0;const d=await r.json();if(!Array.isArray(d))throw 0;return d;}),
    ()=>fetch(base,{cache:'no-cache'}).then(r=>{if(!r.ok)throw 0;return r.json();})
  ];
  for(const fn of tries){
    try{const d=await fn();if(Array.isArray(d)&&d.length>0)return d;}catch(_){}
  }
  return [];
}
async function _fetchAllCalData(){
  try{const d=await _tvCalFetch();if(d.length)return d;}catch(_){}
  const[tw,nw]=await Promise.all([_ffFetch('thisweek'),_ffFetch('nextweek')]);
  return[...tw,...nw];
}
async function _calCached(){
  const now=Date.now();
  try{
    const raw=localStorage.getItem(_FF_CK);
    if(raw){
      const{ts,data}=JSON.parse(raw);
      const hasFuture=Array.isArray(data)&&data.some(e=>new Date(e.date).getTime()>now);
      if(now-ts<_FF_TTL&&hasFuture)return data;
    }
  }catch(_){}
  const data=await _fetchAllCalData();
  if(data.length){try{localStorage.setItem(_FF_CK,JSON.stringify({ts:now,data}));}catch(_){}}
  return data;
}
async function loadDashboardNews(){
  const w=document.getElementById('dashboard-news-widget');if(!w)return;
  if(!showDashboardNews){w.innerHTML='';return;}
  if(_newsTick){clearInterval(_newsTick);_newsTick=null;}
  w.innerHTML='<div style="color:var(--text-sub);font-size:.75rem;padding:4px 8px">&#x23F3; lÃ¤dtâ€¦</div>';
  try{
    const data=await _calCached();
    if(!data.length){w.innerHTML='<div style="color:var(--text-sub);font-size:.72rem;padding:4px 8px">&#x1F4C5; Kalender nicht erreichbar</div>';return;}
    const now=Date.now();
    _newsEvents=data
      .filter(e=>e.impact==='High'||e.impact==='Medium')
      .filter(e=>new Date(e.date).getTime()>now)
      .sort((a,b)=>new Date(a.date)-new Date(b.date))
      .slice(0,3);
    if(!_newsEvents.length){
      w.innerHTML='<div style="color:var(--text-sub);font-size:.72rem;padding:4px 8px">&#x1F4C5; NÃ¤chste Events ab Montag</div>';
      return;
    }
    _renderNewsWidget();
    _newsTick=setInterval(_renderNewsWidget,1000);
  }catch(err){w.innerHTML='<div style="color:var(--text-sub);font-size:.72rem;padding:4px 8px">&#x26A0; News nicht verfÃ¼gbar</div>';}
}
function _renderNewsWidget(){
  const w=document.getElementById('dashboard-news-widget');if(!w)return;
  const now=Date.now();
  _newsEvents=_newsEvents.filter(e=>new Date(e.date).getTime()>now);
  if(!_newsEvents.length){w.innerHTML='';if(_newsTick){clearInterval(_newsTick);_newsTick=null;}return;}
  w.innerHTML='<div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">'+
    _newsEvents.slice(0,3).map(e=>{
      const diff=new Date(e.date).getTime()-now;
      const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
      const countdown=h>=24?`${Math.floor(h/24)}T ${h%24}h`:`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      const d=new Date(e.date);
      const hhmm=String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
      const flag=_NEWS_FLAGS[e.country]||'&#x1F310;';
      const dot=`<span style="width:7px;height:7px;border-radius:50%;background:${_NEWS_IMP[e.impact]||'#8e8e93'};display:inline-block;flex-shrink:0"></span>`;
      const name=e.title.length>18?e.title.slice(0,16)+'â€¦':e.title;
      return `<div class="news-pill">${dot}<span style="font-size:.8rem">${flag}</span><span class="np-cur">${e.country}</span><span class="np-name">${name}</span><span class="np-time">${hhmm}</span><span class="np-timer">-${countdown}</span></div>`;
    }).join('')+'</div>';
}
async function loadNewsView(){
  const b=document.getElementById('news-box');if(!b)return;
  b.innerHTML='<div style="padding:24px;color:var(--text-sub);font-size:.9rem">&#x23F3; LÃ¤dt Wirtschaftskalenderâ€¦</div>';
  try{
    const data=await _calCached();
    if(!data.length){b.innerHTML='<div style="padding:24px;color:var(--text-sub)">&#x1F4C5; Keine Events verfÃ¼gbar</div>';return;}
    const sorted=data.slice().sort((a,c)=>new Date(a.date)-new Date(c.date));
    const groups={};
    sorted.forEach(e=>{
      const d=new Date(e.date);
      const key=d.toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      if(!groups[key])groups[key]=[];
      groups[key].push(e);
    });
    const impColor={High:'#ff3b30',Medium:'#ff9f0a',Low:'#8e8e93'};
    let html='<div style="overflow-y:auto;height:100%;padding:16px;box-sizing:border-box">';
    for(const[day,events] of Object.entries(groups)){
      html+=`<div style="font-size:.7rem;font-weight:700;color:var(--text-sub);text-transform:uppercase;letter-spacing:1px;margin:16px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${day}</div>`;
      events.forEach(e=>{
        const flag=_NEWS_FLAGS[e.country]||'&#x1F310;';
        const t=new Date(e.date);
        const hhmm=String(t.getHours()).padStart(2,'0')+':'+String(t.getMinutes()).padStart(2,'0');
        const dot=`<span style="width:8px;height:8px;border-radius:50%;background:${impColor[e.impact]||'#8e8e93'};display:inline-block;flex-shrink:0"></span>`;
        html+=`<div style="display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:8px;border:1px solid var(--border);margin-bottom:4px;background:var(--cell-bg)">${dot}<span style="font-size:.85rem">${flag}</span><span style="font-size:.75rem;color:var(--text-sub);min-width:30px;font-weight:600">${e.country}</span><span style="font-size:.85rem;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.title||''}</span><span style="font-size:.75rem;color:var(--text-sub);flex-shrink:0">${hhmm}</span></div>`;
      });
    }
    html+='</div>';
    b.innerHTML=html;
  }catch(err){b.innerHTML='<div style="padding:24px;color:var(--text-sub)">&#x26A0; Kalender nicht verfÃ¼gbar</div>';}
}
</script></body></html>
