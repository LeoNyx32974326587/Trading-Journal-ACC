<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDCgM4h6Rgk-r95Qy7BlT1S4QQI-4IDqAQ",
        authDomain: "trading-journal-acc.firebaseapp.com",
        projectId: "trading-journal-acc",
        storageBucket: "trading-journal-acc.firebasestorage.app",
        messagingSenderId: "68601000570",
        appId: "1:68601000570:web:87d3ebd5e86416403e41c3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const adminEmail = "leon.luca.lauterbach@gmail.com";

    let trades = [];
    let ovChart;
    const moodMap = { "Neutral": "ğŸ˜", "Sicher": "ğŸ˜Š", "Angst": "ğŸ˜¨", "Wut": "ğŸ˜¡" };
    const myAssets = ["BTCUSD", "ETHUSD", "EURUSD", "GBPUSD", "GOLD", "DAX", "NASDAQ"];

    function loginGoogle() { 
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); 
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const email = user.email.toLowerCase();
            const isAdmin = (email === adminEmail);
            
            // Check if member or admin
            const memberDoc = await db.collection('members').doc(email).get();
            
            if (isAdmin || memberDoc.exists) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                
                const firstName = user.displayName ? user.displayName.split(' ')[0] : "Trader";
                document.getElementById('user-greeting').innerText = `HALLO ${firstName.toUpperCase()}`;
                
                if (isAdmin) {
                    document.getElementById('admin-link').classList.remove('hidden');
                    loadMembers();
                }
                loadTrades();
            } else {
                alert("Zugriff verweigert. Bitte kontaktiere Leon.");
                auth.signOut();
            }
        } else {
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
        }
    });

    // --- TRADE MANAGEMENT ---
    async function loadTrades() {
        const snap = await db.collection('trades')
                             .where('userId', '==', auth.currentUser.uid)
                             .get();
        trades = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderUI();
    }

    async function saveTrade() {
        const t = {
            date: document.getElementById('datetime').value || new Date().toISOString(),
            asset: document.getElementById('assetDropdown').value,
            status: document.getElementById('status').value,
            mindset: document.getElementById('mindset').value,
            pnl: parseFloat(document.getElementById('pnl').value) || 0,
            imgSetup: document.getElementById('imgSetup').value,
            imgResult: document.getElementById('imgResult').value,
            note: document.getElementById('note').value,
            userId: auth.currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('trades').add(t);
        loadTrades(); 
        showView('overview');
    }

    async function deleteTrade(id) {
        if(confirm("Trade wirklich lÃ¶schen?")) {
            await db.collection('trades').doc(id).delete();
            loadTrades();
        }
    }

    // --- ADMIN SETTINGS ---
    async function addMember() {
        const email = document.getElementById('newMemberEmail').value.toLowerCase().trim();
        if(email) {
            await db.collection('members').doc(email).set({ addedBy: adminEmail, date: new Date() });
            document.getElementById('newMemberEmail').value = '';
            loadMembers();
        }
    }

    async function loadMembers() {
        const snap = await db.collection('members').get();
        const list = document.getElementById('memberList');
        list.innerHTML = '';
        snap.forEach(doc => {
            list.innerHTML += `
                <div class="member-item">
                    <span>${doc.id}</span>
                    <button class="btn-delete-small" onclick="deleteMember('${doc.id}')">Entfernen</button>
                </div>`;
        });
    }

    async function deleteMember(email) {
        await db.collection('members').doc(email).delete();
        loadMembers();
    }

    // --- UI HELPER ---
    function renderUI() {
        let totalPnl = 0, wins = 0, closed = 0;
        const body = document.getElementById('tradeBody');
        const activeList = document.getElementById('activeTradesList');
        body.innerHTML = '';
        activeList.innerHTML = '';

        trades.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
            const isClosed = t.status === 'Geschlossen';
            if(isClosed) {
                totalPnl += t.pnl;
                closed++;
                if(t.pnl > 0) wins++;
                body.innerHTML += `
                    <tr>
                        <td>${t.date.split('T')[0]}</td>
                        <td><b>${t.asset}</b></td>
                        <td>${moodMap[t.mindset] || "ğŸ˜"}</td>
                        <td>${t.imgSetup ? '<a href="'+t.imgSetup+'" target="_blank">ğŸ–¼ï¸</a>' : ''}</td>
                        <td style="color:${t.pnl >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">${t.pnl.toFixed(2)}â‚¬</td>
                        <td><button onclick="deleteTrade('${t.id}')" style="background:none; border:none; color:grey; cursor:pointer;">âœ˜</button></td>
                    </tr>`;
            } else {
                document.getElementById('activeTradesCard').classList.remove('hidden');
                activeList.innerHTML += `
                    <div class="active-trade-item">
                        <span><b>${t.asset}</b> (${t.date.split('T')[0]})</span>
                        <button class="chart-btn" onclick="editTrade('${t.id}')" style="color:var(--accent)">AbschlieÃŸen</button>
                    </div>`;
            }
        });

        document.getElementById('ovTotal').innerText = totalPnl.toFixed(2) + " â‚¬";
        document.getElementById('ovTotal').style.color = totalPnl >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('ovWinRate').innerText = closed > 0 ? (wins/closed*100).toFixed(1) + "%" : "0%";
        updateChart();
    }

    function updateChart() {
        const ctx = document.getElementById('ovChart').getContext('2d');
        const filtered = trades.filter(t => t.status === 'Geschlossen').sort((a,b) => new Date(a.date) - new Date(b.date));
        let sum = 0; 
        const points = filtered.map(t => { sum += t.pnl; return sum; });
        const labels = filtered.map(t => t.date.split('T')[0]);

        if(ovChart) ovChart.destroy();
        ovChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: points,
                    borderColor: '#bb86fc',
                    borderWidth: 3,
                    pointRadius: 4,
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(187,134,252,0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#222' }, ticks: { color: '#888' } },
                    x: { grid: { display: false }, ticks: { color: '#888' } }
                }
            }
        });
    }

    function showView(v) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.getElementById('navDrawer').classList.remove('open');
        document.getElementById('view-title').innerText = v.toUpperCase();
    }

    function toggleMenu() { document.getElementById('navDrawer').classList.toggle('open'); }
    function toggleOutcomeFields() { 
        const isClosed = document.getElementById('status').value === 'Geschlossen';
        document.getElementById('pnlWrapper').classList.toggle('hidden', !isClosed); 
        document.getElementById('outcomeWrapper').classList.toggle('hidden', !isClosed);
    }

    // Dropdowns fÃ¼llen
    document.getElementById('assetDropdown').innerHTML = myAssets.map(a => `<option value="${a}">${a}</option>`).join('');
    document.getElementById('calcAsset').innerHTML = myAssets.map(a => `<option value="${a}">${a}</option>`).join('');
</script>
