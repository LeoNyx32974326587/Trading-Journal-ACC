<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeCloud - Classic</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0b0b; --card: #141414; --acc: #bb86fc; --txt: #e0e0e0; --brd: #222; }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding-bottom: 50px; }
        .hidden { display: none !important; }
        header { padding: 15px; background: #111; border-bottom: 1px solid var(--brd); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 800px; margin: auto; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--brd); margin-bottom: 15px; }
        input, select, textarea { background: #000; color: #fff; border: 1px solid var(--brd); padding: 10px; width: 100%; margin: 8px 0; box-sizing: border-box; border-radius: 4px; }
        .btn { background: var(--acc); color: #000; padding: 12px; border: none; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .nav { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }
        .nav button { background: #222; color: #fff; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; white-space: nowrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #222; }
        #ovTotal { font-size: 2rem; font-weight: bold; color: var(--acc); }
    </style>
</head>
<body>

<div id="auth-overlay" style="position:fixed; inset:0; background:#000; z-index:999; display:flex; justify-content:center; align-items:center;">
    <button onclick="login()" class="btn" style="width:200px;">Login</button>
</div>

<header>
    <div style="font-weight:bold; color:var(--acc);">TRADECLOUD</div>
    <button onclick="logout()" style="background:none; border:none; color:#666; cursor:pointer;">Logout</button>
</header>

<div class="container hidden" id="app">
    <div class="nav">
        <button onclick="show('dash')">üè† √úbersicht</button>
        <button onclick="prepAdd()">‚ûï Neuer Trade</button>
        <button onclick="show('hist')">üìú Historie</button>
        <button onclick="show('calc')">üìä Rechner</button>
        <button id="admBtn" class="hidden" onclick="show('sett')">‚öôÔ∏è Admin</button>
    </div>

    <section id="view-dash" class="view">
        <div class="card" style="text-align:center;">
            <div style="color:#888;">Gesamt P&L</div>
            <div id="ovTotal">0.00 ‚Ç¨</div>
        </div>
        <div class="card">
            <canvas id="chart" height="150"></canvas>
        </div>
        <h4>Offene Trades</h4>
        <div id="open-list"></div>
    </section>

    <section id="view-add" class="view hidden">
        <div class="card">
            <h3 id="form-title">Trade erfassen</h3>
            <input type="hidden" id="tid">
            <input type="text" id="asset" placeholder="Asset (z.B. NAS100)" required>
            <select id="status" onchange="document.getElementById('pnl-box').classList.toggle('hidden', this.value==='Aktiv')">
                <option value="Aktiv">Offen</option>
                <option value="Geschlossen">Geschlossen</option>
            </select>
            <div id="pnl-box" class="hidden"><input type="number" id="pnl" placeholder="P&L in ‚Ç¨" step="0.01"></div>
            <input type="datetime-local" id="date">
            <textarea id="note" placeholder="Notizen..."></textarea>
            <button onclick="save()" class="btn">SPEICHERN</button>
        </div>
    </section>

    <section id="view-hist" class="view hidden">
        <div class="card" style="overflow-x:auto;">
            <table>
                <thead><tr><th>Datum</th><th>Asset</th><th>P&L</th><th></th></tr></thead>
                <tbody id="hist-body"></tbody>
            </table>
        </div>
    </section>

    <section id="view-calc" class="view hidden">
        <div class="card">
            <h3>Lot Rechner</h3>
            <input type="number" id="cBal" placeholder="Kontostand">
            <input type="number" id="cRisk" placeholder="Risiko %">
            <input type="number" id="cSl" placeholder="SL Distanz (Punkte/Pips)">
            <button onclick="calc()" class="btn">Berechnen</button>
            <div id="cRes" style="font-size:1.5rem; margin-top:15px; text-align:center; color:var(--acc);">0.00 Lots</div>
        </div>
    </section>

    <section id="view-sett" class="view hidden">
        <div class="card">
            <h3>Admin Subgroup: Einstellungen</h3>
            <input type="email" id="admEmail" placeholder="Mitglied E-Mail">
            <button onclick="addMem()" class="btn">Hinzuf√ºgen</button>
            <div id="memList" style="margin-top:15px;"></div>
        </div>
    </section>
</div>

<script>
    const cfg = { apiKey: "AIzaSyDCgM4h6Rgk-r95Qy7BlT1S4QQI-4IDqAQ", authDomain: "trading-journal-acc.firebaseapp.com", projectId: "trading-journal-acc" };
    firebase.initializeApp(cfg);
    const auth = firebase.auth(), db = firebase.firestore();
    let trades = [], chart;

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            if(u.email === "leon.luca.lauterbach@gmail.com") document.getElementById('admBtn').classList.remove('hidden');
            load();
            setInterval(load, 5000);
        }
    });

    async function load() {
        const s = await db.collection('trades').where('userId', '==', auth.currentUser.uid).get();
        trades = s.docs.map(d => ({id: d.id, ...d.data()}));
        render();
    }

    function render() {
        const closed = trades.filter(t => t.status === 'Geschlossen').sort((a,b) => new Date(a.date) - new Date(b.date));
        let total = 0, pts = [];
        closed.forEach(t => { total += t.pnl; pts.push(total); });

        document.getElementById('ovTotal').innerText = total.toFixed(2) + " ‚Ç¨";
        
        const ctx = document.getElementById('chart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type: 'line', data: { labels: closed.map(t => t.date.split('T')[0]), datasets: [{ data: pts, borderColor: '#bb86fc', tension: 0.2 }] }, options: { plugins: { legend: { display: false } } } });

        document.getElementById('open-list').innerHTML = trades.filter(t => t.status === 'Aktiv').map(t => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <span><b>${t.asset}</b></span>
                <button onclick="edit('${t.id}')" style="background:var(--acc); border:none; padding:5px 10px; border-radius:4px;">Edit</button>
            </div>
        `).join('');

        document.getElementById('hist-body').innerHTML = trades.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
            <tr>
                <td>${t.date.split('T')[0]}</td>
                <td>${t.asset}</td>
                <td style="color:${t.pnl < 0 ? '#cf6679' : '#03dac6'}">${t.pnl.toFixed(2)}‚Ç¨</td>
                <td><button onclick="edit('${t.id}')">‚úèÔ∏è</button></td>
            </tr>
        `).join('');
    }

    async function save() {
        const id = document.getElementById('tid').value;
        const data = {
            asset: document.getElementById('asset').value.toUpperCase(),
            status: document.getElementById('status').value,
            pnl: parseFloat(document.getElementById('pnl').value) || 0,
            date: document.getElementById('date').value,
            note: document.getElementById('note').value,
            userId: auth.currentUser.uid
        };
        id ? await db.collection('trades').doc(id).update(data) : await db.collection('trades').add(data);
        show('dash'); load();
    }

    function edit(id) {
        const t = trades.find(x => x.id === id);
        document.getElementById('tid').value = t.id;
        document.getElementById('asset').value = t.asset;
        document.getElementById('status').value = t.status;
        document.getElementById('pnl').value = t.pnl;
        document.getElementById('date').value = t.date;
        document.getElementById('note').value = t.note;
        document.getElementById('pnl-box').classList.toggle('hidden', t.status === 'Aktiv');
        show('add');
    }

    function show(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-' + id).classList.remove('hidden');
    }

    function prepAdd() {
        document.getElementById('tid').value = "";
        document.getElementById('date').value = new Date().toISOString().slice(0,16);
        show('add');
    }

    function calc() {
        const b = document.getElementById('cBal').value, r = document.getElementById('cRisk').value, s = document.getElementById('cSl').value;
        document.getElementById('cRes').innerText = ((b * (r/100)) / s).toFixed(2) + " Lots";
    }

    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
